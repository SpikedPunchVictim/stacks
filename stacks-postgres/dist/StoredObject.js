"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.StoredObject = void 0;
const StacksPostgresError_1 = require("./StacksPostgresError");
class StoredObject {
    constructor(model, obj, context) {
        this.model = model;
        this.obj = obj;
        this.context = context;
    }
    static async fromId(model, id, context) {
        let info = context.getTable(model);
        if (info === undefined) {
            throw new StacksPostgresError_1.StacksPostgresError(`Failed to find the Table for Model ${model.name}. Ensure the Postgres Plugin has been properly initialized.`);
        }
        try {
            let result = await context.db.selectFrom(info.tableName)
                .selectAll(info.tableName)
                .where('id', '=', id)
                .execute();
            if (result.length === 0) {
                return undefined;
            }
            console.log(":: From DB");
            console.dir(result[0], { depth: null });
            console.log(":: Transformed");
            console.dir(context.fromDbObj(model.name, result[0]), { depth: null });
            return result.length === 0 ? undefined : new StoredObject(model, result[0], context);
        }
        catch (err) {
            throw err;
        }
    }
    static async getOrCreate(model, obj, context) {
        let found = await StoredObject.fromId(model, obj.id, context);
        if (found) {
            return found;
        }
        return StoredObject.create(model, obj, context);
    }
    static create(model, obj, context) {
        let dbObj = context.toDbObj(model.name, obj);
        return new StoredObject(model, dbObj, context);
    }
    static async delete(model, id, context) {
        let info = context.getTable(model);
        if (info === undefined) {
            throw new StacksPostgresError_1.StacksPostgresError(`Could not match Model with a Table when saving Object ${id}`);
        }
        try {
            await context.db
                .deleteFrom(info.tableName)
                .where('id', '=', id)
                .execute();
        }
        catch (err) {
            console.error(`[stacks-postgres] Failed to delete an Object from Postgres. Model ${model.name}, Object ID ${id}. Reason: ${err}`);
            throw err;
        }
    }
    static async update(model, obj, context) {
        let table = context.getTable(model);
        if (table === undefined) {
            throw new StacksPostgresError_1.StacksPostgresError(`Failed to find the Table for Model ${model.name}. Ensure the Postgres Plugin has been properly initialized.`);
        }
        await context.db.updateTable(table.tableName)
            .where('id', '=', obj.id)
            .set(obj)
            .execute();
    }
    async save() {
        let table = this.context.getTable(this.model);
        if (table == undefined) {
            throw new StacksPostgresError_1.StacksPostgresError(`Could not match Model with a Table when saving Object ${this.obj.id}`);
        }
        // Store any seperate Object Refs in their own table; nested.
        let refColumns = table.columns.filter(col => col.reference != null);
        let savedObj = {};
        for (let refColumn of refColumns) {
            if (this.obj[refColumn.columnName] == null) {
                continue;
            }
            if (refColumn.reference == null) {
                throw new StacksPostgresError_1.StacksPostgresError(`Failed to Save the Object. No reference has been recorded for a Model Property. On Model ${this.model.name}, Member ${refColumn.member.name}`);
            }
            let refTableInfo = this.context.getTable(refColumn.reference.model);
            if (refTableInfo === undefined) {
                throw new StacksPostgresError_1.StacksPostgresError(`Failed to find the reference information for a column in Model ${refColumn.reference.model}`);
            }
            let storedObj = StoredObject.create(refColumn.reference.model, this.context.toDbObj(refTableInfo.model.name, this.obj[refColumn.columnName]), this.context);
            await storedObj.save();
            savedObj[refColumn.columnName] = this.obj[refColumn.columnName].id;
        }
        for (let colName of Object.keys(this.obj)) {
            savedObj[colName] = this.obj[colName];
        }
        savedObj['id'] = this.obj.id;
        let result = await this.context.db
            .insertInto(table.tableName)
            .values(savedObj)
            .execute();
        console.dir(result, { depth: null });
        return;
    }
    async delete() {
        await StoredObject.delete(this.model, this.obj.id, this.context);
    }
}
exports.StoredObject = StoredObject;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RvcmVkT2JqZWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1N0b3JlZE9iamVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSwrREFBMkQ7QUFHM0QsTUFBYSxZQUFZO0lBQ3RCLFlBQTZCLEtBQWEsRUFBVyxHQUFnQixFQUFXLE9BQXNCO1FBQXpFLFVBQUssR0FBTCxLQUFLLENBQVE7UUFBVyxRQUFHLEdBQUgsR0FBRyxDQUFhO1FBQVcsWUFBTyxHQUFQLE9BQU8sQ0FBZTtJQUV0RyxDQUFDO0lBRUQsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBYSxFQUFFLEVBQVUsRUFBRSxPQUFzQjtRQUNsRSxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBRWxDLElBQUksSUFBSSxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQ3RCLE1BQU0sSUFBSSx5Q0FBbUIsQ0FBQyxzQ0FBc0MsS0FBSyxDQUFDLElBQUksNkRBQTZELENBQUMsQ0FBQTtRQUMvSSxDQUFDO1FBRUQsSUFBSSxDQUFDO1lBQ0YsSUFBSSxNQUFNLEdBQUcsTUFBTSxPQUFPLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO2lCQUNwRCxTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztpQkFDekIsS0FBSyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDO2lCQUNwQixPQUFPLEVBQUUsQ0FBQTtZQUViLElBQUcsTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDdEIsT0FBTyxTQUFTLENBQUE7WUFDbkIsQ0FBQztZQUVELE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUE7WUFDekIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FB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cElELG9DQW9JQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElNb2RlbCwgU3RhY2tPYmplY3QgfSBmcm9tIFwiQHNwaWtlZHB1bmNoL3N0YWNrc1wiXG5pbXBvcnQgeyBQbHVnaW5Db250ZXh0IH0gZnJvbSBcIi4vUGx1Z2luQ29udGV4dFwiXG5pbXBvcnQgeyBTdGFja3NQb3N0Z3Jlc0Vycm9yIH0gZnJvbSBcIi4vU3RhY2tzUG9zdGdyZXNFcnJvclwiXG5cblxuZXhwb3J0IGNsYXNzIFN0b3JlZE9iamVjdCB7XG4gICBwcml2YXRlIGNvbnN0cnVjdG9yKHJlYWRvbmx5IG1vZGVsOiBJTW9kZWwsIHJlYWRvbmx5IG9iajogU3RhY2tPYmplY3QsIHJlYWRvbmx5IGNvbnRleHQ6IFBsdWdpbkNvbnRleHQpIHtcblxuICAgfVxuXG4gICBzdGF0aWMgYXN5bmMgZnJvbUlkKG1vZGVsOiBJTW9kZWwsIGlkOiBzdHJpbmcsIGNvbnRleHQ6IFBsdWdpbkNvbnRleHQpOiBQcm9taXNlPFN0b3JlZE9iamVjdCB8IHVuZGVmaW5lZD4ge1xuICAgICAgbGV0IGluZm8gPSBjb250ZXh0LmdldFRhYmxlKG1vZGVsKVxuXG4gICAgICBpZiAoaW5mbyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICB0aHJvdyBuZXcgU3RhY2tzUG9zdGdyZXNFcnJvcihgRmFpbGVkIHRvIGZpbmQgdGhlIFRhYmxlIGZvciBNb2RlbCAke21vZGVsLm5hbWV9LiBFbnN1cmUgdGhlIFBvc3RncmVzIFBsdWdpbiBoYXMgYmVlbiBwcm9wZXJseSBpbml0aWFsaXplZC5gKVxuICAgICAgfVxuXG4gICAgICB0cnkge1xuICAgICAgICAgbGV0IHJlc3VsdCA9IGF3YWl0IGNvbnRleHQuZGIuc2VsZWN0RnJvbShpbmZvLnRhYmxlTmFtZSlcbiAgICAgICAgICAgIC5zZWxlY3RBbGwoaW5mby50YWJsZU5hbWUpXG4gICAgICAgICAgICAud2hlcmUoJ2lkJywgJz0nLCBpZClcbiAgICAgICAgICAgIC5leGVjdXRlKClcblxuICAgICAgICAgaWYocmVzdWx0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgICAgICAgfVxuXG4gICAgICAgICBjb25zb2xlLmxvZyhcIjo6IEZyb20gREJcIilcbiAgICAgICAgIGNvbnNvbGUuZGlyKHJlc3VsdFswXSwgeyBkZXB0aDogbnVsbCB9KVxuXG4gICAgICAgICBjb25zb2xlLmxvZyhcIjo6IFRyYW5zZm9ybWVkXCIpXG4gICAgICAgICBjb25zb2xlLmRpcihjb250ZXh0LmZyb21EYk9iaihtb2RlbC5uYW1lLCByZXN1bHRbMF0gYXMgYW55KSwgeyBkZXB0aDogbnVsbCB9KVxuICAgICAgICAgXG4gICAgICAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA9PT0gMCA/IHVuZGVmaW5lZCA6IG5ldyBTdG9yZWRPYmplY3QobW9kZWwsIHJlc3VsdFswXSBhcyBTdGFja09iamVjdCwgY29udGV4dClcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgdGhyb3cgZXJyXG4gICAgICB9XG4gICB9XG5cbiAgIHN0YXRpYyBhc3luYyBnZXRPckNyZWF0ZShtb2RlbDogSU1vZGVsLCBvYmo6IFN0YWNrT2JqZWN0LCBjb250ZXh0OiBQbHVnaW5Db250ZXh0KTogUHJvbWlzZTxTdG9yZWRPYmplY3Q+IHtcbiAgICAgIGxldCBmb3VuZCA9IGF3YWl0IFN0b3JlZE9iamVjdC5mcm9tSWQobW9kZWwsIG9iai5pZCwgY29udGV4dClcblxuICAgICAgaWYoZm91bmQpIHtcbiAgICAgICAgIHJldHVybiBmb3VuZFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gU3RvcmVkT2JqZWN0LmNyZWF0ZShtb2RlbCwgb2JqLCBjb250ZXh0KVxuICAgfVxuXG4gICBzdGF0aWMgY3JlYXRlKG1vZGVsOiBJTW9kZWwsIG9iajogU3RhY2tPYmplY3QsIGNvbnRleHQ6IFBsdWdpbkNvbnRleHQpOiBTdG9yZWRPYmplY3Qge1xuICAgICAgbGV0IGRiT2JqID0gY29udGV4dC50b0RiT2JqKG1vZGVsLm5hbWUsIG9iailcbiAgICAgIHJldHVybiBuZXcgU3RvcmVkT2JqZWN0KG1vZGVsLCBkYk9iaiwgY29udGV4dClcbiAgIH1cblxuICAgc3RhdGljIGFzeW5jIGRlbGV0ZShtb2RlbDogSU1vZGVsLCBpZDogc3RyaW5nLCBjb250ZXh0OiBQbHVnaW5Db250ZXh0KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICBsZXQgaW5mbyA9IGNvbnRleHQuZ2V0VGFibGUobW9kZWwpXG5cbiAgICAgIGlmIChpbmZvID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgIHRocm93IG5ldyBTdGFja3NQb3N0Z3Jlc0Vycm9yKGBDb3VsZCBub3QgbWF0Y2ggTW9kZWwgd2l0aCBhIFRhYmxlIHdoZW4gc2F2aW5nIE9iamVjdCAke2lkfWApXG4gICAgICB9XG5cbiAgICAgIHRyeSB7XG4gICAgICAgICBhd2FpdCBjb250ZXh0LmRiXG4gICAgICAgICAgICAuZGVsZXRlRnJvbShpbmZvLnRhYmxlTmFtZSlcbiAgICAgICAgICAgIC53aGVyZSgnaWQnLCAnPScsIGlkKVxuICAgICAgICAgICAgLmV4ZWN1dGUoKVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICBjb25zb2xlLmVycm9yKGBbc3RhY2tzLXBvc3RncmVzXSBGYWlsZWQgdG8gZGVsZXRlIGFuIE9iamVjdCBmcm9tIFBvc3RncmVzLiBNb2RlbCAke21vZGVsLm5hbWV9LCBPYmplY3QgSUQgJHtpZH0uIFJlYXNvbjogJHtlcnJ9YClcbiAgICAgICAgIHRocm93IGVyclxuICAgICAgfVxuICAgfVxuXG4gICBzdGF0aWMgYXN5bmMgdXBkYXRlKG1vZGVsOiBJTW9kZWwsIG9iajogU3RhY2tPYmplY3QsIGNvbnRleHQ6IFBsdWdpbkNvbnRleHQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIGxldCB0YWJsZSA9IGNvbnRleHQuZ2V0VGFibGUobW9kZWwpXG5cbiAgICAgIGlmICh0YWJsZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICB0aHJvdyBuZXcgU3RhY2tzUG9zdGdyZXNFcnJvcihgRmFpbGVkIHRvIGZpbmQgdGhlIFRhYmxlIGZvciBNb2RlbCAke21vZGVsLm5hbWV9LiBFbnN1cmUgdGhlIFBvc3RncmVzIFBsdWdpbiBoYXMgYmVlbiBwcm9wZXJseSBpbml0aWFsaXplZC5gKVxuICAgICAgfVxuXG4gICAgICBhd2FpdCBjb250ZXh0LmRiLnVwZGF0ZVRhYmxlKHRhYmxlLnRhYmxlTmFtZSlcbiAgICAgICAgIC53aGVyZSgnaWQnLCAnPScsIG9iai5pZClcbiAgICAgICAgIC5zZXQob2JqKVxuICAgICAgICAgLmV4ZWN1dGUoKVxuICAgfVxuXG4gICBhc3luYyBzYXZlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgbGV0IHRhYmxlID0gdGhpcy5jb250ZXh0LmdldFRhYmxlKHRoaXMubW9kZWwpXG5cbiAgICAgIGlmICh0YWJsZSA9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgIHRocm93IG5ldyBTdGFja3NQb3N0Z3Jlc0Vycm9yKGBDb3VsZCBub3QgbWF0Y2ggTW9kZWwgd2l0aCBhIFRhYmxlIHdoZW4gc2F2aW5nIE9iamVjdCAke3RoaXMub2JqLmlkfWApXG4gICAgICB9XG5cbiAgICAgIC8vIFN0b3JlIGFueSBzZXBlcmF0ZSBPYmplY3QgUmVmcyBpbiB0aGVpciBvd24gdGFibGU7IG5lc3RlZC5cbiAgICAgIGxldCByZWZDb2x1bW5zID0gdGFibGUuY29sdW1ucy5maWx0ZXIoY29sID0+IGNvbC5yZWZlcmVuY2UgIT0gbnVsbClcblxuICAgICAgbGV0IHNhdmVkT2JqID0ge31cblxuICAgICAgZm9yIChsZXQgcmVmQ29sdW1uIG9mIHJlZkNvbHVtbnMpIHtcbiAgICAgICAgIGlmICh0aGlzLm9ialtyZWZDb2x1bW4uY29sdW1uTmFtZV0gPT0gbnVsbCkge1xuICAgICAgICAgICAgY29udGludWVcbiAgICAgICAgIH1cblxuICAgICAgICAgaWYgKHJlZkNvbHVtbi5yZWZlcmVuY2UgPT0gbnVsbCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFN0YWNrc1Bvc3RncmVzRXJyb3IoYEZhaWxlZCB0byBTYXZlIHRoZSBPYmplY3QuIE5vIHJlZmVyZW5jZSBoYXMgYmVlbiByZWNvcmRlZCBmb3IgYSBNb2RlbCBQcm9wZXJ0eS4gT24gTW9kZWwgJHt0aGlzLm1vZGVsLm5hbWV9LCBNZW1iZXIgJHtyZWZDb2x1bW4ubWVtYmVyLm5hbWV9YClcbiAgICAgICAgIH1cblxuICAgICAgICAgbGV0IHJlZlRhYmxlSW5mbyA9IHRoaXMuY29udGV4dC5nZXRUYWJsZShyZWZDb2x1bW4ucmVmZXJlbmNlLm1vZGVsKVxuXG4gICAgICAgICBpZihyZWZUYWJsZUluZm8gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFN0YWNrc1Bvc3RncmVzRXJyb3IoYEZhaWxlZCB0byBmaW5kIHRoZSByZWZlcmVuY2UgaW5mb3JtYXRpb24gZm9yIGEgY29sdW1uIGluIE1vZGVsICR7cmVmQ29sdW1uLnJlZmVyZW5jZS5tb2RlbH1gKVxuICAgICAgICAgfVxuXG4gICAgICAgICBsZXQgc3RvcmVkT2JqID0gU3RvcmVkT2JqZWN0LmNyZWF0ZShyZWZDb2x1bW4ucmVmZXJlbmNlLm1vZGVsLCB0aGlzLmNvbnRleHQudG9EYk9iaihyZWZUYWJsZUluZm8ubW9kZWwubmFtZSwgdGhpcy5vYmpbcmVmQ29sdW1uLmNvbHVtbk5hbWVdKSwgdGhpcy5jb250ZXh0KVxuICAgICAgICAgYXdhaXQgc3RvcmVkT2JqLnNhdmUoKVxuXG4gICAgICAgICBzYXZlZE9ialtyZWZDb2x1bW4uY29sdW1uTmFtZV0gPSB0aGlzLm9ialtyZWZDb2x1bW4uY29sdW1uTmFtZV0uaWRcbiAgICAgIH1cblxuICAgICAgZm9yIChsZXQgY29sTmFtZSBvZiBPYmplY3Qua2V5cyh0aGlzLm9iaikpIHtcbiAgICAgICAgIHNhdmVkT2JqW2NvbE5hbWVdPSB0aGlzLm9ialtjb2xOYW1lXVxuICAgICAgfVxuXG4gICAgICBzYXZlZE9ialsnaWQnXSA9IHRoaXMub2JqLmlkXG5cbiAgICAgIGxldCByZXN1bHQgPSBhd2FpdCB0aGlzLmNvbnRleHQuZGJcbiAgICAgICAgIC5pbnNlcnRJbnRvKHRhYmxlLnRhYmxlTmFtZSlcbiAgICAgICAgIC52YWx1ZXMoc2F2ZWRPYmopXG4gICAgICAgICAuZXhlY3V0ZSgpXG5cbiAgICAgIGNvbnNvbGUuZGlyKHJlc3VsdCwgeyBkZXB0aDogbnVsbCB9KVxuXG4gICAgICByZXR1cm5cbiAgIH1cblxuICAgYXN5bmMgZGVsZXRlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgYXdhaXQgU3RvcmVkT2JqZWN0LmRlbGV0ZSh0aGlzLm1vZGVsLCB0aGlzLm9iai5pZCwgdGhpcy5jb250ZXh0KVxuICAgfVxufVxuIl19