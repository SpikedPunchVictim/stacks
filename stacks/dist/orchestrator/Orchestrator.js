"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Orchestrator = void 0;
const events_1 = require("../events");
const SaveObjectEvent_1 = require("../events/SaveObjectEvent");
const DeleteObjectEvent_1 = require("../events/DeleteObjectEvent");
const Event_1 = require("../events/Event");
const GetManyObjectsEvent_1 = require("../events/GetManyObjectsEvent");
const HasIdEvent_1 = require("../events/HasIdEvent");
const UpdateObjectEvent_1 = require("../events/UpdateObjectEvent");
const ProxyObject_1 = require("../ProxyObject");
const UidKeeper_1 = require("../UidKeeper");
class Orchestrator {
    constructor(context) {
        this.context = context;
    }
    get cache() {
        return this.context.cache;
    }
    get rfc() {
        return this.context.rfc;
    }
    get serializer() {
        return this.context.serializer;
    }
    get stack() {
        return this.context.stack;
    }
    get uid() {
        return this.context.uid;
    }
    /**
     *
     * @param model The Model
     * @param obj The Object to save. Note that this is really a Proxy'd SerializableObject
     */
    async saveObject(model, obj) {
        let validations = await model.validate(obj);
        if (!validations.success) {
            throw new Error(`Cannot Save Object with ID ${obj.id} since it fails validation. Reason: ${validations.results.map(r => r.error)}`);
        }
        if (obj.id === UidKeeper_1.UidKeeper.IdNotSet) {
            obj.id = await this.uid.generate();
        }
        //@ts-ignore
        let serialized = ProxyObject_1.ProxyObject.unwrap(obj);
        await this.rfc.create(new SaveObjectEvent_1.SaveObjectEvent(model, obj, serialized))
            .fulfill(async (event) => {
            this.cache.saveObject(model, obj);
            await this.stack.emit(Event_1.EventSet.CommitObject, event);
        })
            .commit();
    }
    async getManyObjects(model, options = {}) {
        let results = {
            cursor: '',
            items: new Array()
        };
        await this.rfc.create(new GetManyObjectsEvent_1.GetManyObjectsEvent(model, options))
            .fulfill(async (event) => {
            let cast = event;
            if (cast.results !== undefined) {
                results = cast.results;
                return;
            }
            let objects = this.cache.getObjects(model);
            if (objects.length == 0) {
                return;
            }
            let cursor = options.cursor || '';
            let limit = options.limit || 100;
            // Sort by ID. The resulting paged set is not perfect, and will have
            // holes when new entries are added in between queries.
            objects.sort((a, b) => {
                let aId = a.id.toLowerCase();
                let bId = b.id.toLowerCase();
                return (aId < bId) ? -1 : (aId > bId) ? 1 : 0;
            });
            if (cursor === '') {
                // For an empty cursor we start from the beginning
                let items = objects.slice(0, Math.min(objects.length - 1, limit));
                if (items.length == limit && objects.length > limit) {
                    results.cursor = Buffer.from(objects[limit + 1].id).toString('base64');
                }
                else {
                    // If there are no more entries in thenext set, we default the cursor
                    // to empty string
                    results.cursor = '';
                }
                results.items = items;
                return;
            }
            else {
                // We have a cursor and continue from whence we left off
                cursor = Buffer.from(cursor, 'base64').toString('ascii');
                let index = objects.findIndex(o => o.id === cursor);
                if (index === -1) {
                    // We get here when the object that's next has been deleted
                    // return early
                    return;
                }
                results.items = objects.slice(index, Math.min(objects.length - 1, limit));
                if (results.items.length == limit && objects.length > limit) {
                    results.cursor = Buffer.from(objects[limit + 1].id).toString('base64');
                }
                else {
                    // If there are no more entries in thenext set, we default the cursor
                    // to empty string
                    results.cursor = '';
                }
                return;
            }
            return;
        })
            .commit();
        return results;
    }
    async deleteObject(model, obj) {
        await this.rfc.create(new DeleteObjectEvent_1.DeleteObjectEvent(model, obj))
            .fulfill(async (event) => {
            this.cache.deleteObject(model, obj);
            await this.stack.emit(Event_1.EventSet.ObjectDeleted, event);
        })
            .commit();
    }
    async getObject(model, id) {
        let object;
        await this.rfc.create(new events_1.GetObjectEvent(model, id))
            .fulfill(async (event) => {
            let cast = event;
            if (cast.object === undefined) {
                object = cast.exists === Event_1.ExistState.DoesNotExist ?
                    undefined :
                    this.cache.getObject(model, id);
            }
            else {
                // We get a serialized version of the Object
                let serialized = await ProxyObject_1.ProxyObject.fromStored(model, cast.object, this.context.serializer);
                this.cache.saveObject(model, serialized);
                //@ts-ignore
                object = serialized;
            }
            await this.stack.emit(Event_1.EventSet.GetObject, event);
        })
            .commit();
        return object;
    }
    async hasId(id) {
        let hasId = false;
        await this.rfc.create(new HasIdEvent_1.HasIdEvent(id))
            .fulfill(async (event) => {
            let cast = event;
            if (cast.hasId) {
                hasId = true;
                return;
            }
            // Has it a plugin attempted to set it?
            if (cast.attemptedSet) {
                // If so, we can trust that an external system doesn't have it
                hasId = false;
                return;
            }
            // If no external system attempted to set it, do we have it cached?
            hasId = this.cache.hasId(id);
        })
            .commit();
        return hasId;
    }
    async updateObject(model, obj, onUpdate) {
        await this.rfc.create(new UpdateObjectEvent_1.UpdateObjectEvent(model, obj))
            .fulfill(async (event) => {
            let cast = event;
            let updated = cast.updated;
            await onUpdate(updated, cast.exists);
            await this.stack.emit(Event_1.EventSet.ObjectUpdated, cast);
        })
            .commit();
    }
}
exports.Orchestrator = Orchestrator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT3JjaGVzdHJhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL29yY2hlc3RyYXRvci9PcmNoZXN0cmF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBRUEsc0NBQTJDO0FBQzNDLCtEQUE0RDtBQUM1RCxtRUFBZ0U7QUFDaEUsMkNBQXVEO0FBQ3ZELHVFQUFvRTtBQUNwRSxxREFBa0Q7QUFFbEQsbUVBQWdFO0FBS2hFLGdEQUE2QztBQUM3Qyw0Q0FBcUQ7QUE2QnJELE1BQWEsWUFBWTtJQXFCdEIsWUFBcUIsT0FBc0I7UUFBdEIsWUFBTyxHQUFQLE9BQU8sQ0FBZTtJQUUzQyxDQUFDO0lBdEJELElBQUksS0FBSztRQUNOLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUE7SUFDNUIsQ0FBQztJQUVELElBQUksR0FBRztRQUNKLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUE7SUFDMUIsQ0FBQztJQUVELElBQUksVUFBVTtRQUNYLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUE7SUFDakMsQ0FBQztJQUVELElBQUksS0FBSztRQUNOLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUE7SUFDNUIsQ0FBQztJQUVELElBQUksR0FBRztRQUNKLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUE7SUFDMUIsQ0FBQztJQU1EOzs7O09BSUc7SUFDSCxLQUFLLENBQUMsVUFBVSxDQUF3QixLQUFhLEVBQUUsR0FBTTtRQUMxRCxJQUFJLFdBQVcsR0FBRyxNQUFNLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUE7UUFFM0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUU7WUFDdkIsTUFBTSxJQUFJLEtBQUssQ0FBQyw4QkFBOEIsR0FBRyxDQUFDLEVBQUUsdUNBQXVDLFdBQVcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxF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QUUsR0FBTSxFQUFFLFFBQWdDO1FBQzlGLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxxQ0FBaUIsQ0FBSSxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7YUFDdkQsT0FBTyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRTtZQUN0QixJQUFJLElBQUksR0FBRyxLQUE2QixDQUFBO1lBRXhDLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUE7WUFFMUIsTUFBTSxRQUFRLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUVwQyxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLGdCQUFRLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFBO1FBQ3RELENBQUMsQ0FBQzthQUNELE1BQU0sRUFBRSxDQUFBO0lBQ2YsQ0FBQztDQUNIO0FBL01ELG9DQStNQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN0YWNrT2JqZWN0IH0gZnJvbSBcIi4uL1N0YWNrT2JqZWN0XCI7XG5pbXBvcnQgeyBJQ2FjaGUgfSBmcm9tIFwiLi4vQ2FjaGVcIjtcbmltcG9ydCB7IEdldE9iamVjdEV2ZW50IH0gZnJvbSBcIi4uL2V2ZW50c1wiO1xuaW1wb3J0IHsgU2F2ZU9iamVjdEV2ZW50IH0gZnJvbSBcIi4uL2V2ZW50cy9TYXZlT2JqZWN0RXZlbnRcIjtcbmltcG9ydCB7IERlbGV0ZU9iamVjdEV2ZW50IH0gZnJvbSBcIi4uL2V2ZW50cy9EZWxldGVPYmplY3RFdmVudFwiO1xuaW1wb3J0IHsgRXZlbnRTZXQsIEV4aXN0U3RhdGUgfSBmcm9tIFwiLi4vZXZlbnRzL0V2ZW50XCI7XG5pbXBvcnQgeyBHZXRNYW55T2JqZWN0c0V2ZW50IH0gZnJvbSBcIi4uL2V2ZW50cy9HZXRNYW55T2JqZWN0c0V2ZW50XCI7XG5pbXBvcnQgeyBIYXNJZEV2ZW50IH0gZnJvbSBcIi4uL2V2ZW50cy9IYXNJZEV2ZW50XCI7XG5pbXBvcnQgeyBJUmVxdWVzdEZvckNoYW5nZVNvdXJjZSB9IGZyb20gXCIuLi9ldmVudHMvUmVxdWVzdEZvckNoYW5nZVwiO1xuaW1wb3J0IHsgVXBkYXRlT2JqZWN0RXZlbnQgfSBmcm9tIFwiLi4vZXZlbnRzL1VwZGF0ZU9iamVjdEV2ZW50XCI7XG5pbXBvcnQgeyBJTW9kZWwsIFBhZ2VSZXF1ZXN0LCBQYWdlUmVzcG9uc2UgfSBmcm9tIFwiLi4vTW9kZWxcIjtcbmltcG9ydCB7IElTdGFjayB9IGZyb20gXCIuLi9zdGFjay9TdGFja1wiO1xuaW1wb3J0IHsgSVN0YWNrQ29udGV4dCB9IGZyb20gXCIuLi9zdGFjay9TdGFja0NvbnRleHRcIjtcbmltcG9ydCB7IFVwZGF0ZU9iamVjdEhhbmRsZXIgfSBmcm9tIFwiLi4vc3RhY2svU3RhY2tVcGRhdGVcIjtcbmltcG9ydCB7IFByb3h5T2JqZWN0IH0gZnJvbSBcIi4uL1Byb3h5T2JqZWN0XCI7XG5pbXBvcnQgeyBJVWlkS2VlcGVyLCBVaWRLZWVwZXIgfSBmcm9tIFwiLi4vVWlkS2VlcGVyXCI7XG5pbXBvcnQgeyBJVmFsdWVTZXJpYWxpemVyIH0gZnJvbSBcIi4uL3NlcmlhbGl6ZS9WYWx1ZVNlcmlhbGl6ZXJcIjtcblxuZXhwb3J0IGludGVyZmFjZSBJT3JjaGVzdHJhdG9yIHtcbiAgIC8vIFRPRE86IEFkZDogY3JlYXRlTW9kZWwsIGRlbGV0ZU1vZGVsICh0aGVzZSBzaG91bGQgYXNzaXN0IGluIHJ1bm5pbmcgdGVzdHMpXG5cbiAgIHNhdmVPYmplY3Q8VCBleHRlbmRzIFN0YWNrT2JqZWN0Pihtb2RlbDogSU1vZGVsLCBvYmo6IFQpOiBQcm9taXNlPHZvaWQ+XG4gICBkZWxldGVPYmplY3Q8VCBleHRlbmRzIFN0YWNrT2JqZWN0Pihtb2RlbDogSU1vZGVsLCBvYmo6IFQpOiBQcm9taXNlPHZvaWQ+XG5cbiAgIC8qKlxuICAgICogUmV0cmlldmVzIG1hbnkgb2JqZWN0cyBpbiBhIHBhZ2VkIGZhc2hpb24uXG4gICAgKiBcbiAgICAqIEBwYXJhbSBtb2RlbCBUaGUgTW9kZWwgcmVwcmVzZW50aW5nIHRoZSBPYmplY3RzXG4gICAgKiBAcGFyYW0gb3B0aW9ucyBQYWdlUmVxdWVzdCBPcHRpb25zXG4gICAgKi9cbiAgIGdldE1hbnlPYmplY3RzPFQgZXh0ZW5kcyBTdGFja09iamVjdD4obW9kZWw6IElNb2RlbCwgb3B0aW9uczogUGFnZVJlcXVlc3QpOiBQcm9taXNlPFBhZ2VSZXNwb25zZTxUPj5cbiAgIFxuICAgLyoqXG4gICAgKiBSZXRyaWV2ZXMgdGhlIEVkaXQgdmVyc2lvbiBvZiB0aGUgT2JqZWN0XG4gICAgKiBcbiAgICAqIEBwYXJhbSBtb2RlbCBUaGUgTW9kZWwgb2YgdGhlIE9iamVjdFxuICAgICogQHBhcmFtIGlkIFRoZSBPYmplY3QncyBJRFxuICAgICovXG4gICBnZXRPYmplY3Q8VCBleHRlbmRzIFN0YWNrT2JqZWN0Pihtb2RlbDogSU1vZGVsLCBpZDogc3RyaW5nKTogUHJvbWlzZTxUIHwgdW5kZWZpbmVkPlxuICAgaGFzSWQoaWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj5cbiAgIHVwZGF0ZU9iamVjdDxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG1vZGVsOiBJTW9kZWwsIG9iajogVCwgb25VcGRhdGU6IFVwZGF0ZU9iamVjdEhhbmRsZXI8VD4pOiBQcm9taXNlPHZvaWQ+XG59XG5cblxuZXhwb3J0IGNsYXNzIE9yY2hlc3RyYXRvciBpbXBsZW1lbnRzIElPcmNoZXN0cmF0b3Ige1xuICAgZ2V0IGNhY2hlKCk6IElDYWNoZSB7XG4gICAgICByZXR1cm4gdGhpcy5jb250ZXh0LmNhY2hlXG4gICB9XG5cbiAgIGdldCByZmMoKTogSVJlcXVlc3RGb3JDaGFuZ2VTb3VyY2Uge1xuICAgICAgcmV0dXJuIHRoaXMuY29udGV4dC5yZmNcbiAgIH1cblxuICAgZ2V0IHNlcmlhbGl6ZXIoKTogSVZhbHVlU2VyaWFsaXplciB7XG4gICAgICByZXR1cm4gdGhpcy5jb250ZXh0LnNlcmlhbGl6ZXJcbiAgIH1cblxuICAgZ2V0IHN0YWNrKCk6IElTdGFjayB7XG4gICAgICByZXR1cm4gdGhpcy5jb250ZXh0LnN0YWNrXG4gICB9XG5cbiAgIGdldCB1aWQoKTogSVVpZEtlZXBlciB7XG4gICAgICByZXR1cm4gdGhpcy5jb250ZXh0LnVpZFxuICAgfVxuXG4gICBjb25zdHJ1Y3RvcihyZWFkb25seSBjb250ZXh0OiBJU3RhY2tDb250ZXh0KSB7XG5cbiAgIH1cblxuICAgLyoqXG4gICAgKiBcbiAgICAqIEBwYXJhbSBtb2RlbCBUaGUgTW9kZWxcbiAgICAqIEBwYXJhbSBvYmogVGhlIE9iamVjdCB0byBzYXZlLiBOb3RlIHRoYXQgdGhpcyBpcyByZWFsbHkgYSBQcm94eSdkIFNlcmlhbGl6YWJsZU9iamVjdFxuICAgICovXG4gICBhc3luYyBzYXZlT2JqZWN0PFQgZXh0ZW5kcyBTdGFja09iamVjdD4obW9kZWw6IElNb2RlbCwgb2JqOiBUKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICBsZXQgdmFsaWRhdGlvbnMgPSBhd2FpdCBtb2RlbC52YWxpZGF0ZShvYmopXG5cbiAgICAgIGlmICghdmFsaWRhdGlvbnMuc3VjY2Vzcykge1xuICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgU2F2ZSBPYmplY3Qgd2l0aCBJRCAke29iai5pZH0gc2luY2UgaXQgZmFpbHMgdmFsaWRhdGlvbi4gUmVhc29uOiAke3ZhbGlkYXRpb25zLnJlc3VsdHMubWFwKHIgPT4gci5lcnJvcil9YClcbiAgICAgIH1cblxuICAgICAgaWYob2JqLmlkID09PSBVaWRLZWVwZXIuSWROb3RTZXQpIHtcbiAgICAgICAgIG9iai5pZCA9IGF3YWl0IHRoaXMudWlkLmdlbmVyYXRlKClcbiAgICAgIH1cblxuICAgICAgLy9AdHMtaWdub3JlXG4gICAgICBsZXQgc2VyaWFsaXplZCA9IFByb3h5T2JqZWN0LnVud3JhcChvYmopXG5cbiAgICAgIGF3YWl0IHRoaXMucmZjLmNyZWF0ZShuZXcgU2F2ZU9iamVjdEV2ZW50PFQ+KG1vZGVsLCBvYmosIHNlcmlhbGl6ZWQpKVxuICAgICAgICAgLmZ1bGZpbGwoYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlLnNhdmVPYmplY3QobW9kZWwsIG9iailcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc3RhY2suZW1pdChFdmVudFNldC5Db21taXRPYmplY3QsIGV2ZW50KVxuICAgICAgICAgfSlcbiAgICAgICAgIC5jb21taXQoKVxuICAgfVxuXG4gICBhc3luYyBnZXRNYW55T2JqZWN0czxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG1vZGVsOiBJTW9kZWwsIG9wdGlvbnM6IFBhZ2VSZXF1ZXN0ID0ge30pOiBQcm9taXNlPFBhZ2VSZXNwb25zZTxUPj4ge1xuICAgICAgbGV0IHJlc3VsdHMgPSB7XG4gICAgICAgICBjdXJzb3I6ICcnLFxuICAgICAgICAgaXRlbXM6IG5ldyBBcnJheTxUPigpXG4gICAgICB9XG5cbiAgICAgIGF3YWl0IHRoaXMucmZjLmNyZWF0ZShuZXcgR2V0TWFueU9iamVjdHNFdmVudChtb2RlbCwgb3B0aW9ucykpXG4gICAgICAgICAuZnVsZmlsbChhc3luYyAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgIGxldCBjYXN0ID0gZXZlbnQgYXMgR2V0TWFueU9iamVjdHNFdmVudDxUPlxuXG4gICAgICAgICAgICBpZiAoY2FzdC5yZXN1bHRzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgIHJlc3VsdHMgPSBjYXN0LnJlc3VsdHNcbiAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgb2JqZWN0cyA9IHRoaXMuY2FjaGUuZ2V0T2JqZWN0czxUPihtb2RlbClcblxuICAgICAgICAgICAgaWYgKG9iamVjdHMubGVuZ3RoID09IDApIHtcbiAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgY3Vyc29yID0gb3B0aW9ucy5jdXJzb3IgfHwgJydcbiAgICAgICAgICAgIGxldCBsaW1pdCA9IG9wdGlvbnMubGltaXQgfHwgMTAwXG5cbiAgICAgICAgICAgIC8vIFNvcnQgYnkgSUQuIFRoZSByZXN1bHRpbmcgcGFnZWQgc2V0IGlzIG5vdCBwZXJmZWN0LCBhbmQgd2lsbCBoYXZlXG4gICAgICAgICAgICAvLyBob2xlcyB3aGVuIG5ldyBlbnRyaWVzIGFyZSBhZGRlZCBpbiBiZXR3ZWVuIHF1ZXJpZXMuXG4gICAgICAgICAgICBvYmplY3RzLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgICAgICAgIGxldCBhSWQgPSBhLmlkLnRvTG93ZXJDYXNlKClcbiAgICAgICAgICAgICAgIGxldCBiSWQgPSBiLmlkLnRvTG93ZXJDYXNlKClcbiAgICAgICAgICAgICAgIHJldHVybiAoYUlkIDwgYklkKSA/IC0xIDogKGFJZCA+IGJJZCkgPyAxIDogMFxuICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgaWYgKGN1cnNvciA9PT0gJycpIHtcbiAgICAgICAgICAgICAgIC8vIEZvciBhbiBlbXB0eSBjdXJzb3Igd2Ugc3RhcnQgZnJvbSB0aGUgYmVnaW5uaW5nXG4gICAgICAgICAgICAgICBsZXQgaXRlbXMgPSBvYmplY3RzLnNsaWNlKDAsIE1hdGgubWluKG9iamVjdHMubGVuZ3RoIC0gMSwgbGltaXQpKVxuXG4gICAgICAgICAgICAgICBpZiAoaXRlbXMubGVuZ3RoID09IGxpbWl0ICYmIG9iamVjdHMubGVuZ3RoID4gbGltaXQpIHtcbiAgICAgICAgICAgICAgICAgIHJlc3VsdHMuY3Vyc29yID0gQnVmZmVyLmZyb20ob2JqZWN0c1tsaW1pdCArIDFdLmlkKS50b1N0cmluZygnYmFzZTY0JylcbiAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAvLyBJZiB0aGVyZSBhcmUgbm8gbW9yZSBlbnRyaWVzIGluIHRoZW5leHQgc2V0LCB3ZSBkZWZhdWx0IHRoZSBjdXJzb3JcbiAgICAgICAgICAgICAgICAgIC8vIHRvIGVtcHR5IHN0cmluZ1xuICAgICAgICAgICAgICAgICAgcmVzdWx0cy5jdXJzb3IgPSAnJ1xuICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICByZXN1bHRzLml0ZW1zID0gaXRlbXNcbiAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgIC8vIFdlIGhhdmUgYSBjdXJzb3IgYW5kIGNvbnRpbnVlIGZyb20gd2hlbmNlIHdlIGxlZnQgb2ZmXG4gICAgICAgICAgICAgICBjdXJzb3IgPSBCdWZmZXIuZnJvbShjdXJzb3IsICdiYXNlNjQnKS50b1N0cmluZygnYXNjaWknKVxuXG4gICAgICAgICAgICAgICBsZXQgaW5kZXggPSBvYmplY3RzLmZpbmRJbmRleChvID0+IG8uaWQgPT09IGN1cnNvcilcblxuICAgICAgICAgICAgICAgaWYgKGluZGV4ID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgLy8gV2UgZ2V0IGhlcmUgd2hlbiB0aGUgb2JqZWN0IHRoYXQncyBuZXh0IGhhcyBiZWVuIGRlbGV0ZWRcbiAgICAgICAgICAgICAgICAgIC8vIHJldHVybiBlYXJseVxuICAgICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgIHJlc3VsdHMuaXRlbXMgPSBvYmplY3RzLnNsaWNlKGluZGV4LCBNYXRoLm1pbihvYmplY3RzLmxlbmd0aCAtIDEsIGxpbWl0KSlcblxuICAgICAgICAgICAgICAgaWYgKHJlc3VsdHMuaXRlbXMubGVuZ3RoID09IGxpbWl0ICYmIG9iamVjdHMubGVuZ3RoID4gbGltaXQpIHtcbiAgICAgICAgICAgICAgICAgIHJlc3VsdHMuY3Vyc29yID0gQnVmZmVyLmZyb20ob2JqZWN0c1tsaW1pdCArIDFdLmlkKS50b1N0cmluZygnYmFzZTY0JylcbiAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAvLyBJZiB0aGVyZSBhcmUgbm8gbW9yZSBlbnRyaWVzIGluIHRoZW5leHQgc2V0LCB3ZSBkZWZhdWx0IHRoZSBjdXJzb3JcbiAgICAgICAgICAgICAgICAgIC8vIHRvIGVtcHR5IHN0cmluZ1xuICAgICAgICAgICAgICAgICAgcmVzdWx0cy5jdXJzb3IgPSAnJ1xuICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICB9KVxuICAgICAgICAgLmNvbW1pdCgpXG5cbiAgICAgIHJldHVybiByZXN1bHRzXG4gICB9XG5cbiAgIGFzeW5jIGRlbGV0ZU9iamVjdDxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG1vZGVsOiBJTW9kZWwsIG9iajogVCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgYXdhaXQgdGhpcy5yZmMuY3JlYXRlKG5ldyBEZWxldGVPYmplY3RFdmVudChtb2RlbCwgb2JqKSlcbiAgICAgICAgIC5mdWxmaWxsKGFzeW5jIChldmVudCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5jYWNoZS5kZWxldGVPYmplY3QobW9kZWwsIG9iailcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc3RhY2suZW1pdChFdmVudFNldC5PYmplY3REZWxldGVkLCBldmVudClcbiAgICAgICAgIH0pXG4gICAgICAgICAuY29tbWl0KClcbiAgIH1cblxuICAgYXN5bmMgZ2V0T2JqZWN0PFQgZXh0ZW5kcyBTdGFja09iamVjdD4obW9kZWw6IElNb2RlbCwgaWQ6IHN0cmluZyk6IFByb21pc2U8VCB8IHVuZGVmaW5lZD4ge1xuICAgICAgbGV0IG9iamVjdDogVCB8IHVuZGVmaW5lZFxuXG4gICAgICBhd2FpdCB0aGlzLnJmYy5jcmVhdGUobmV3IEdldE9iamVjdEV2ZW50KG1vZGVsLCBpZCkpXG4gICAgICAgICAuZnVsZmlsbChhc3luYyAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgIGxldCBjYXN0ID0gZXZlbnQgYXMgR2V0T2JqZWN0RXZlbnQ8VD5cblxuICAgICAgICAgICAgaWYgKGNhc3Qub2JqZWN0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgIG9iamVjdCA9IGNhc3QuZXhpc3RzID09PSBFeGlzdFN0YXRlLkRvZXNOb3RFeGlzdCA/XG4gICAgICAgICAgICAgICAgICB1bmRlZmluZWQgOlxuICAgICAgICAgICAgICAgICAgdGhpcy5jYWNoZS5nZXRPYmplY3QobW9kZWwsIGlkKVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgIC8vIFdlIGdldCBhIHNlcmlhbGl6ZWQgdmVyc2lvbiBvZiB0aGUgT2JqZWN0XG4gICAgICAgICAgICAgICBsZXQgc2VyaWFsaXplZCA9IGF3YWl0IFByb3h5T2JqZWN0LmZyb21TdG9yZWQobW9kZWwsIGNhc3Qub2JqZWN0LCB0aGlzLmNvbnRleHQuc2VyaWFsaXplcilcbiAgICAgICAgICAgICAgIHRoaXMuY2FjaGUuc2F2ZU9iamVjdChtb2RlbCwgc2VyaWFsaXplZClcblxuICAgICAgICAgICAgICAgLy9AdHMtaWdub3JlXG4gICAgICAgICAgICAgICBvYmplY3QgPSBzZXJpYWxpemVkIGFzIFRcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFjay5lbWl0KEV2ZW50U2V0LkdldE9iamVjdCwgZXZlbnQpXG4gICAgICAgICB9KVxuICAgICAgICAgLmNvbW1pdCgpXG5cbiAgICAgIHJldHVybiBvYmplY3RcbiAgIH1cblxuICAgYXN5bmMgaGFzSWQoaWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgbGV0IGhhc0lkID0gZmFsc2VcblxuICAgICAgYXdhaXQgdGhpcy5yZmMuY3JlYXRlKG5ldyBIYXNJZEV2ZW50KGlkKSlcbiAgICAgICAgIC5mdWxmaWxsKGFzeW5jIChldmVudCkgPT4ge1xuICAgICAgICAgICAgbGV0IGNhc3QgPSBldmVudCBhcyBIYXNJZEV2ZW50XG5cbiAgICAgICAgICAgIGlmIChjYXN0Lmhhc0lkKSB7XG4gICAgICAgICAgICAgICBoYXNJZCA9IHRydWVcbiAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBIYXMgaXQgYSBwbHVnaW4gYXR0ZW1wdGVkIHRvIHNldCBpdD9cbiAgICAgICAgICAgIGlmIChjYXN0LmF0dGVtcHRlZFNldCkge1xuICAgICAgICAgICAgICAgLy8gSWYgc28sIHdlIGNhbiB0cnVzdCB0aGF0IGFuIGV4dGVybmFsIHN5c3RlbSBkb2Vzbid0IGhhdmUgaXRcbiAgICAgICAgICAgICAgIGhhc0lkID0gZmFsc2VcbiAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBJZiBubyBleHRlcm5hbCBzeXN0ZW0gYXR0ZW1wdGVkIHRvIHNldCBpdCwgZG8gd2UgaGF2ZSBpdCBjYWNoZWQ/XG4gICAgICAgICAgICBoYXNJZCA9IHRoaXMuY2FjaGUuaGFzSWQoaWQpXG5cbiAgICAgICAgIH0pXG4gICAgICAgICAuY29tbWl0KClcblxuICAgICAgcmV0dXJuIGhhc0lkXG4gICB9XG5cbiAgIGFzeW5jIHVwZGF0ZU9iamVjdDxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG1vZGVsOiBJTW9kZWwsIG9iajogVCwgb25VcGRhdGU6IFVwZGF0ZU9iamVjdEhhbmRsZXI8VD4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIGF3YWl0IHRoaXMucmZjLmNyZWF0ZShuZXcgVXBkYXRlT2JqZWN0RXZlbnQ8VD4obW9kZWwsIG9iaikpXG4gICAgICAgICAuZnVsZmlsbChhc3luYyAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgIGxldCBjYXN0ID0gZXZlbnQgYXMgVXBkYXRlT2JqZWN0RXZlbnQ8VD5cblxuICAgICAgICAgICAgbGV0IHVwZGF0ZWQgPSBjYXN0LnVwZGF0ZWRcblxuICAgICAgICAgICAgYXdhaXQgb25VcGRhdGUodXBkYXRlZCwgY2FzdC5leGlzdHMpXG5cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc3RhY2suZW1pdChFdmVudFNldC5PYmplY3RVcGRhdGVkLCBjYXN0KVxuICAgICAgICAgfSlcbiAgICAgICAgIC5jb21taXQoKVxuICAgfVxufSJdfQ==