"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Orchestrator = void 0;
const Model_1 = require("../Model");
const ProxyObject_1 = require("../ProxyObject");
const UidKeeper_1 = require("../UidKeeper");
const events_1 = require("../events");
class Orchestrator {
    get cache() {
        return this.context.cache;
    }
    get rfc() {
        return this.context.rfc;
    }
    get serializer() {
        return this.context.serializer;
    }
    get stack() {
        return this.context.stack;
    }
    get uid() {
        return this.context.uid;
    }
    constructor(context) {
        this.context = context;
    }
    async boostrap() {
        await this.rfc.create(new events_1.BootstrapEvent())
            .fulfill(async (event) => {
            await this.stack.emit(events_1.EventSet.Bootstrap, event);
        })
            .commit();
    }
    async createModel(name, params) {
        let model = await this.stack.get.model(name);
        if (model !== undefined) {
            throw new Error(`A Model with the name ${name} already exists`);
        }
        model = await Model_1.Model.create(name, this.context);
        await model.append(params);
        this.cache.saveModel(model);
        await this.rfc.create(new events_1.ModelCreateEvent(model))
            .fulfill(async (event) => {
            await this.stack.emit(events_1.EventSet.ModelCreated, event);
        })
            .commit();
        return model;
    }
    async deleteModel(model) {
        await this.rfc.create(new events_1.ModelDeleteEvent(model))
            .fulfill(async (event) => {
            this.cache.deleteModel(model.name);
        })
            .commit();
    }
    // Note: This may not be needed. Watch for this.
    // Model's are stored in local cache because they are
    // defined locally, and are the contract between the
    // the expected data set and what is stored.
    async getModel(name) {
        let model;
        await this.rfc.create(new events_1.GetModelEvent(name))
            .fulfill(async (event) => {
            let getModel = event;
            model = getModel.model || this.cache.getModel(name);
            if (model !== undefined) {
                this.cache.saveModel(model);
            }
            await this.stack.emit(events_1.EventSet.GetModel, event);
        })
            .commit();
        return model;
    }
    async updateModel(model, params) {
        this.rfc.create(new events_1.ModelUpdateEvent(model))
            .fulfill(async (event) => {
            let updateModelEvent = event;
            this.cache.saveModel(updateModelEvent.model);
        })
            .commit();
    }
    async createObject(model, params) {
        let created = await ProxyObject_1.ProxyObject.fromCreated(model, params, this.context);
        await this.rfc.create(new events_1.ObjectCreateEvent(model, created))
            .fulfill(async (event) => {
            await this.stack.emit(events_1.EventSet.ObjectCreated, event);
        })
            .commit();
        return created;
    }
    /**
     *
     * @param model The Model
     * @param obj The Object to save. Note that this is really a Proxy'd SerializableObject
     */
    async saveObject(model, obj) {
        if (obj.id === UidKeeper_1.UidKeeper.IdNotSet) {
            obj.id = await this.uid.generate(model);
        }
        let validations = await model.validate(obj);
        if (!validations.success) {
            throw new Error(`Cannot Save Object with ID ${obj.id} since it fails validation. Reason: ${validations.results.map(r => r.error)}`);
        }
        //@ts-ignore
        let serialized = ProxyObject_1.ProxyObject.unwrap(obj);
        await this.rfc.create(new events_1.ObjectSaveEvent(model, obj, serialized))
            .fulfill(async (event) => {
            this.cache.saveObject(model, obj);
            await this.stack.emit(events_1.EventSet.ObjectSaved, event);
        })
            .commit();
    }
    async getManyObjects(model, options = { cursor: '', limit: 100 }) {
        let results = {
            cursor: '',
            items: new Array()
        };
        await this.rfc.create(new events_1.GetManyObjectsEvent(model, options))
            .fulfill(async (event) => {
            let cast = event;
            await this.stack.emit(events_1.EventSet.GetManyObjects, cast);
            if (cast.results !== undefined) {
                results = cast.results;
                return;
            }
            let objects = this.cache.getObjects(model);
            if (objects.length == 0) {
                return;
            }
            let cursor = options.cursor || '';
            let limit = options.limit || 100;
            // Sort by ID. The resulting paged set is not perfect, and will have
            // holes when new entries are added in between queries.
            objects.sort((a, b) => {
                let aId = a.id.toLowerCase();
                let bId = b.id.toLowerCase();
                return (aId < bId) ? -1 : (aId > bId) ? 1 : 0;
            });
            if (cursor === '') {
                // For an empty cursor we start from the beginning
                let items = objects.slice(0, Math.min(objects.length, limit));
                if (items.length == limit && objects.length > limit) {
                    results.cursor = Buffer.from(objects[limit].id).toString('base64');
                }
                else {
                    // If there are no more entries in the next set, we default the cursor
                    // to empty string
                    results.cursor = '';
                }
                results.items = items;
                return;
            }
            else {
                // We have a cursor and continue from whence we left off
                cursor = Buffer.from(cursor, 'base64').toString('ascii');
                let index = objects.findIndex(o => o.id === cursor);
                if (index === -1) {
                    // We get here when the object that's next has been deleted
                    // return early
                    return;
                }
                let nextIndex = index + limit;
                results.items = objects.slice(index, nextIndex);
                if (objects.length > nextIndex) {
                    results.cursor = Buffer.from(objects[nextIndex].id).toString('base64');
                }
                else {
                    // If there are no more entries in the next set, we default the cursor
                    // to empty string
                    results.cursor = '';
                }
                return;
            }
            return;
        })
            .commit();
        return results;
    }
    async deleteObject(model, obj) {
        await this.rfc.create(new events_1.ObjectDeleteEvent(model, obj))
            .fulfill(async (event) => {
            this.cache.deleteObject(model, obj);
            await this.stack.emit(events_1.EventSet.ObjectDeleted, event);
        })
            .commit();
    }
    async getObject(model, id) {
        let object;
        await this.rfc.create(new events_1.GetObjectEvent(model, id))
            .fulfill(async (event) => {
            let cast = event;
            if (cast.object === undefined) {
                object = cast.exists === events_1.ExistState.DoesNotExist ?
                    undefined :
                    this.cache.getObject(model, id);
            }
            else {
                // We get a serialized version of the Object
                let serialized = await ProxyObject_1.ProxyObject.fromStored(model, cast.object, this.context.serializer);
                this.cache.saveObject(model, serialized);
                //@ts-ignore
                object = serialized;
            }
            await this.stack.emit(events_1.EventSet.GetObject, event);
        })
            .commit();
        return object;
    }
    async hasId(id, model) {
        let hasId = false;
        await this.rfc.create(new events_1.HasIdEvent(id, model))
            .fulfill(async (event) => {
            let cast = event;
            await this.stack.emit(events_1.EventSet.HasId, event);
            if (cast.hasId) {
                hasId = true;
                return;
            }
            // Has it a plugin attempted to set it?
            if (cast.attemptedSet) {
                // If so, we can trust that an external system doesn't have it
                hasId = false;
                return;
            }
            // If no external system attempted to set it, do we have it cached?
            hasId = this.cache.hasId(id);
        })
            .commit();
        return hasId;
    }
    async storeQueryObject(handler) {
        let result = undefined;
        await this.rfc.create(new events_1.GetStoreContextEvent())
            .fulfill(async (event) => {
            let getStoreContext = event;
            result = await handler(getStoreContext.contexts);
        })
            .commit();
        return result;
    }
    /**
     * Updates an already existing object with the latest from the stored version.
     * This method is intended to be used on long lived objects where we want them
     * to be updated locally, and not saved.
     *
     * @param model The Model
     * @param obj The Object
     * @param onUpdate Function to update the Object based on the latest version
     */
    async updateObject(model, obj, onUpdate) {
        await this.rfc.create(new events_1.ObjectUpdateEvent(model, obj, ProxyObject_1.ProxyObject.unwrap(obj)))
            .fulfill(async (event) => {
            let cast = event;
            let updated = cast.updated;
            await onUpdate(updated, cast.exists);
            await this.stack.emit(events_1.EventSet.ObjectUpdated, event);
        })
            .commit();
    }
}
exports.Orchestrator = Orchestrator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT3JjaGVzdHJhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL29yY2hlc3RyYXRvci9PcmNoZXN0cmF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBRUEsb0NBQTJHO0FBSTNHLGdEQUE2QztBQUM3Qyw0Q0FBcUQ7QUFHckQsc0NBaUJrQjtBQTRHbEIsTUFBYSxZQUFZO0lBQ3RCLElBQUksS0FBSztRQUNOLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUE7SUFDNUIsQ0FBQztJQUVELElBQUksR0FBRztRQUNKLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUE7SUFDMUIsQ0FBQztJQUVELElBQUksVUFBVTtRQUNYLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUE7SUFDakMsQ0FBQztJQUVELElBQUksS0FBSztRQUNOLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUE7SUFDNUIsQ0FBQztJQUVELElBQUksR0FBRztRQUNKLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUE7SUFDMUIsQ0FBQztJQUVELFlBQXFCLE9BQXNCO1FBQXRCLFlBQU8sR0FBUCxPQUFPLENBQWU7SUFFM0MsQ0FBQztJQUVELEtBQUssQ0FBQyxRQUFRO1FBQ1gsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLHVCQUFjLEVBQUUsQ0FBQzthQUN2QyxPQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQ3RCLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsaUJBQVEsQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFDbkQsQ0FBQyxDQUFDO2FBQ0QsTUFBTSxFQUFFLENBQUE7SUFDZixDQUFDO0lBRUQsS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFZLEVBQUUsTUFBeUI7UUFDdEQsSUFBSSxLQUFLLEdBQUcsTUFBTSxJ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QUFDLE1BQU0sQ0FBQyxJQUFJLDZCQUFvQixFQUFFLENBQUM7YUFDN0MsT0FBTyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRTtZQUN0QixJQUFJLGVBQWUsR0FBRyxLQUE2QixDQUFBO1lBRW5ELE1BQU0sR0FBRyxNQUFNLE9BQU8sQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDbkQsQ0FBQyxDQUFDO2FBQ0QsTUFBTSxFQUFFLENBQUE7UUFFWixPQUFPLE1BQU0sQ0FBQTtJQUNoQixDQUFDO0lBRUQ7Ozs7Ozs7O09BUUc7SUFDSCxLQUFLLENBQUMsWUFBWSxDQUF3QixLQUFhLEVBQUUsR0FBTSxFQUFFLFFBQWdDO1FBQzlGLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSwwQkFBaUIsQ0FBSSxLQUFLLEVBQUUsR0FBRyxFQUFFLHlCQUFXLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7YUFDaEYsT0FBTyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRTtZQUN0QixJQUFJLElBQUksR0FBRyxLQUE2QixDQUFBO1lBRXhDLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUE7WUFFMUIsTUFBTSxRQUFRLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUVwQyxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLGlCQUFRLENBQUMsYUFBYSxFQUFFLEtBQUssQ0FBQyxDQUFBO1FBQ3ZELENBQUMsQ0FBQzthQUNELE1BQU0sRUFBRSxDQUFBO0lBQ2YsQ0FBQztDQUNIO0FBNVRELG9DQTRUQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN0YWNrT2JqZWN0IH0gZnJvbSBcIi4uL1N0YWNrT2JqZWN0XCI7XG5pbXBvcnQgeyBJQ2FjaGUgfSBmcm9tIFwiLi4vQ2FjaGVcIjtcbmltcG9ydCB7IElNb2RlbCwgTW9kZWwsIE1vZGVsQ3JlYXRlUGFyYW1zLCBPYmplY3RDcmVhdGVQYXJhbXMsIFBhZ2VSZXF1ZXN0LCBQYWdlUmVzcG9uc2UgfSBmcm9tIFwiLi4vTW9kZWxcIjtcbmltcG9ydCB7IEFwcGx5U3RvcmVDb250ZXh0SGFuZGxlciwgSVN0YWNrIH0gZnJvbSBcIi4uL3N0YWNrL1N0YWNrXCI7XG5pbXBvcnQgeyBJU3RhY2tDb250ZXh0IH0gZnJvbSBcIi4uL3N0YWNrL1N0YWNrQ29udGV4dFwiO1xuaW1wb3J0IHsgVXBkYXRlT2JqZWN0SGFuZGxlciB9IGZyb20gXCIuLi9zdGFjay9TdGFja1VwZGF0ZVwiO1xuaW1wb3J0IHsgUHJveHlPYmplY3QgfSBmcm9tIFwiLi4vUHJveHlPYmplY3RcIjtcbmltcG9ydCB7IElVaWRLZWVwZXIsIFVpZEtlZXBlciB9IGZyb20gXCIuLi9VaWRLZWVwZXJcIjtcbmltcG9ydCB7IElWYWx1ZVNlcmlhbGl6ZXIgfSBmcm9tIFwiLi4vc2VyaWFsaXplL1ZhbHVlU2VyaWFsaXplclwiO1xuXG5pbXBvcnQge1xuICAgQm9vdHN0cmFwRXZlbnQsXG4gICBNb2RlbENyZWF0ZUV2ZW50LFxuICAgT2JqZWN0Q3JlYXRlRXZlbnQsXG4gICBNb2RlbERlbGV0ZUV2ZW50LFxuICAgT2JqZWN0RGVsZXRlRXZlbnQsXG4gICBFdmVudFNldCxcbiAgIEV4aXN0U3RhdGUsXG4gICBHZXRNYW55T2JqZWN0c0V2ZW50LFxuICAgR2V0TW9kZWxFdmVudCxcbiAgIEdldE9iamVjdEV2ZW50LFxuICAgR2V0U3RvcmVDb250ZXh0RXZlbnQsXG4gICBIYXNJZEV2ZW50LFxuICAgSVJlcXVlc3RGb3JDaGFuZ2VTb3VyY2UsXG4gICBPYmplY3RTYXZlRXZlbnQsXG4gICBPYmplY3RVcGRhdGVFdmVudCxcbiAgIE1vZGVsVXBkYXRlRXZlbnRcbn0gZnJvbSAnLi4vZXZlbnRzJ1xuZXhwb3J0IGludGVyZmFjZSBJT3JjaGVzdHJhdG9yIHtcbiAgIC8vIFRPRE86IEFkZDogY3JlYXRlTW9kZWwsIGRlbGV0ZU1vZGVsICh0aGVzZSBzaG91bGQgYXNzaXN0IGluIHJ1bm5pbmcgdGVzdHMpXG5cbiAgIC8qKlxuICAgICogQm9vdHN0cmFwcyB0aGUgU3RhY2suXG4gICAgKi9cbiAgIGJvb3N0cmFwKCk6IFByb21pc2U8dm9pZD5cblxuICAgLyoqXG4gICAgKiBDcmVhdGVzIGEgTW9kZWxcbiAgICAqIFxuICAgICogQHBhcmFtIG5hbWUgVGhlIG5hbWUgb2YgdGhlIE1vZGVsXG4gICAgKiBAcGFyYW0gcGFyYW1zIFRoZSBQYXJhbXMgdXNlZCB0byBjcmVhdGUgdGhlIE1vZGVsXG4gICAgKi9cbiAgIGNyZWF0ZU1vZGVsKG5hbWU6IHN0cmluZywgcGFyYW1zOiBNb2RlbENyZWF0ZVBhcmFtcyk6IFByb21pc2U8SU1vZGVsPlxuXG4gICAvKipcbiAgICAqIERlbGV0ZXMgYSBNb2RlbFxuICAgICogXG4gICAgKiBAcGFyYW0gbW9kZWwgVGhlIE1vZGVsIHRvIGRlbGV0ZVxuICAgICovXG4gICBkZWxldGVNb2RlbChtb2RlbDogSU1vZGVsKTogUHJvbWlzZTx2b2lkPlxuXG4gICAvKipcbiAgICAqIFJldHJpZXZlcyBhIE1vZGVsIGlmIGl0IGV4aXN0cywgb3IgdW5kZWZpZW5kIGlmIG5vdC5cbiAgICAqIFxuICAgICogQHBhcmFtIG5hbWUgVGhlIE1vZGVsIG5hbWVcbiAgICAqL1xuICAgZ2V0TW9kZWwobmFtZTogc3RyaW5nKTogUHJvbWlzZTxJTW9kZWwgfCB1bmRlZmluZWQ+XG5cbiAgIC8qKlxuICAgICogVXBkYXRlcyBhbiBleGlzdGluZyBNb2RlbFxuICAgICogXG4gICAgKiBAcGFyYW0gbW9kZWwgVGhlIE1vZGVsIHRvIHVwZGF0ZVxuICAgICogQHBhcmFtIHBhcmFtcyBUaGUgUGFyYW1zXG4gICAgKi9cbiAgIHVwZGF0ZU1vZGVsKG1vZGVsOiBJTW9kZWwsIHBhcmFtczogTW9kZWxDcmVhdGVQYXJhbXMpOiBQcm9taXNlPHZvaWQ+XG5cbiAgIC8qKlxuICAgICogQ3JlYXRlcyBhIG5ldyBPYmplY3QgaW4gbWVtb3J5IG9ubHkuIE5vdCBpbmRlbmRlZCB0byBiZSBzdG9yZWQgb24gdGhlIGJhY2tlbmQuXG4gICAgKiBPYmplY3RzIGNyZWF0ZWQgdGhpcyB3YXkgaGF2ZSBubyBJRCBhc3NpZ25lZCB0byB0aGVtIHVudGlsIHRoZXkgYXJlIHNhdmVkLlxuICAgICogXG4gICAgKiBAcGFyYW0gbW9kZWwgVGhlIE1vZGVsXG4gICAgKiBAcGFyYW0gcGFyYW1zIFRoZSBPYmplY3QgQ3JlYXRpb24gUGFyYW1zIFxuICAgICovXG4gICBjcmVhdGVPYmplY3Q8VCBleHRlbmRzIFN0YWNrT2JqZWN0Pihtb2RlbDogSU1vZGVsLCBwYXJhbXM6IE9iamVjdENyZWF0ZVBhcmFtcyk6IFByb21pc2U8VD5cblxuICAgLyoqXG4gICAgKiBTYXZlcyBhbiBPYmplY3QgdG8gdGhlIGJhY2tlbmQuXG4gICAgKiBcbiAgICAqIEBwYXJhbSBtb2RlbCBUaGUgTW9kZWxcbiAgICAqIEBwYXJhbSBvYmogVGhlIE9iamVjdCB0byBTYXZlXG4gICAgKi9cbiAgIHNhdmVPYmplY3Q8VCBleHRlbmRzIFN0YWNrT2JqZWN0Pihtb2RlbDogSU1vZGVsLCBvYmo6IFQpOiBQcm9taXNlPHZvaWQ+XG5cbiAgIC8qKlxuICAgICogRGVsZXRlcyBhbiBPYmplY3QgZnJvbSB0aGUgYmFja2VuZFxuICAgICogXG4gICAgKiBAcGFyYW0gbW9kZWwgVGhlIE1vZGVsXG4gICAgKiBAcGFyYW0gb2JqIFRoZSBPYmplY3QgdG8gZGVsZXRlXG4gICAgKi9cbiAgIGRlbGV0ZU9iamVjdDxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG1vZGVsOiBJTW9kZWwsIG9iajogVCk6IFByb21pc2U8dm9pZD5cblxuICAgLyoqXG4gICAgKiBSZXRyaWV2ZXMgbWFueSBvYmplY3RzIGluIGEgcGFnZWQgZmFzaGlvbi5cbiAgICAqIFxuICAgICogQHBhcmFtIG1vZGVsIFRoZSBNb2RlbCByZXByZXNlbnRpbmcgdGhlIE9iamVjdHNcbiAgICAqIEBwYXJhbSBvcHRpb25zIFBhZ2VSZXF1ZXN0IE9wdGlvbnNcbiAgICAqL1xuICAgZ2V0TWFueU9iamVjdHM8VCBleHRlbmRzIFN0YWNrT2JqZWN0Pihtb2RlbDogSU1vZGVsLCBvcHRpb25zOiBQYWdlUmVxdWVzdCk6IFByb21pc2U8UGFnZVJlc3BvbnNlPFQ+PlxuICAgXG4gICAvKipcbiAgICAqIFJldHJpZXZlcyB0aGUgRWRpdCB2ZXJzaW9uIG9mIHRoZSBPYmplY3RcbiAgICAqIFxuICAgICogQHBhcmFtIG1vZGVsIFRoZSBNb2RlbCBvZiB0aGUgT2JqZWN0XG4gICAgKiBAcGFyYW0gaWQgVGhlIE9iamVjdCdzIElEXG4gICAgKi9cbiAgIGdldE9iamVjdDxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG1vZGVsOiBJTW9kZWwsIGlkOiBzdHJpbmcpOiBQcm9taXNlPFQgfCB1bmRlZmluZWQ+XG5cbiAgIC8qKlxuICAgICogRGV0ZXJtaW5lcyBpZiBhbiBJRCBpcyBhbHJlYWR5IGluIHVzZS5cbiAgICAqIFxuICAgICogQHBhcmFtIGlkIFRoZSBJRCB0byB0ZXN0XG4gICAgKiBAcGFyYW0gbW9kZWwgVGhlIGFzc29jaWF0ZWQgTW9kZWxcbiAgICAqL1xuICAgaGFzSWQoaWQ6IHN0cmluZywgbW9kZWw6IElNb2RlbCk6IFByb21pc2U8Ym9vbGVhbj5cbiAgIFxuICAgLyoqXG4gICAgKiBDcmVhdGVzIGFuZCBzdG9yZXMgYSBjdXN0b20gUXVlcnkgT2JqZWN0XG4gICAgKiBcbiAgICAqIEBwYXJhbSBoYW5kbGVyIFRoZSBoYW5kbGVyIHRvIGNyZWF0ZSB0aGUgY3VzdG9tIFF1ZXJ5IE9iamVjdFxuICAgICovXG4gICAgc3RvcmVRdWVyeU9iamVjdDxUPihoYW5kbGVyOiBBcHBseVN0b3JlQ29udGV4dEhhbmRsZXI8VD4pOiBQcm9taXNlPFQgfCB1bmRlZmluZWQ+XG5cbiAgIC8qKlxuICAgICogVXBkYXRlcyBhbiBhbHJlYWR5IGV4aXN0aW5nIG9iamVjdCB3aXRoIHRoZSBsYXRlc3QgZnJvbSB0aGUgc3RvcmVkIHZlcnNpb24uXG4gICAgKiBUaGlzIG1ldGhvZCBpcyBpbnRlbmRlZCB0byBiZSB1c2VkIG9uIGxvbmcgbGl2ZWQgb2JqZWN0cyB3aGVyZSB3ZSB3YW50IHRoZW1cbiAgICAqIHRvIGJlIHVwZGF0ZWQgbG9jYWxseSwgYW5kIG5vdCBzYXZlZC5cbiAgICAqIFxuICAgICogQHBhcmFtIG1vZGVsIFRoZSBNb2RlbFxuICAgICogQHBhcmFtIG9iaiBUaGUgT2JqZWN0XG4gICAgKiBAcGFyYW0gb25VcGRhdGUgRnVuY3Rpb24gdG8gdXBkYXRlIHRoZSBPYmplY3QgYmFzZWQgb24gdGhlIGxhdGVzdCB2ZXJzaW9uXG4gICAgKi9cbiAgIHVwZGF0ZU9iamVjdDxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG1vZGVsOiBJTW9kZWwsIG9iajogVCwgb25VcGRhdGU6IFVwZGF0ZU9iamVjdEhhbmRsZXI8VD4pOiBQcm9taXNlPHZvaWQ+XG59XG5cblxuZXhwb3J0IGNsYXNzIE9yY2hlc3RyYXRvciBpbXBsZW1lbnRzIElPcmNoZXN0cmF0b3Ige1xuICAgZ2V0IGNhY2hlKCk6IElDYWNoZSB7XG4gICAgICByZXR1cm4gdGhpcy5jb250ZXh0LmNhY2hlXG4gICB9XG5cbiAgIGdldCByZmMoKTogSVJlcXVlc3RGb3JDaGFuZ2VTb3VyY2Uge1xuICAgICAgcmV0dXJuIHRoaXMuY29udGV4dC5yZmNcbiAgIH1cblxuICAgZ2V0IHNlcmlhbGl6ZXIoKTogSVZhbHVlU2VyaWFsaXplciB7XG4gICAgICByZXR1cm4gdGhpcy5jb250ZXh0LnNlcmlhbGl6ZXJcbiAgIH1cblxuICAgZ2V0IHN0YWNrKCk6IElTdGFjayB7XG4gICAgICByZXR1cm4gdGhpcy5jb250ZXh0LnN0YWNrXG4gICB9XG5cbiAgIGdldCB1aWQoKTogSVVpZEtlZXBlciB7XG4gICAgICByZXR1cm4gdGhpcy5jb250ZXh0LnVpZFxuICAgfVxuXG4gICBjb25zdHJ1Y3RvcihyZWFkb25seSBjb250ZXh0OiBJU3RhY2tDb250ZXh0KSB7XG5cbiAgIH1cblxuICAgYXN5bmMgYm9vc3RyYXAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICBhd2FpdCB0aGlzLnJmYy5jcmVhdGUobmV3IEJvb3RzdHJhcEV2ZW50KCkpXG4gICAgICAgICAuZnVsZmlsbChhc3luYyAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc3RhY2suZW1pdChFdmVudFNldC5Cb290c3RyYXAsIGV2ZW50KVxuICAgICAgICAgfSlcbiAgICAgICAgIC5jb21taXQoKVxuICAgfVxuXG4gICBhc3luYyBjcmVhdGVNb2RlbChuYW1lOiBzdHJpbmcsIHBhcmFtczogTW9kZWxDcmVhdGVQYXJhbXMpOiBQcm9taXNlPElNb2RlbD4ge1xuICAgICAgbGV0IG1vZGVsID0gYXdhaXQgdGhpcy5zdGFjay5nZXQubW9kZWwobmFtZSlcblxuICAgICAgaWYobW9kZWwgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBBIE1vZGVsIHdpdGggdGhlIG5hbWUgJHtuYW1lfSBhbHJlYWR5IGV4aXN0c2ApXG4gICAgICB9XG5cbiAgICAgIG1vZGVsID0gYXdhaXQgTW9kZWwuY3JlYXRlKG5hbWUsIHRoaXMuY29udGV4dClcbiAgICAgIGF3YWl0IG1vZGVsLmFwcGVuZChwYXJhbXMpXG5cbiAgICAgIHRoaXMuY2FjaGUuc2F2ZU1vZGVsKG1vZGVsKVxuXG4gICAgICBhd2FpdCB0aGlzLnJmYy5jcmVhdGUobmV3IE1vZGVsQ3JlYXRlRXZlbnQobW9kZWwpKVxuICAgICAgICAgLmZ1bGZpbGwoYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YWNrLmVtaXQoRXZlbnRTZXQuTW9kZWxDcmVhdGVkLCBldmVudClcbiAgICAgICAgIH0pXG4gICAgICAgICAuY29tbWl0KClcblxuICAgICAgcmV0dXJuIG1vZGVsXG4gICB9XG5cbiAgIGFzeW5jIGRlbGV0ZU1vZGVsKG1vZGVsOiBJTW9kZWwpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIGF3YWl0IHRoaXMucmZjLmNyZWF0ZShuZXcgTW9kZWxEZWxldGVFdmVudChtb2RlbCkpXG4gICAgICAgICAuZnVsZmlsbCggYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlLmRlbGV0ZU1vZGVsKG1vZGVsLm5hbWUpXG4gICAgICAgICB9KVxuICAgICAgICAgLmNvbW1pdCgpXG4gICB9XG5cbiAgIC8vIE5vdGU6IFRoaXMgbWF5IG5vdCBiZSBuZWVkZWQuIFdhdGNoIGZvciB0aGlzLlxuICAgLy8gTW9kZWwncyBhcmUgc3RvcmVkIGluIGxvY2FsIGNhY2hlIGJlY2F1c2UgdGhleSBhcmVcbiAgIC8vIGRlZmluZWQgbG9jYWxseSwgYW5kIGFyZSB0aGUgY29udHJhY3QgYmV0d2VlbiB0aGVcbiAgIC8vIHRoZSBleHBlY3RlZCBkYXRhIHNldCBhbmQgd2hhdCBpcyBzdG9yZWQuXG4gICBhc3luYyBnZXRNb2RlbChuYW1lOiBzdHJpbmcpOiBQcm9taXNlPElNb2RlbCB8IHVuZGVmaW5lZD4ge1xuICAgICAgbGV0IG1vZGVsOiBJTW9kZWwgfCB1bmRlZmluZWRcblxuICAgICAgYXdhaXQgdGhpcy5yZmMuY3JlYXRlKG5ldyBHZXRNb2RlbEV2ZW50KG5hbWUpKVxuICAgICAgICAgLmZ1bGZpbGwoYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBsZXQgZ2V0TW9kZWwgPSBldmVudCBhcyBHZXRNb2RlbEV2ZW50XG4gICAgICAgICAgICBtb2RlbCA9IGdldE1vZGVsLm1vZGVsIHx8IHRoaXMuY2FjaGUuZ2V0TW9kZWwobmFtZSlcblxuICAgICAgICAgICAgaWYobW9kZWwgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgdGhpcy5jYWNoZS5zYXZlTW9kZWwobW9kZWwpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc3RhY2suZW1pdChFdmVudFNldC5HZXRNb2RlbCwgZXZlbnQpXG4gICAgICAgICB9KVxuICAgICAgICAgLmNvbW1pdCgpXG5cbiAgICAgIHJldHVybiBtb2RlbFxuICAgfVxuXG4gICBhc3luYyB1cGRhdGVNb2RlbChtb2RlbDogSU1vZGVsLCBwYXJhbXM6IE1vZGVsQ3JlYXRlUGFyYW1zKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICB0aGlzLnJmYy5jcmVhdGUobmV3IE1vZGVsVXBkYXRlRXZlbnQobW9kZWwpKVxuICAgICAgICAgLmZ1bGZpbGwoYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBsZXQgdXBkYXRlTW9kZWxFdmVudCA9IGV2ZW50IGFzIE1vZGVsVXBkYXRlRXZlbnRcbiAgICAgICAgICAgIHRoaXMuY2FjaGUuc2F2ZU1vZGVsKHVwZGF0ZU1vZGVsRXZlbnQubW9kZWwpXG4gICAgICAgICB9KVxuICAgICAgICAgLmNvbW1pdCgpXG4gICB9XG5cbiAgIGFzeW5jIGNyZWF0ZU9iamVjdDxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG1vZGVsOiBJTW9kZWwsIHBhcmFtczogT2JqZWN0Q3JlYXRlUGFyYW1zKTogUHJvbWlzZTxUPiB7XG4gICAgICBsZXQgY3JlYXRlZCA9IGF3YWl0IFByb3h5T2JqZWN0LmZyb21DcmVhdGVkPFQ+KG1vZGVsLCBwYXJhbXMsIHRoaXMuY29udGV4dCkgYXMgVFxuXG4gICAgICBhd2FpdCB0aGlzLnJmYy5jcmVhdGUobmV3IE9iamVjdENyZWF0ZUV2ZW50KG1vZGVsLCBjcmVhdGVkKSlcbiAgICAgICAgIC5mdWxmaWxsKGFzeW5jIChldmVudCkgPT4ge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFjay5lbWl0KEV2ZW50U2V0Lk9iamVjdENyZWF0ZWQsIGV2ZW50KVxuICAgICAgICAgfSlcbiAgICAgICAgIC5jb21taXQoKVxuXG4gICAgICByZXR1cm4gY3JlYXRlZFxuICAgfVxuXG4gICAvKipcbiAgICAqIFxuICAgICogQHBhcmFtIG1vZGVsIFRoZSBNb2RlbFxuICAgICogQHBhcmFtIG9iaiBUaGUgT2JqZWN0IHRvIHNhdmUuIE5vdGUgdGhhdCB0aGlzIGlzIHJlYWxseSBhIFByb3h5J2QgU2VyaWFsaXphYmxlT2JqZWN0XG4gICAgKi9cbiAgIGFzeW5jIHNhdmVPYmplY3Q8VCBleHRlbmRzIFN0YWNrT2JqZWN0Pihtb2RlbDogSU1vZGVsLCBvYmo6IFQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIGlmKG9iai5pZCA9PT0gVWlkS2VlcGVyLklkTm90U2V0KSB7XG4gICAgICAgICBvYmouaWQgPSBhd2FpdCB0aGlzLnVpZC5nZW5lcmF0ZShtb2RlbClcbiAgICAgIH1cbiAgICAgIFxuICAgICAgbGV0IHZhbGlkYXRpb25zID0gYXdhaXQgbW9kZWwudmFsaWRhdGUob2JqKVxuXG4gICAgICBpZiAoIXZhbGlkYXRpb25zLnN1Y2Nlc3MpIHtcbiAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IFNhdmUgT2JqZWN0IHdpdGggSUQgJHtvYmouaWR9IHNpbmNlIGl0IGZhaWxzIHZhbGlkYXRpb24uIFJlYXNvbjogJHt2YWxpZGF0aW9ucy5yZXN1bHRzLm1hcChyID0+IHIuZXJyb3IpfWApXG4gICAgICB9XG5cbiAgICAgIC8vQHRzLWlnbm9yZVxuICAgICAgbGV0IHNlcmlhbGl6ZWQgPSBQcm94eU9iamVjdC51bndyYXAob2JqKVxuXG4gICAgICBhd2FpdCB0aGlzLnJmYy5jcmVhdGUobmV3IE9iamVjdFNhdmVFdmVudDxUPihtb2RlbCwgb2JqLCBzZXJpYWxpemVkKSlcbiAgICAgICAgIC5mdWxmaWxsKGFzeW5jIChldmVudCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5jYWNoZS5zYXZlT2JqZWN0KG1vZGVsLCBvYmopXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YWNrLmVtaXQoRXZlbnRTZXQuT2JqZWN0U2F2ZWQsIGV2ZW50KVxuICAgICAgICAgfSlcbiAgICAgICAgIC5jb21taXQoKVxuICAgfVxuXG4gICBhc3luYyBnZXRNYW55T2JqZWN0czxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG1vZGVsOiBJTW9kZWwsIG9wdGlvbnM6IFBhZ2VSZXF1ZXN0ID0geyBjdXJzb3I6ICcnLCBsaW1pdDogMTAwIH0pOiBQcm9taXNlPFBhZ2VSZXNwb25zZTxUPj4ge1xuICAgICAgbGV0IHJlc3VsdHMgPSB7XG4gICAgICAgICBjdXJzb3I6ICcnLFxuICAgICAgICAgaXRlbXM6IG5ldyBBcnJheTxUPigpXG4gICAgICB9XG5cbiAgICAgIGF3YWl0IHRoaXMucmZjLmNyZWF0ZShuZXcgR2V0TWFueU9iamVjdHNFdmVudChtb2RlbCwgb3B0aW9ucykpXG4gICAgICAgICAuZnVsZmlsbChhc3luYyAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgIGxldCBjYXN0ID0gZXZlbnQgYXMgR2V0TWFueU9iamVjdHNFdmVudDxUPlxuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YWNrLmVtaXQoRXZlbnRTZXQuR2V0TWFueU9iamVjdHMsIGNhc3QpXG5cbiAgICAgICAgICAgIGlmIChjYXN0LnJlc3VsdHMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgcmVzdWx0cyA9IGNhc3QucmVzdWx0c1xuICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBvYmplY3RzID0gdGhpcy5jYWNoZS5nZXRPYmplY3RzPFQ+KG1vZGVsKVxuXG4gICAgICAgICAgICBpZiAob2JqZWN0cy5sZW5ndGggPT0gMCkge1xuICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBjdXJzb3IgPSBvcHRpb25zLmN1cnNvciB8fCAnJ1xuICAgICAgICAgICAgbGV0IGxpbWl0ID0gb3B0aW9ucy5saW1pdCB8fCAxMDBcblxuICAgICAgICAgICAgLy8gU29ydCBieSBJRC4gVGhlIHJlc3VsdGluZyBwYWdlZCBzZXQgaXMgbm90IHBlcmZlY3QsIGFuZCB3aWxsIGhhdmVcbiAgICAgICAgICAgIC8vIGhvbGVzIHdoZW4gbmV3IGVudHJpZXMgYXJlIGFkZGVkIGluIGJldHdlZW4gcXVlcmllcy5cbiAgICAgICAgICAgIG9iamVjdHMuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICAgICAgICAgbGV0IGFJZCA9IGEuaWQudG9Mb3dlckNhc2UoKVxuICAgICAgICAgICAgICAgbGV0IGJJZCA9IGIuaWQudG9Mb3dlckNhc2UoKVxuICAgICAgICAgICAgICAgcmV0dXJuIChhSWQgPCBiSWQpID8gLTEgOiAoYUlkID4gYklkKSA/IDEgOiAwXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICBpZiAoY3Vyc29yID09PSAnJykge1xuICAgICAgICAgICAgICAgLy8gRm9yIGFuIGVtcHR5IGN1cnNvciB3ZSBzdGFydCBmcm9tIHRoZSBiZWdpbm5pbmdcbiAgICAgICAgICAgICAgIGxldCBpdGVtcyA9IG9iamVjdHMuc2xpY2UoMCwgTWF0aC5taW4ob2JqZWN0cy5sZW5ndGgsIGxpbWl0KSlcblxuICAgICAgICAgICAgICAgaWYgKGl0ZW1zLmxlbmd0aCA9PSBsaW1pdCAmJiBvYmplY3RzLmxlbmd0aCA+IGxpbWl0KSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHRzLmN1cnNvciA9IEJ1ZmZlci5mcm9tKG9iamVjdHNbbGltaXRdLmlkKS50b1N0cmluZygnYmFzZTY0JylcbiAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAvLyBJZiB0aGVyZSBhcmUgbm8gbW9yZSBlbnRyaWVzIGluIHRoZSBuZXh0IHNldCwgd2UgZGVmYXVsdCB0aGUgY3Vyc29yXG4gICAgICAgICAgICAgICAgICAvLyB0byBlbXB0eSBzdHJpbmdcbiAgICAgICAgICAgICAgICAgIHJlc3VsdHMuY3Vyc29yID0gJydcbiAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgcmVzdWx0cy5pdGVtcyA9IGl0ZW1zXG4gICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAvLyBXZSBoYXZlIGEgY3Vyc29yIGFuZCBjb250aW51ZSBmcm9tIHdoZW5jZSB3ZSBsZWZ0IG9mZlxuICAgICAgICAgICAgICAgY3Vyc29yID0gQnVmZmVyLmZyb20oY3Vyc29yLCAnYmFzZTY0JykudG9TdHJpbmcoJ2FzY2lpJylcblxuICAgICAgICAgICAgICAgbGV0IGluZGV4ID0gb2JqZWN0cy5maW5kSW5kZXgobyA9PiBvLmlkID09PSBjdXJzb3IpXG5cbiAgICAgICAgICAgICAgIGlmIChpbmRleCA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgIC8vIFdlIGdldCBoZXJlIHdoZW4gdGhlIG9iamVjdCB0aGF0J3MgbmV4dCBoYXMgYmVlbiBkZWxldGVkXG4gICAgICAgICAgICAgICAgICAvLyByZXR1cm4gZWFybHlcbiAgICAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICBsZXQgbmV4dEluZGV4ID0gaW5kZXggKyBsaW1pdFxuICAgICAgICAgICAgICAgcmVzdWx0cy5pdGVtcyA9IG9iamVjdHMuc2xpY2UoaW5kZXgsIG5leHRJbmRleClcblxuICAgICAgICAgICAgICAgaWYgKG9iamVjdHMubGVuZ3RoID4gbmV4dEluZGV4KSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHRzLmN1cnNvciA9IEJ1ZmZlci5mcm9tKG9iamVjdHNbbmV4dEluZGV4XS5pZCkudG9TdHJpbmcoJ2Jhc2U2NCcpXG4gICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlcmUgYXJlIG5vIG1vcmUgZW50cmllcyBpbiB0aGUgbmV4dCBzZXQsIHdlIGRlZmF1bHQgdGhlIGN1cnNvclxuICAgICAgICAgICAgICAgICAgLy8gdG8gZW1wdHkgc3RyaW5nXG4gICAgICAgICAgICAgICAgICByZXN1bHRzLmN1cnNvciA9ICcnXG4gICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgIH0pXG4gICAgICAgICAuY29tbWl0KClcblxuICAgICAgcmV0dXJuIHJlc3VsdHNcbiAgIH1cblxuICAgYXN5bmMgZGVsZXRlT2JqZWN0PFQgZXh0ZW5kcyBTdGFja09iamVjdD4obW9kZWw6IElNb2RlbCwgb2JqOiBUKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICBhd2FpdCB0aGlzLnJmYy5jcmVhdGUobmV3IE9iamVjdERlbGV0ZUV2ZW50KG1vZGVsLCBvYmopKVxuICAgICAgICAgLmZ1bGZpbGwoYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlLmRlbGV0ZU9iamVjdChtb2RlbCwgb2JqKVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFjay5lbWl0KEV2ZW50U2V0Lk9iamVjdERlbGV0ZWQsIGV2ZW50KVxuICAgICAgICAgfSlcbiAgICAgICAgIC5jb21taXQoKVxuICAgfVxuXG4gICBhc3luYyBnZXRPYmplY3Q8VCBleHRlbmRzIFN0YWNrT2JqZWN0Pihtb2RlbDogSU1vZGVsLCBpZDogc3RyaW5nKTogUHJvbWlzZTxUIHwgdW5kZWZpbmVkPiB7XG4gICAgICBsZXQgb2JqZWN0OiBUIHwgdW5kZWZpbmVkXG5cbiAgICAgIGF3YWl0IHRoaXMucmZjLmNyZWF0ZShuZXcgR2V0T2JqZWN0RXZlbnQobW9kZWwsIGlkKSlcbiAgICAgICAgIC5mdWxmaWxsKGFzeW5jIChldmVudCkgPT4ge1xuICAgICAgICAgICAgbGV0IGNhc3QgPSBldmVudCBhcyBHZXRPYmplY3RFdmVudDxUPlxuXG4gICAgICAgICAgICBpZiAoY2FzdC5vYmplY3QgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgb2JqZWN0ID0gY2FzdC5leGlzdHMgPT09IEV4aXN0U3RhdGUuRG9lc05vdEV4aXN0ID9cbiAgICAgICAgICAgICAgICAgIHVuZGVmaW5lZCA6XG4gICAgICAgICAgICAgICAgICB0aGlzLmNhY2hlLmdldE9iamVjdChtb2RlbCwgaWQpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgLy8gV2UgZ2V0IGEgc2VyaWFsaXplZCB2ZXJzaW9uIG9mIHRoZSBPYmplY3RcbiAgICAgICAgICAgICAgIGxldCBzZXJpYWxpemVkID0gYXdhaXQgUHJveHlPYmplY3QuZnJvbVN0b3JlZChtb2RlbCwgY2FzdC5vYmplY3QsIHRoaXMuY29udGV4dC5zZXJpYWxpemVyKVxuICAgICAgICAgICAgICAgdGhpcy5jYWNoZS5zYXZlT2JqZWN0KG1vZGVsLCBzZXJpYWxpemVkKVxuXG4gICAgICAgICAgICAgICAvL0B0cy1pZ25vcmVcbiAgICAgICAgICAgICAgIG9iamVjdCA9IHNlcmlhbGl6ZWQgYXMgVFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YWNrLmVtaXQoRXZlbnRTZXQuR2V0T2JqZWN0LCBldmVudClcbiAgICAgICAgIH0pXG4gICAgICAgICAuY29tbWl0KClcblxuICAgICAgcmV0dXJuIG9iamVjdFxuICAgfVxuXG4gICBhc3luYyBoYXNJZChpZDogc3RyaW5nLCBtb2RlbDogSU1vZGVsKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICBsZXQgaGFzSWQgPSBmYWxzZVxuXG4gICAgICBhd2FpdCB0aGlzLnJmYy5jcmVhdGUobmV3IEhhc0lkRXZlbnQoaWQsIG1vZGVsKSlcbiAgICAgICAgIC5mdWxmaWxsKGFzeW5jIChldmVudCkgPT4ge1xuICAgICAgICAgICAgbGV0IGNhc3QgPSBldmVudCBhcyBIYXNJZEV2ZW50XG5cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc3RhY2suZW1pdChFdmVudFNldC5IYXNJZCwgZXZlbnQpXG5cbiAgICAgICAgICAgIGlmIChjYXN0Lmhhc0lkKSB7XG4gICAgICAgICAgICAgICBoYXNJZCA9IHRydWVcbiAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBIYXMgaXQgYSBwbHVnaW4gYXR0ZW1wdGVkIHRvIHNldCBpdD9cbiAgICAgICAgICAgIGlmIChjYXN0LmF0dGVtcHRlZFNldCkge1xuICAgICAgICAgICAgICAgLy8gSWYgc28sIHdlIGNhbiB0cnVzdCB0aGF0IGFuIGV4dGVybmFsIHN5c3RlbSBkb2Vzbid0IGhhdmUgaXRcbiAgICAgICAgICAgICAgIGhhc0lkID0gZmFsc2VcbiAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBJZiBubyBleHRlcm5hbCBzeXN0ZW0gYXR0ZW1wdGVkIHRvIHNldCBpdCwgZG8gd2UgaGF2ZSBpdCBjYWNoZWQ/XG4gICAgICAgICAgICBoYXNJZCA9IHRoaXMuY2FjaGUuaGFzSWQoaWQpXG5cbiAgICAgICAgIH0pXG4gICAgICAgICAuY29tbWl0KClcblxuICAgICAgcmV0dXJuIGhhc0lkXG4gICB9XG5cbiAgIGFzeW5jIHN0b3JlUXVlcnlPYmplY3Q8VD4oaGFuZGxlcjogQXBwbHlTdG9yZUNvbnRleHRIYW5kbGVyPFQ+KTogUHJvbWlzZTxUIHwgdW5kZWZpbmVkPiB7XG4gICAgICBsZXQgcmVzdWx0OiBUIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkXG5cbiAgICAgIGF3YWl0IHRoaXMucmZjLmNyZWF0ZShuZXcgR2V0U3RvcmVDb250ZXh0RXZlbnQoKSlcbiAgICAgICAgIC5mdWxmaWxsKGFzeW5jIChldmVudCkgPT4ge1xuICAgICAgICAgICAgbGV0IGdldFN0b3JlQ29udGV4dCA9IGV2ZW50IGFzIEdldFN0b3JlQ29udGV4dEV2ZW50XG5cbiAgICAgICAgICAgIHJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZ2V0U3RvcmVDb250ZXh0LmNvbnRleHRzKVxuICAgICAgICAgfSlcbiAgICAgICAgIC5jb21taXQoKVxuXG4gICAgICByZXR1cm4gcmVzdWx0XG4gICB9XG5cbiAgIC8qKlxuICAgICogVXBkYXRlcyBhbiBhbHJlYWR5IGV4aXN0aW5nIG9iamVjdCB3aXRoIHRoZSBsYXRlc3QgZnJvbSB0aGUgc3RvcmVkIHZlcnNpb24uXG4gICAgKiBUaGlzIG1ldGhvZCBpcyBpbnRlbmRlZCB0byBiZSB1c2VkIG9uIGxvbmcgbGl2ZWQgb2JqZWN0cyB3aGVyZSB3ZSB3YW50IHRoZW1cbiAgICAqIHRvIGJlIHVwZGF0ZWQgbG9jYWxseSwgYW5kIG5vdCBzYXZlZC5cbiAgICAqIFxuICAgICogQHBhcmFtIG1vZGVsIFRoZSBNb2RlbFxuICAgICogQHBhcmFtIG9iaiBUaGUgT2JqZWN0XG4gICAgKiBAcGFyYW0gb25VcGRhdGUgRnVuY3Rpb24gdG8gdXBkYXRlIHRoZSBPYmplY3QgYmFzZWQgb24gdGhlIGxhdGVzdCB2ZXJzaW9uXG4gICAgKi9cbiAgIGFzeW5jIHVwZGF0ZU9iamVjdDxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG1vZGVsOiBJTW9kZWwsIG9iajogVCwgb25VcGRhdGU6IFVwZGF0ZU9iamVjdEhhbmRsZXI8VD4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIGF3YWl0IHRoaXMucmZjLmNyZWF0ZShuZXcgT2JqZWN0VXBkYXRlRXZlbnQ8VD4obW9kZWwsIG9iaiwgUHJveHlPYmplY3QudW53cmFwKG9iaikpKVxuICAgICAgICAgLmZ1bGZpbGwoYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBsZXQgY2FzdCA9IGV2ZW50IGFzIE9iamVjdFVwZGF0ZUV2ZW50PFQ+XG5cbiAgICAgICAgICAgIGxldCB1cGRhdGVkID0gY2FzdC51cGRhdGVkXG5cbiAgICAgICAgICAgIGF3YWl0IG9uVXBkYXRlKHVwZGF0ZWQsIGNhc3QuZXhpc3RzKVxuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YWNrLmVtaXQoRXZlbnRTZXQuT2JqZWN0VXBkYXRlZCwgZXZlbnQpXG4gICAgICAgICB9KVxuICAgICAgICAgLmNvbW1pdCgpXG4gICB9XG59Il19