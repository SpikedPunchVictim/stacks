"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FsPlugin = void 0;
const path = require("path");
const stacks_1 = require("@spikedpunch/stacks");
const fs = require("fs-extra");
/**
 * File system plugin for Stacks
 *
 * Notes:
 *    * GetMany cursor points to the next file in a sorted list
 */
class FsPlugin {
    constructor(baseDir, options) {
        this.baseDir = baseDir;
        this.name = 'stacks-fs';
        // TODO: Normalize baseDir (~, .., etc)
        this.options = options || {};
    }
    /*
 export enum EventSet {
    Bootstrap = 'bootstrap',
    GetManyObjects = 'get-many-objects',
    GetModel = 'get-model',
    GetObject = 'get-object',
    HasId = 'has-id',
    ModelCreated = 'model-created',
    ModelDeleted = 'model-deleted',
    ModelUpdated = 'model-updated',
    ObjectCreated = 'object-created',
    ObjectDeleted = 'object-deleted',
    ObjectUpdated = 'object-updated',
    ObjectSaved = 'object-saved'
 }
    */
    async setup(stack, router) {
        await fs.ensureDir(this.baseDir);
        //-------------------------------------------------------------------------------------------
        router.on(stacks_1.EventSet.Bootstrap, async (event) => {
            for (let model of stack.get.models()) {
                await this.setupModel(model);
            }
        });
        //-------------------------------------------------------------------------------------------
        router.on(stacks_1.EventSet.GetManyObjects, async (event) => {
            let modelDir = this.getModelDir(event.model.name);
            let reqCursor = event.options.cursor || '';
            let reqCount = event.options.limit == null ? 100 : event.options.limit;
            let files = await fs.readdir(modelDir);
            files.sort();
            let cursor = '';
            let startIndex = 0;
            let requestedFiles = new Array();
            // The cursor becomes the next file one in the sorted list
            if (reqCursor !== '') {
                let names = files.map(f => path.parse(f).name);
                let decodedCursor = Buffer.from(reqCursor, 'base64').toString('ascii');
                let found = names.findIndex(decodedCursor);
                if (found < 0) {
                    found = 0;
                    event.wasCursorFound = false;
                }
                else {
                    startIndex = found;
                }
            }
            let endIndex = Math.min((files.length - startIndex), reqCount);
            requestedFiles = files.slice(startIndex, endIndex);
            if (endIndex < (files.length - 1)) {
                let parsed = path.parse(path.join(this.baseDir, files[endIndex]));
                cursor = parsed.name;
            }
            else {
                cursor = '';
            }
            let objects = new Array();
            for (let file of requestedFiles) {
                objects.push(await fs.readJson(path.join(modelDir, file)));
            }
            event.results = {
                cursor: cursor === '' ? '' : Buffer.from(cursor).toString('base64'),
                items: objects
            };
        });
        //-------------------------------------------------------------------------------------------
        router.on(stacks_1.EventSet.ObjectSaved, async (event) => {
            let modelDir = this.getModelDir(event.model.name);
            await fs.ensureDir(modelDir);
            await fs.writeJson(path.join(modelDir, `${event.serialize.id}.json`), event.serialize.toJs());
        });
        //-------------------------------------------------------------------------------------------
        router.on(stacks_1.EventSet.GetObject, async (event) => {
            let objectPath = this.getObjectPath(event.model.id, event.id);
            try {
                let obj = await fs.readJson(objectPath);
                event.object = obj;
            }
            catch (err) {
                throw new Error(`Failed to retrieve Object ${event.id}. Reason ${err}`);
            }
        });
        //-------------------------------------------------------------------------------------------
        router.on(stacks_1.EventSet.ObjectDeleted, async (event) => {
            let objectPath = this.getObjectPath(event.model.id, event.object.id);
            try {
                await fs.remove(objectPath);
            }
            catch (err) {
                throw new Error(`Failed to delete an Object ${event.object.id}. Reason ${err}`);
            }
        });
        //-------------------------------------------------------------------------------------------
        router.on(stacks_1.EventSet.ObjectUpdated, async (event) => {
            let objectPath = this.getObjectPath(event.model.id, event.object.id);
            console.log(objectPath);
            let exists = await fs.access(objectPath);
            if (exists) {
                event.exists = stacks_1.ExistState.Exists;
                // try {
                //    await fs.remove(objectPath)
                //    await fs.writeJson(objectPath, event.object)
                //    event.object = obj
                // } catch(err) {
                // }
            }
            // try {
            //    await fs.remove(objectPath)
            // } catch(err) {
            //    throw new Error(`Failed to delete an Object ${event.object.id}. Reason ${err}`)
            // }
        });
    }
    getModelDir(modelName) {
        return path.join(this.baseDir, modelName);
    }
    getObjectPath(modelName, objectId) {
        let modelDir = this.getModelDir(modelName);
        return path.join(modelDir, `${objectId}.json`);
    }
    async setupModel(model) {
        let modelDir = this.getModelDir(model.name);
        await fs.ensureDir(modelDir);
    }
}
exports.FsPlugin = FsPlugin;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsNkJBQTRCO0FBQzVCLGdEQWM0QjtBQUU1QiwrQkFBOEI7QUFNOUI7Ozs7O0dBS0c7QUFDSCxNQUFhLFFBQVE7SUFJbEIsWUFBcUIsT0FBZSxFQUFFLE9BQWtCO1FBQW5DLFlBQU8sR0FBUCxPQUFPLENBQVE7UUFIM0IsU0FBSSxHQUFXLFdBQVcsQ0FBQTtRQUloQyx1Q0FBdUM7UUFDdkMsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLElBQUksRUFBRSxDQUFBO0lBQy9CLENBQUM7SUFHRDs7Ozs7Ozs7Ozs7Ozs7O01BZUU7SUFDRixLQUFLLENBQUMsS0FBSyxDQUFDLEtBQWEsRUFBRSxNQUFvQjtRQUM1QyxNQUFNLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBRWhDLDZGQUE2RjtRQUM3RixNQUFNLENBQUMsRUFBRSxDQUFpQixpQkFBUSxDQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsS0FBcUIsRUFBRSxFQUFFO1lBQzNFLEtBQUssSUFBSSxLQUFLLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsRUFBRTtnQkFDbkMsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFBO2FBQzlCO1FBQ0osQ0FBQyxDQUFDLENBQUE7UUFFRiw2RkFBNkY7UUFDN0YsTUFBTSxDQUFDLEVBQUUsQ0FBbUMsaUJBQVEsQ0FBQyxjQUFjLEVBQUUsS0FBSyxFQUFFLEtBQXVDLEVBQUUsRUFBRTtZQUNwSCxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7WUFDakQsSUFBSSxTQUFTLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFBO1lBQzFDLElBQUksUUFB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LENBQUMsSUFBSSxDQUFDLENBQUE7UUFDM0MsTUFBTSxFQUFFLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0lBQy9CLENBQUM7Q0FTSDtBQXBLRCw0QkFvS0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQge1xuICAgQm9vdHN0cmFwRXZlbnQsXG4gICBFdmVudFNldCxcbiAgIEV4aXN0U3RhdGUsXG4gICBHZXRPYmplY3RFdmVudCxcbiAgIElQbHVnaW4sXG4gICBJU3RhY2ssXG4gICBJRXZlbnRSb3V0ZXIsXG4gICBTYXZlT2JqZWN0RXZlbnQsXG4gICBTdGFja09iamVjdCxcbiAgIEdldE1hbnlPYmplY3RzRXZlbnQsXG4gICBJTW9kZWwsXG4gICBEZWxldGVPYmplY3RFdmVudCxcbiAgIFVwZGF0ZU9iamVjdEV2ZW50XG59IGZyb20gJ0BzcGlrZWRwdW5jaC9zdGFja3MnXG5cbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJ1xuXG5leHBvcnQgdHlwZSBGc09wdGlvbnMgPSB7XG5cbn1cblxuLyoqXG4gKiBGaWxlIHN5c3RlbSBwbHVnaW4gZm9yIFN0YWNrc1xuICogXG4gKiBOb3RlczpcbiAqICAgICogR2V0TWFueSBjdXJzb3IgcG9pbnRzIHRvIHRoZSBuZXh0IGZpbGUgaW4gYSBzb3J0ZWQgbGlzdFxuICovXG5leHBvcnQgY2xhc3MgRnNQbHVnaW4gaW1wbGVtZW50cyBJUGx1Z2luIHtcbiAgIHJlYWRvbmx5IG5hbWU6IHN0cmluZyA9ICdzdGFja3MtZnMnXG4gICByZWFkb25seSBvcHRpb25zOiBGc09wdGlvbnNcblxuICAgY29uc3RydWN0b3IocmVhZG9ubHkgYmFzZURpcjogc3RyaW5nLCBvcHRpb25zOiBGc09wdGlvbnMpIHtcbiAgICAgIC8vIFRPRE86IE5vcm1hbGl6ZSBiYXNlRGlyICh+LCAuLiwgZXRjKVxuICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucyB8fCB7fVxuICAgfVxuXG5cbiAgIC8qXG5leHBvcnQgZW51bSBFdmVudFNldCB7XG4gICBCb290c3RyYXAgPSAnYm9vdHN0cmFwJyxcbiAgIEdldE1hbnlPYmplY3RzID0gJ2dldC1tYW55LW9iamVjdHMnLFxuICAgR2V0TW9kZWwgPSAnZ2V0LW1vZGVsJyxcbiAgIEdldE9iamVjdCA9ICdnZXQtb2JqZWN0JyxcbiAgIEhhc0lkID0gJ2hhcy1pZCcsXG4gICBNb2RlbENyZWF0ZWQgPSAnbW9kZWwtY3JlYXRlZCcsXG4gICBNb2RlbERlbGV0ZWQgPSAnbW9kZWwtZGVsZXRlZCcsXG4gICBNb2RlbFVwZGF0ZWQgPSAnbW9kZWwtdXBkYXRlZCcsXG4gICBPYmplY3RDcmVhdGVkID0gJ29iamVjdC1jcmVhdGVkJyxcbiAgIE9iamVjdERlbGV0ZWQgPSAnb2JqZWN0LWRlbGV0ZWQnLFxuICAgT2JqZWN0VXBkYXRlZCA9ICdvYmplY3QtdXBkYXRlZCcsXG4gICBPYmplY3RTYXZlZCA9ICdvYmplY3Qtc2F2ZWQnXG59XG4gICAqL1xuICAgYXN5bmMgc2V0dXAoc3RhY2s6IElTdGFjaywgcm91dGVyOiBJRXZlbnRSb3V0ZXIpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIGF3YWl0IGZzLmVuc3VyZURpcih0aGlzLmJhc2VEaXIpXG5cbiAgICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgcm91dGVyLm9uPEJvb3RzdHJhcEV2ZW50PihFdmVudFNldC5Cb290c3RyYXAsIGFzeW5jIChldmVudDogQm9vdHN0cmFwRXZlbnQpID0+IHtcbiAgICAgICAgIGZvciAobGV0IG1vZGVsIG9mIHN0YWNrLmdldC5tb2RlbHMoKSkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5zZXR1cE1vZGVsKG1vZGVsKVxuICAgICAgICAgfVxuICAgICAgfSlcblxuICAgICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICByb3V0ZXIub248R2V0TWFueU9iamVjdHNFdmVudDxTdGFja09iamVjdD4+KEV2ZW50U2V0LkdldE1hbnlPYmplY3RzLCBhc3luYyAoZXZlbnQ6IEdldE1hbnlPYmplY3RzRXZlbnQ8U3RhY2tPYmplY3Q+KSA9PiB7XG4gICAgICAgICBsZXQgbW9kZWxEaXIgPSB0aGlzLmdldE1vZGVsRGlyKGV2ZW50Lm1vZGVsLm5hbWUpXG4gICAgICAgICBsZXQgcmVxQ3Vyc29yID0gZXZlbnQub3B0aW9ucy5jdXJzb3IgfHwgJydcbiAgICAgICAgIGxldCByZXFDb3VudCA9IGV2ZW50Lm9wdGlvbnMubGltaXQgPT0gbnVsbCA/IDEwMCA6IGV2ZW50Lm9wdGlvbnMubGltaXRcblxuICAgICAgICAgbGV0IGZpbGVzID0gYXdhaXQgZnMucmVhZGRpcihtb2RlbERpcilcbiAgICAgICAgIGZpbGVzLnNvcnQoKVxuXG4gICAgICAgICBsZXQgY3Vyc29yID0gJydcbiAgICAgICAgIGxldCBzdGFydEluZGV4ID0gMFxuICAgICAgICAgbGV0IHJlcXVlc3RlZEZpbGVzID0gbmV3IEFycmF5PHN0cmluZz4oKVxuXG4gICAgICAgICAvLyBUaGUgY3Vyc29yIGJlY29tZXMgdGhlIG5leHQgZmlsZSBvbmUgaW4gdGhlIHNvcnRlZCBsaXN0XG4gICAgICAgICBpZiAocmVxQ3Vyc29yICE9PSAnJykge1xuICAgICAgICAgICAgbGV0IG5hbWVzID0gZmlsZXMubWFwKGYgPT4gcGF0aC5wYXJzZShmKS5uYW1lKVxuXG4gICAgICAgICAgICBsZXQgZGVjb2RlZEN1cnNvciA9IEJ1ZmZlci5mcm9tKHJlcUN1cnNvciwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCdhc2NpaScpICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgZm91bmQgPSBuYW1lcy5maW5kSW5kZXgoZGVjb2RlZEN1cnNvcilcblxuICAgICAgICAgICAgaWYgKGZvdW5kIDwgMCkge1xuICAgICAgICAgICAgICAgZm91bmQgPSAwXG4gICAgICAgICAgICAgICBldmVudC53YXNDdXJzb3JGb3VuZCA9IGZhbHNlXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgc3RhcnRJbmRleCA9IGZvdW5kXG4gICAgICAgICAgICB9XG4gICAgICAgICB9XG5cbiAgICAgICAgIGxldCBlbmRJbmRleCA9IE1hdGgubWluKChmaWxlcy5sZW5ndGggLSBzdGFydEluZGV4KSwgcmVxQ291bnQpXG5cbiAgICAgICAgIHJlcXVlc3RlZEZpbGVzID0gZmlsZXMuc2xpY2Uoc3RhcnRJbmRleCwgZW5kSW5kZXgpXG5cbiAgICAgICAgIGlmIChlbmRJbmRleCA8IChmaWxlcy5sZW5ndGggLSAxKSkge1xuICAgICAgICAgICAgbGV0IHBhcnNlZCA9IHBhdGgucGFyc2UocGF0aC5qb2luKHRoaXMuYmFzZURpciwgZmlsZXNbZW5kSW5kZXhdKSlcbiAgICAgICAgICAgIGN1cnNvciA9IHBhcnNlZC5uYW1lXG4gICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY3Vyc29yID0gJydcbiAgICAgICAgIH1cblxuICAgICAgICAgbGV0IG9iamVjdHMgPSBuZXcgQXJyYXk8U3RhY2tPYmplY3Q+KClcblxuICAgICAgICAgZm9yIChsZXQgZmlsZSBvZiByZXF1ZXN0ZWRGaWxlcykge1xuICAgICAgICAgICAgb2JqZWN0cy5wdXNoKGF3YWl0IGZzLnJlYWRKc29uKHBhdGguam9pbihtb2RlbERpciwgZmlsZSkpKVxuICAgICAgICAgfVxuXG4gICAgICAgICBldmVudC5yZXN1bHRzID0ge1xuICAgICAgICAgICAgY3Vyc29yOiBjdXJzb3IgPT09ICcnID8gJycgOiBCdWZmZXIuZnJvbShjdXJzb3IpLnRvU3RyaW5nKCdiYXNlNjQnKSxcbiAgICAgICAgICAgIGl0ZW1zOiBvYmplY3RzXG4gICAgICAgICB9XG4gICAgICB9KVxuXG4gICAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgIHJvdXRlci5vbjxTYXZlT2JqZWN0RXZlbnQ8U3RhY2tPYmplY3Q+PihFdmVudFNldC5PYmplY3RTYXZlZCwgYXN5bmMgKGV2ZW50OiBTYXZlT2JqZWN0RXZlbnQ8U3RhY2tPYmplY3Q+KSA9PiB7XG4gICAgICAgICBsZXQgbW9kZWxEaXIgPSB0aGlzLmdldE1vZGVsRGlyKGV2ZW50Lm1vZGVsLm5hbWUpXG4gICAgICAgICBhd2FpdCBmcy5lbnN1cmVEaXIobW9kZWxEaXIpXG4gICAgICAgICBhd2FpdCBmcy53cml0ZUpzb24ocGF0aC5qb2luKG1vZGVsRGlyLCBgJHtldmVudC5zZXJpYWxpemUuaWR9Lmpzb25gKSwgZXZlbnQuc2VyaWFsaXplLnRvSnMoKSlcbiAgICAgIH0pXG5cbiAgICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgcm91dGVyLm9uPEdldE9iamVjdEV2ZW50PFN0YWNrT2JqZWN0Pj4oRXZlbnRTZXQuR2V0T2JqZWN0LCBhc3luYyAoZXZlbnQ6IEdldE9iamVjdEV2ZW50PFN0YWNrT2JqZWN0PikgPT4ge1xuICAgICAgICAgbGV0IG9iamVjdFBhdGggPSB0aGlzLmdldE9iamVjdFBhdGgoZXZlbnQubW9kZWwuaWQsIGV2ZW50LmlkKVxuXG4gICAgICAgICB0cnkge1xuICAgICAgICAgICAgbGV0IG9iaiA9IGF3YWl0IGZzLnJlYWRKc29uKG9iamVjdFBhdGgpXG4gICAgICAgICAgICBldmVudC5vYmplY3QgPSBvYmpcbiAgICAgICAgIH0gY2F0Y2goZXJyKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byByZXRyaWV2ZSBPYmplY3QgJHtldmVudC5pZH0uIFJlYXNvbiAke2Vycn1gKVxuICAgICAgICAgfVxuICAgICAgfSlcblxuICAgICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICByb3V0ZXIub248RGVsZXRlT2JqZWN0RXZlbnQ8U3RhY2tPYmplY3Q+PihFdmVudFNldC5PYmplY3REZWxldGVkLCBhc3luYyAoZXZlbnQ6IERlbGV0ZU9iamVjdEV2ZW50PFN0YWNrT2JqZWN0PikgPT4ge1xuICAgICAgICAgbGV0IG9iamVjdFBhdGggPSB0aGlzLmdldE9iamVjdFBhdGgoZXZlbnQubW9kZWwuaWQsIGV2ZW50Lm9iamVjdC5pZClcblxuICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IGZzLnJlbW92ZShvYmplY3RQYXRoKVxuICAgICAgICAgfSBjYXRjaChlcnIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGRlbGV0ZSBhbiBPYmplY3QgJHtldmVudC5vYmplY3QuaWR9LiBSZWFzb24gJHtlcnJ9YClcbiAgICAgICAgIH1cbiAgICAgIH0pXG5cbiAgICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgcm91dGVyLm9uPFVwZGF0ZU9iamVjdEV2ZW50PFN0YWNrT2JqZWN0Pj4oRXZlbnRTZXQuT2JqZWN0VXBkYXRlZCwgYXN5bmMgKGV2ZW50OiBVcGRhdGVPYmplY3RFdmVudDxTdGFja09iamVjdD4pID0+IHtcbiAgICAgICAgIGxldCBvYmplY3RQYXRoID0gdGhpcy5nZXRPYmplY3RQYXRoKGV2ZW50Lm1vZGVsLmlkLCBldmVudC5vYmplY3QuaWQpXG4gICAgICAgICBjb25zb2xlLmxvZyhvYmplY3RQYXRoKVxuICAgICAgICAgbGV0IGV4aXN0cyA9IGF3YWl0IGZzLmFjY2VzcyhvYmplY3RQYXRoKVxuXG4gICAgICAgICBpZihleGlzdHMpIHtcbiAgICAgICAgICAgIGV2ZW50LmV4aXN0cyA9IEV4aXN0U3RhdGUuRXhpc3RzXG5cbiAgICAgICAgICAgIC8vIHRyeSB7XG4gICAgICAgICAgICAvLyAgICBhd2FpdCBmcy5yZW1vdmUob2JqZWN0UGF0aClcbiAgICAgICAgICAgIC8vICAgIGF3YWl0IGZzLndyaXRlSnNvbihvYmplY3RQYXRoLCBldmVudC5vYmplY3QpXG4gICAgICAgICAgICAvLyAgICBldmVudC5vYmplY3QgPSBvYmpcbiAgICAgICAgICAgIC8vIH0gY2F0Y2goZXJyKSB7XG5cbiAgICAgICAgICAgIC8vIH1cbiAgICAgICAgIH1cblxuICAgICAgICAgLy8gdHJ5IHtcbiAgICAgICAgIC8vICAgIGF3YWl0IGZzLnJlbW92ZShvYmplY3RQYXRoKVxuICAgICAgICAgLy8gfSBjYXRjaChlcnIpIHtcbiAgICAgICAgIC8vICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGRlbGV0ZSBhbiBPYmplY3QgJHtldmVudC5vYmplY3QuaWR9LiBSZWFzb24gJHtlcnJ9YClcbiAgICAgICAgIC8vIH1cbiAgICAgIH0pXG4gICB9XG5cbiAgIHByaXZhdGUgZ2V0TW9kZWxEaXIobW9kZWxOYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgcmV0dXJuIHBhdGguam9pbih0aGlzLmJhc2VEaXIsIG1vZGVsTmFtZSlcbiAgIH1cblxuICAgcHJpdmF0ZSBnZXRPYmplY3RQYXRoKG1vZGVsTmFtZTogc3RyaW5nLCBvYmplY3RJZDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgIGxldCBtb2RlbERpciA9IHRoaXMuZ2V0TW9kZWxEaXIobW9kZWxOYW1lKVxuICAgICAgcmV0dXJuIHBhdGguam9pbihtb2RlbERpciwgYCR7b2JqZWN0SWR9Lmpzb25gKVxuICAgfVxuXG4gICBwcml2YXRlIGFzeW5jIHNldHVwTW9kZWwobW9kZWw6IElNb2RlbCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgbGV0IG1vZGVsRGlyID0gdGhpcy5nZXRNb2RlbERpcihtb2RlbC5uYW1lKVxuICAgICAgYXdhaXQgZnMuZW5zdXJlRGlyKG1vZGVsRGlyKVxuICAgfVxuXG4gICAvLyBwcml2YXRlIGFzeW5jIHdyaXRlT2JqZWN0KG1vZGVsOiBJTW9kZWwsIG9iamVjdDogU3RhY2tPYmplY3QpOiBQcm9taXNlPHZvaWQ+IHtcbiAgIC8vICAgIGxldCBvYmogPSB7fVxuXG4gICAvLyAgICBmb3IobGV0IG1lbWJlciBvZiBtb2RlbC5tZW1iZXJzKSB7XG4gICAvLyAgICAgICBtZW1iZXIudmFsdWUuXG4gICAvLyAgICB9XG4gICAvLyB9XG59Il19