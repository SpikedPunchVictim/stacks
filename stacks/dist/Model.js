"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Model = exports.NoOpModel = void 0;
const MemberCollection_1 = require("./collections/MemberCollection");
const Type_1 = require("./values/Type");
const UidKeeper_1 = require("./UidKeeper");
class NoOpModel {
    constructor() {
        this.id = 'empty-object-not-a-valid-model';
        this.name = 'empty-object-not-a-valid-model';
        this.symbols = new Array();
        this.members = new MemberCollection_1.NoOpMemberCollection();
    }
    append(obj) {
        throw new Error(`Not Implemented`);
    }
    save(object) {
        throw new Error(`Not Implemented`);
    }
    create(obj) {
        {
            throw new Error(`Not Implemented`);
        }
    }
    delete(object) {
        throw new Error(`Not Implemented`);
    }
    get(id) {
        throw new Error(`Not Implemented`);
    }
    getAll() {
        throw new Error(`Not Implemented`);
    }
    getMany(req) {
        throw new Error(`Not Implemented`);
    }
    toJs() {
        throw new Error(`Not Implemented`);
    }
    validate(obj) {
        throw new Error(`Not Implemented`);
    }
}
exports.NoOpModel = NoOpModel;
class Model {
    constructor(name, context) {
        this._id = UidKeeper_1.UidKeeper.IdNotSet;
        this.name = name;
        this.context = context;
        this.members = new MemberCollection_1.MemberCollection(this, this.context);
        this.symbols = new Array();
    }
    get id() {
        return this._id;
    }
    static get NoOp() {
        return this._noop;
    }
    get orchestrator() {
        return this.context.orchestrator;
    }
    get serializer() {
        return this.context.serializer;
    }
    static async create(name, context) {
        let model = new Model(name, context);
        model.setId(await context.uid.generate(model));
        return model;
    }
    static isModel(obj) {
        for (let key of Object.keys(Model.NoOp)) {
            if (obj[key] == null ||
                (typeof obj[key] !== typeof Model.NoOp[key])) {
                return false;
            }
        }
        return true;
    }
    /**
     * Determines if an Object is a Model. If it is, then it will return a
     * cast value of the Model, otherwise undefined.
     *
     * @param obj The Object to cast
     * @returns
     */
    static asModel(obj) {
        if (Model.isModel(obj)) {
            return obj;
        }
        return undefined;
    }
    async append(obj) {
        return this.members.append(obj);
    }
    async save(obj) {
        await this.orchestrator.saveObject(this, obj);
    }
    async create(params = {}) {
        return await this.orchestrator.createObject(this, params);
    }
    async delete(object) {
        await this.orchestrator.deleteObject(this, object);
    }
    async get(id) {
        return await this.orchestrator.getObject(this, id);
    }
    async getAll() {
        let cursor = '';
        let results = new Array();
        do {
            let paged = await this.orchestrator.getManyObjects(this, { cursor });
            results.push(...paged.items);
            cursor = paged.cursor;
        } while (cursor !== '');
        return results;
    }
    async getMany(req = {}) {
        return this.orchestrator.getManyObjects(this, req);
    }
    async toJs() {
        let result = {
            id: this.id
        };
        for (let member of this.members) {
            result[member.name] = await this.serializer.toJs(member.value);
        }
        //@ts-ignore
        return result;
    }
    async validate(obj) {
        let report = new Type_1.ValidationReport();
        for (let key of Object.keys(obj)) {
            let member = this.members.get(key);
            if (member === undefined) {
                report.addError(new Error(`Object contains a key that does not exist in the Model: ${key}`));
                continue;
            }
            let result = await member.type.validate(obj[key]);
            if (result.success === false && result.error) {
                report.addError(result.error);
            }
        }
        return report;
    }
    setId(id) {
        this._id = id;
    }
}
exports.Model = Model;
Model._noop = new NoOpModel();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW9kZWwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvTW9kZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUVBQTJHO0FBRzNHLHdDQUFpRDtBQUtqRCwyQ0FBd0M7QUErRnhDLE1BQWEsU0FBUztJQU9uQjtRQU5TLE9BQUUsR0FBVyxnQ0FBZ0MsQ0FBQTtRQUM3QyxTQUFJLEdBQVcsZ0NBQWdDLENBQUE7UUFHL0MsWUFBTyxHQUFrQixJQUFJLEtBQUssRUFBZSxDQUFBO1FBR3ZELElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSx1Q0FBb0IsRUFBRSxDQUFBO0lBQzVDLENBQUM7SUFFRCxNQUFNLENBQUMsR0FBc0I7UUFDMUIsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO0lBQ3JDLENBQUM7SUFFRCxJQUFJLENBQXdCLE1BQVM7UUFDbEMsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO0lBQ3JDLENBQUM7SUFFRCxNQUFNLENBQXdCLEdBQXdCO1FBQ25EO1lBQ0csTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO1NBQ3BDO0lBQ0osQ0FBQztJQUVELE1BQU0sQ0FBd0IsTUFBUztRQUNwQyxNQUFNLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUE7SUFDckMsQ0FBQztJQUVELEdBQUcsQ0FBd0IsRUFBVTtRQUNsQyxNQUFNLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUE7SUFDckMsQ0FBQztJQUVELE1BQU07UUFDSCxNQUFNLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUE7SUFDckMsQ0FBQztJQUVELE9BQU8sQ0FBd0IsR0FBaUI7UUFDN0MsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO0lBQ3JDLENBQUM7SUFFRCxJQUFJO1FBQ0QsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO0lBQ3JDLENB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Q0FBQyxFQUFFO1lBQy9CLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBRWxDLElBQUksTUFBTSxLQUFLLFNBQVMsRUFBRTtnQkFDdkIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEtBQUssQ0FBQywyREFBMkQsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFBO2dCQUM1RixTQUFRO2FBQ1Y7WUFFRCxJQUFJLE1BQU0sR0FBRyxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO1lBRWpELElBQUksTUFBTSxDQUFDLE9BQU8sS0FBSyxLQUFLLElBQUksTUFBTSxDQUFDLEtBQUssRUFBRTtnQkFDM0MsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUE7YUFDL0I7U0FDSDtRQUVELE9BQU8sTUFBTSxDQUFBO0lBQ2hCLENBQUM7SUFFTyxLQUFLLENBQUMsRUFBVTtRQUNyQixJQUFJLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQTtJQUNoQixDQUFDOztBQTVJSixzQkE2SUM7QUF0SGlCLFdBQUssR0FBVyxJQUFJLFNBQVMsRUFBRSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSU1lbWJlckNvbGxlY3Rpb24sIE1lbWJlckNvbGxlY3Rpb24sIE5vT3BNZW1iZXJDb2xsZWN0aW9uIH0gZnJvbSBcIi4vY29sbGVjdGlvbnMvTWVtYmVyQ29sbGVjdGlvblwiO1xuaW1wb3J0IHsgSU9yY2hlc3RyYXRvciB9IGZyb20gXCIuL29yY2hlc3RyYXRvci9PcmNoZXN0cmF0b3JcIjtcbmltcG9ydCB7IElTdGFja0NvbnRleHQgfSBmcm9tIFwiLi9zdGFjay9TdGFja0NvbnRleHRcIjtcbmltcG9ydCB7IFZhbGlkYXRpb25SZXBvcnQgfSBmcm9tIFwiLi92YWx1ZXMvVHlwZVwiO1xuaW1wb3J0IHsgQ3JlYXRlVmFsdWVIYW5kbGVyLCBWYWx1ZUNyZWF0ZVBhcmFtcyB9IGZyb20gXCIuL3ZhbHVlcy9WYWx1ZVNvdXJjZVwiO1xuaW1wb3J0IHsgU3RhY2tPYmplY3QgfSBmcm9tIFwiLi9TdGFja09iamVjdFwiO1xuaW1wb3J0IHsgSVZhbHVlU2VyaWFsaXplciB9IGZyb20gXCIuL3NlcmlhbGl6ZS9WYWx1ZVNlcmlhbGl6ZXJcIjtcbmltcG9ydCB7IE1lbWJlckluZm8gfSBmcm9tIFwiLi9NZW1iZXJcIjtcbmltcG9ydCB7IFVpZEtlZXBlciB9IGZyb20gXCIuL1VpZEtlZXBlclwiO1xuXG4vKipcbiAqIFRoZSBwYXJhbWV0ZXJzIHVzZWQgdG8gY3JlYXRlIGFuIE9iamVjdCBiYXNlZCBvbiBhIE1vZGVsLlxuICogVGhlIGFkZGl0aW9uYWwgT2JqZWN0Q3JlYXRlUGFyYW1zIG9uIHRoZSB0eXBlIHN1cHBvcnRzIG5lc3RlZFxuICogdmFsdWVzLlxuICovXG5leHBvcnQgdHlwZSBPYmplY3RDcmVhdGVQYXJhbXMgPSB7XG4gICBba2V5OiBzdHJpbmddOiBWYWx1ZUNyZWF0ZVBhcmFtcyB8IE9iamVjdENyZWF0ZVBhcmFtc1xufVxuXG5leHBvcnQgdHlwZSBNb2RlbENyZWF0ZVBhcmFtcyA9IHtcbiAgIFtrZXk6IHN0cmluZ106IHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4gfCBhbnlbXSB8IENyZWF0ZVZhbHVlSGFuZGxlciB8IE1lbWJlckluZm9cbn1cblxuZXhwb3J0IHR5cGUgU3ltYm9sRW50cnkgPSB7XG4gICBuYW1lOiBzdHJpbmcsXG4gICB2YWx1ZTogYW55XG59XG5cbmV4cG9ydCB0eXBlIFBhZ2VSZXNwb25zZTxUPiA9IHtcbiAgIGN1cnNvcjogc3RyaW5nXG4gICBpdGVtczogVFtdXG59XG5cbmV4cG9ydCB0eXBlIFBhZ2VSZXF1ZXN0ID0ge1xuICAgY3Vyc29yPzogc3RyaW5nXG4gICBsaW1pdD86IG51bWJlclxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElNb2RlbCB7XG4gICByZWFkb25seSBpZDogc3RyaW5nXG4gICByZWFkb25seSBuYW1lOiBzdHJpbmdcblxuICAgcmVhZG9ubHkgbWVtYmVyczogSU1lbWJlckNvbGxlY3Rpb25cbiAgIHJlYWRvbmx5IHN5bWJvbHM6IFN5bWJvbEVudHJ5W11cblxuICAgLyoqXG4gICAgKiBBcHBlbmRzIGFkZGl0aW9uYWwgTWVtYmVycyB0byB0aGUgTW9kZWxcbiAgICAqIFxuICAgICogQHBhcmFtIG9iaiBUaGUgYWRkaXRpb25hbCBtZW1iZXJzIHRvIGFkZFxuICAgICovXG4gICBhcHBlbmQob2JqOiBNb2RlbENyZWF0ZVBhcmFtcyk6IFByb21pc2U8dm9pZD5cblxuICAgLyoqXG4gICAgKiBTc3ZlcyB0aGUgb2JqZWN0IHRvIHN0b3JhZ2VcbiAgICAqIFxuICAgICogQHBhcmFtIG9iamVjdCBUaGUgb2JqZWN0IHRvIGNvbW1pdFxuICAgICovXG4gICBzYXZlPFQgZXh0ZW5kcyBTdGFja09iamVjdD4ob2JqZWN0OiBUKTogUHJvbWlzZTx2b2lkPlxuXG4gICAvKipcbiAgICAqIENyZWF0ZXMgYSBuZXcgT2JqZWN0IGJhc2VkIG9uIHRoaXMgTW9kZWxcbiAgICAqL1xuICAgY3JlYXRlPFQgZXh0ZW5kcyBTdGFja09iamVjdD4ob2JqPzogT2JqZWN0Q3JlYXRlUGFyYW1zKTogUHJvbWlzZTxUPlxuXG4gICAvKipcbiAgICAqIERlbGV0ZXMgYW4gb2JqZWN0IGRlcml2ZWQgZnJvbSB0aGlzIE1vZGVsXG4gICAgKiBcbiAgICAqIEBwYXJhbSBvYmplY3QgVGhlIG9iamVjdCB0byBkZWxldGVcbiAgICAqL1xuICAgZGVsZXRlPFQgZXh0ZW5kcyBTdGFja09iamVjdD4ob2JqZWN0OiBUKTogUHJvbWlzZTx2b2lkPlxuXG4gICAvKipcbiAgICAqIFJldHJpZXZlcyBhbiBpbnN0YW5jZSBieSBJRFxuICAgICogXG4gICAgKiBAcGFyYW0gaWQgVGhlIElEIG9mIHRoZSBpbnN0YW5jZVxuICAgICovXG4gICBnZXQ8VCBleHRlbmRzIFN0YWNrT2JqZWN0PihpZDogc3RyaW5nKTogUHJvbWlzZTxUIHwgdW5kZWZpbmVkPlxuXG4gICAvKipcbiAgICAqIEdldHMgYWxsIE9iamVjdHMgYmFzZWQgb24gYSBNb2RlbFxuICAgICovXG4gICBnZXRBbGw8VCBleHRlbmRzIFN0YWNrT2JqZWN0PigpOiBQcm9taXNlPFRbXT5cblxuICAgLyoqXG4gICAgKiBHZXRzIG1hbnkgT2JqZWN0c1xuICAgICogXG4gICAgKiBAcGFyYW0gcmVxIFRoZSBQYWdlZFJlcXVlc3QgXG4gICAgKi9cbiAgIGdldE1hbnk8VCBleHRlbmRzIFN0YWNrT2JqZWN0PihyZXE/OiBQYWdlUmVxdWVzdCk6IFByb21pc2U8UGFnZVJlc3BvbnNlPFQ+PlxuXG4gICAvKipcbiAgICAqIENvbnZlcnRzIHRoZSBNb2RlbCBpbnRvIGEgSlMgb2JqZWN0XG4gICAgKi9cbiAgIHRvSnM8VD4oKTogUHJvbWlzZTxUPlxuXG4gICAvKipcbiAgICAqIFZhbGlkYXRlcyBhbiBPYmplY3QgYWdhaW5zdCB0aGUgTW9kZWwncyBzY2hlbWFcbiAgICAqIFxuICAgICogQHBhcmFtIG9iaiBUaGUgT2JqZWN0IHRvIHZhbGlkYXRlXG4gICAgKi9cbiAgIHZhbGlkYXRlPFQ+KG9iajogVCk6IFByb21pc2U8VmFsaWRhdGlvblJlcG9ydD5cbn1cblxuZXhwb3J0IGNsYXNzIE5vT3BNb2RlbCBpbXBsZW1lbnRzIElNb2RlbCB7XG4gICByZWFkb25seSBpZDogc3RyaW5nID0gJ2VtcHR5LW9iamVjdC1ub3QtYS12YWxpZC1tb2RlbCdcbiAgIHJlYWRvbmx5IG5hbWU6IHN0cmluZyA9ICdlbXB0eS1vYmplY3Qtbm90LWEtdmFsaWQtbW9kZWwnXG5cbiAgIHJlYWRvbmx5IG1lbWJlcnM6IElNZW1iZXJDb2xsZWN0aW9uXG4gICByZWFkb25seSBzeW1ib2xzOiBTeW1ib2xFbnRyeVtdID0gbmV3IEFycmF5PFN5bWJvbEVudHJ5PigpXG5cbiAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgdGhpcy5tZW1iZXJzID0gbmV3IE5vT3BNZW1iZXJDb2xsZWN0aW9uKClcbiAgIH1cblxuICAgYXBwZW5kKG9iajogTW9kZWxDcmVhdGVQYXJhbXMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTm90IEltcGxlbWVudGVkYClcbiAgIH1cblxuICAgc2F2ZTxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG9iamVjdDogVCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBOb3QgSW1wbGVtZW50ZWRgKVxuICAgfVxuXG4gICBjcmVhdGU8VCBleHRlbmRzIFN0YWNrT2JqZWN0PihvYmo/OiBPYmplY3RDcmVhdGVQYXJhbXMpOiBQcm9taXNlPFQ+IHtcbiAgICAgIHtcbiAgICAgICAgIHRocm93IG5ldyBFcnJvcihgTm90IEltcGxlbWVudGVkYClcbiAgICAgIH1cbiAgIH1cblxuICAgZGVsZXRlPFQgZXh0ZW5kcyBTdGFja09iamVjdD4ob2JqZWN0OiBUKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vdCBJbXBsZW1lbnRlZGApXG4gICB9XG5cbiAgIGdldDxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KGlkOiBzdHJpbmcpOiBQcm9taXNlPFQgfCB1bmRlZmluZWQ+IHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTm90IEltcGxlbWVudGVkYClcbiAgIH1cblxuICAgZ2V0QWxsPFQgZXh0ZW5kcyBTdGFja09iamVjdD4oKTogUHJvbWlzZTxUW10+IHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTm90IEltcGxlbWVudGVkYClcbiAgIH1cblxuICAgZ2V0TWFueTxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KHJlcT86IFBhZ2VSZXF1ZXN0KTogUHJvbWlzZTxQYWdlUmVzcG9uc2U8VD4+IHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTm90IEltcGxlbWVudGVkYClcbiAgIH1cblxuICAgdG9KczxUPigpOiBQcm9taXNlPFQ+IHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTm90IEltcGxlbWVudGVkYClcbiAgIH1cblxuICAgdmFsaWRhdGU8VD4ob2JqOiBUKTogUHJvbWlzZTxWYWxpZGF0aW9uUmVwb3J0PiB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vdCBJbXBsZW1lbnRlZGApXG4gICB9XG59XG5cbmV4cG9ydCBjbGFzcyBNb2RlbCBpbXBsZW1lbnRzIElNb2RlbCB7XG4gICBnZXQgaWQoKTogc3RyaW5nIHtcbiAgICAgIHJldHVybiB0aGlzLl9pZFxuICAgfVxuXG4gICByZWFkb25seSBuYW1lOiBzdHJpbmdcbiAgIHJlYWRvbmx5IGNvbnRleHQ6IElTdGFja0NvbnRleHRcblxuICAgcmVhZG9ubHkgbWVtYmVyczogSU1lbWJlckNvbGxlY3Rpb25cbiAgIHJlYWRvbmx5IHN5bWJvbHM6IFN5bWJvbEVudHJ5W11cblxuICAgc3RhdGljIGdldCBOb09wKCk6IElNb2RlbCB7XG4gICAgICByZXR1cm4gdGhpcy5fbm9vcFxuICAgfVxuXG4gICBwcml2YXRlIGdldCBvcmNoZXN0cmF0b3IoKTogSU9yY2hlc3RyYXRvciB7XG4gICAgICByZXR1cm4gdGhpcy5jb250ZXh0Lm9yY2hlc3RyYXRvclxuICAgfVxuXG4gICBwcml2YXRlIGdldCBzZXJpYWxpemVyKCk6IElWYWx1ZVNlcmlhbGl6ZXIge1xuICAgICAgcmV0dXJuIHRoaXMuY29udGV4dC5zZXJpYWxpemVyXG4gICB9XG5cbiAgIHByaXZhdGUgc3RhdGljIF9ub29wOiBJTW9kZWwgPSBuZXcgTm9PcE1vZGVsKClcbiAgIHByaXZhdGUgX2lkOiBzdHJpbmcgPSBVaWRLZWVwZXIuSWROb3RTZXRcblxuICAgcHJpdmF0ZSBjb25zdHJ1Y3RvcihuYW1lOiBzdHJpbmcsIGNvbnRleHQ6IElTdGFja0NvbnRleHQpIHtcbiAgICAgIHRoaXMubmFtZSA9IG5hbWVcbiAgICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHRcblxuICAgICAgdGhpcy5tZW1iZXJzID0gbmV3IE1lbWJlckNvbGxlY3Rpb24odGhpcywgdGhpcy5jb250ZXh0KVxuICAgICAgdGhpcy5zeW1ib2xzID0gbmV3IEFycmF5PFN5bWJvbEVudHJ5PigpXG4gICB9XG5cbiAgIHN0YXRpYyBhc3luYyBjcmVhdGUobmFtZTogc3RyaW5nLCBjb250ZXh0OiBJU3RhY2tDb250ZXh0KTogUHJvbWlzZTxJTW9kZWw+IHtcbiAgICAgIGxldCBtb2RlbCA9IG5ldyBNb2RlbChuYW1lLCBjb250ZXh0KVxuICAgICAgbW9kZWwuc2V0SWQoYXdhaXQgY29udGV4dC51aWQuZ2VuZXJhdGUobW9kZWwpKVxuICAgICAgcmV0dXJuIG1vZGVsXG4gICB9XG5cbiAgIHN0YXRpYyBpc01vZGVsKG9iajogYW55KTogYm9vbGVhbiB7XG4gICAgICBmb3IgKGxldCBrZXkgb2YgT2JqZWN0LmtleXMoTW9kZWwuTm9PcCkpIHtcbiAgICAgICAgIGlmIChvYmpba2V5XSA9PSBudWxsIHx8XG4gICAgICAgICAgICAodHlwZW9mIG9ialtrZXldICE9PSB0eXBlb2YgTW9kZWwuTm9PcFtrZXldKVxuICAgICAgICAgKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRydWVcbiAgIH1cblxuICAgLyoqXG4gICAgKiBEZXRlcm1pbmVzIGlmIGFuIE9iamVjdCBpcyBhIE1vZGVsLiBJZiBpdCBpcywgdGhlbiBpdCB3aWxsIHJldHVybiBhXG4gICAgKiBjYXN0IHZhbHVlIG9mIHRoZSBNb2RlbCwgb3RoZXJ3aXNlIHVuZGVmaW5lZC5cbiAgICAqIFxuICAgICogQHBhcmFtIG9iaiBUaGUgT2JqZWN0IHRvIGNhc3RcbiAgICAqIEByZXR1cm5zIFxuICAgICovXG4gICBzdGF0aWMgYXNNb2RlbChvYmo6IGFueSk6IElNb2RlbCB8IHVuZGVmaW5lZCB7XG4gICAgICBpZihNb2RlbC5pc01vZGVsKG9iaikpIHtcbiAgICAgICAgIHJldHVybiBvYmogYXMgSU1vZGVsXG4gICAgICB9XG5cbiAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgIH1cblxuICAgYXN5bmMgYXBwZW5kKG9iajogTW9kZWxDcmVhdGVQYXJhbXMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIHJldHVybiB0aGlzLm1lbWJlcnMuYXBwZW5kKG9iailcbiAgIH1cblxuICAgYXN5bmMgc2F2ZTxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG9iajogVCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgYXdhaXQgdGhpcy5vcmNoZXN0cmF0b3Iuc2F2ZU9iamVjdDxUPih0aGlzLCBvYmopXG4gICB9XG5cbiAgIGFzeW5jIGNyZWF0ZTxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KHBhcmFtczogT2JqZWN0Q3JlYXRlUGFyYW1zID0ge30pOiBQcm9taXNlPFQ+IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLm9yY2hlc3RyYXRvci5jcmVhdGVPYmplY3QodGhpcywgcGFyYW1zKVxuICAgfVxuXG4gICBhc3luYyBkZWxldGU8VCBleHRlbmRzIFN0YWNrT2JqZWN0PihvYmplY3Q6IFQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIGF3YWl0IHRoaXMub3JjaGVzdHJhdG9yLmRlbGV0ZU9iamVjdDxUPih0aGlzLCBvYmplY3QpXG4gICB9XG5cbiAgIGFzeW5jIGdldDxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KGlkOiBzdHJpbmcpOiBQcm9taXNlPFQgfCB1bmRlZmluZWQ+IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLm9yY2hlc3RyYXRvci5nZXRPYmplY3Q8VD4odGhpcywgaWQpXG4gICB9XG5cbiAgIGFzeW5jIGdldEFsbDxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KCk6IFByb21pc2U8VFtdPiB7XG4gICAgICBsZXQgY3Vyc29yID0gJydcbiAgICAgIGxldCByZXN1bHRzID0gbmV3IEFycmF5PFQ+KClcblxuICAgICAgZG8ge1xuICAgICAgICAgbGV0IHBhZ2VkID0gYXdhaXQgdGhpcy5vcmNoZXN0cmF0b3IuZ2V0TWFueU9iamVjdHM8VD4odGhpcywgeyBjdXJzb3IgfSlcbiAgICAgICAgIHJlc3VsdHMucHVzaCguLi5wYWdlZC5pdGVtcylcbiAgICAgICAgIGN1cnNvciA9IHBhZ2VkLmN1cnNvclxuICAgICAgfSB3aGlsZSAoY3Vyc29yICE9PSAnJylcblxuICAgICAgcmV0dXJuIHJlc3VsdHNcbiAgIH1cblxuICAgYXN5bmMgZ2V0TWFueTxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KHJlcTogUGFnZVJlcXVlc3QgPSB7fSk6IFByb21pc2U8UGFnZVJlc3BvbnNlPFQ+PiB7XG4gICAgICByZXR1cm4gdGhpcy5vcmNoZXN0cmF0b3IuZ2V0TWFueU9iamVjdHM8VD4odGhpcywgcmVxKVxuICAgfVxuXG4gICBhc3luYyB0b0pzPFQ+KCk6IFByb21pc2U8VD4ge1xuICAgICAgbGV0IHJlc3VsdCA9IHtcbiAgICAgICAgIGlkOiB0aGlzLmlkXG4gICAgICB9XG5cbiAgICAgIGZvciAobGV0IG1lbWJlciBvZiB0aGlzLm1lbWJlcnMpIHtcbiAgICAgICAgIHJlc3VsdFttZW1iZXIubmFtZV0gPSBhd2FpdCB0aGlzLnNlcmlhbGl6ZXIudG9KcyhtZW1iZXIudmFsdWUpXG4gICAgICB9XG5cbiAgICAgIC8vQHRzLWlnbm9yZVxuICAgICAgcmV0dXJuIHJlc3VsdCBhcyBUXG4gICB9XG5cbiAgIGFzeW5jIHZhbGlkYXRlPFQ+KG9iajogVCk6IFByb21pc2U8VmFsaWRhdGlvblJlcG9ydD4ge1xuICAgICAgbGV0IHJlcG9ydCA9IG5ldyBWYWxpZGF0aW9uUmVwb3J0KClcblxuICAgICAgZm9yIChsZXQga2V5IG9mIE9iamVjdC5rZXlzKG9iaikpIHtcbiAgICAgICAgIGxldCBtZW1iZXIgPSB0aGlzLm1lbWJlcnMuZ2V0KGtleSlcblxuICAgICAgICAgaWYgKG1lbWJlciA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICByZXBvcnQuYWRkRXJyb3IobmV3IEVycm9yKGBPYmplY3QgY29udGFpbnMgYSBrZXkgdGhhdCBkb2VzIG5vdCBleGlzdCBpbiB0aGUgTW9kZWw6ICR7a2V5fWApKVxuICAgICAgICAgICAgY29udGludWVcbiAgICAgICAgIH1cblxuICAgICAgICAgbGV0IHJlc3VsdCA9IGF3YWl0IG1lbWJlci50eXBlLnZhbGlkYXRlKG9ialtrZXldKVxuXG4gICAgICAgICBpZiAocmVzdWx0LnN1Y2Nlc3MgPT09IGZhbHNlICYmIHJlc3VsdC5lcnJvcikge1xuICAgICAgICAgICAgcmVwb3J0LmFkZEVycm9yKHJlc3VsdC5lcnJvcilcbiAgICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJlcG9ydFxuICAgfVxuXG4gICBwcml2YXRlIHNldElkKGlkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgIHRoaXMuX2lkID0gaWRcbiAgIH1cbn0iXX0=