"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Orchestrator = void 0;
const events_1 = require("../events");
const SaveObjectEvent_1 = require("../events/SaveObjectEvent");
const DeleteObjectEvent_1 = require("../events/DeleteObjectEvent");
const Event_1 = require("../events/Event");
const GetManyObjectsEvent_1 = require("../events/GetManyObjectsEvent");
const HasIdEvent_1 = require("../events/HasIdEvent");
const UpdateObjectEvent_1 = require("../events/UpdateObjectEvent");
const ProxyObject_1 = require("../ProxyObject");
const UidKeeper_1 = require("../UidKeeper");
class Orchestrator {
    constructor(context) {
        this.context = context;
    }
    get cache() {
        return this.context.cache;
    }
    get rfc() {
        return this.context.rfc;
    }
    get serializer() {
        return this.context.serializer;
    }
    get stack() {
        return this.context.stack;
    }
    get uid() {
        return this.context.uid;
    }
    /**
     *
     * @param model The Model
     * @param obj The Object to save. Note that this is really a Proxy'd SerializableObject
     */
    async saveObject(model, obj) {
        if (obj.id === UidKeeper_1.UidKeeper.IdNotSet) {
            obj.id = await this.uid.generate();
        }
        let validations = await model.validate(obj);
        if (!validations.success) {
            throw new Error(`Cannot Save Object with ID ${obj.id} since it fails validation. Reason: ${validations.results.map(r => r.error)}`);
        }
        //@ts-ignore
        let serialized = ProxyObject_1.ProxyObject.unwrap(obj);
        await this.rfc.create(new SaveObjectEvent_1.SaveObjectEvent(model, obj, serialized))
            .fulfill(async (event) => {
            this.cache.saveObject(model, obj);
            await this.stack.emit(Event_1.EventSet.SaveObject, event);
        })
            .commit();
    }
    async getManyObjects(model, options = {}) {
        let results = {
            cursor: '',
            items: new Array()
        };
        await this.rfc.create(new GetManyObjectsEvent_1.GetManyObjectsEvent(model, options))
            .fulfill(async (event) => {
            let cast = event;
            await this.stack.emit(Event_1.EventSet.GetManyObjects, cast);
            if (cast.results !== undefined) {
                results = cast.results;
                return;
            }
            let objects = this.cache.getObjects(model);
            if (objects.length == 0) {
                return;
            }
            let cursor = options.cursor || '';
            let limit = options.limit || 100;
            // Sort by ID. The resulting paged set is not perfect, and will have
            // holes when new entries are added in between queries.
            objects.sort((a, b) => {
                let aId = a.id.toLowerCase();
                let bId = b.id.toLowerCase();
                return (aId < bId) ? -1 : (aId > bId) ? 1 : 0;
            });
            if (cursor === '') {
                // For an empty cursor we start from the beginning
                let items = objects.slice(0, Math.min(objects.length - 1, limit));
                if (items.length == limit && objects.length > limit) {
                    results.cursor = Buffer.from(objects[limit + 1].id).toString('base64');
                }
                else {
                    // If there are no more entries in thenext set, we default the cursor
                    // to empty string
                    results.cursor = '';
                }
                results.items = items;
                return;
            }
            else {
                // We have a cursor and continue from whence we left off
                cursor = Buffer.from(cursor, 'base64').toString('ascii');
                let index = objects.findIndex(o => o.id === cursor);
                if (index === -1) {
                    // We get here when the object that's next has been deleted
                    // return early
                    return;
                }
                results.items = objects.slice(index, Math.min(objects.length - 1, limit));
                if (results.items.length == limit && objects.length > limit) {
                    results.cursor = Buffer.from(objects[limit + 1].id).toString('base64');
                }
                else {
                    // If there are no more entries in thenext set, we default the cursor
                    // to empty string
                    results.cursor = '';
                }
                return;
            }
            return;
        })
            .commit();
        return results;
    }
    async deleteObject(model, obj) {
        await this.rfc.create(new DeleteObjectEvent_1.DeleteObjectEvent(model, obj))
            .fulfill(async (event) => {
            this.cache.deleteObject(model, obj);
            await this.stack.emit(Event_1.EventSet.ObjectDeleted, event);
        })
            .commit();
    }
    async getObject(model, id) {
        let object;
        await this.rfc.create(new events_1.GetObjectEvent(model, id))
            .fulfill(async (event) => {
            let cast = event;
            if (cast.object === undefined) {
                object = cast.exists === Event_1.ExistState.DoesNotExist ?
                    undefined :
                    this.cache.getObject(model, id);
            }
            else {
                // We get a serialized version of the Object
                let serialized = await ProxyObject_1.ProxyObject.fromStored(model, cast.object, this.context.serializer);
                this.cache.saveObject(model, serialized);
                //@ts-ignore
                object = serialized;
            }
            await this.stack.emit(Event_1.EventSet.GetObject, event);
        })
            .commit();
        return object;
    }
    async hasId(id) {
        let hasId = false;
        await this.rfc.create(new HasIdEvent_1.HasIdEvent(id))
            .fulfill(async (event) => {
            let cast = event;
            await this.stack.emit(Event_1.EventSet.HasId, event);
            if (cast.hasId) {
                hasId = true;
                return;
            }
            // Has it a plugin attempted to set it?
            if (cast.attemptedSet) {
                // If so, we can trust that an external system doesn't have it
                hasId = false;
                return;
            }
            // If no external system attempted to set it, do we have it cached?
            hasId = this.cache.hasId(id);
        })
            .commit();
        return hasId;
    }
    async updateObject(model, obj, onUpdate) {
        await this.rfc.create(new UpdateObjectEvent_1.UpdateObjectEvent(model, obj))
            .fulfill(async (event) => {
            let cast = event;
            let updated = cast.updated;
            await onUpdate(updated, cast.exists);
            await this.stack.emit(Event_1.EventSet.ObjectUpdated, event);
        })
            .commit();
    }
}
exports.Orchestrator = Orchestrator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT3JjaGVzdHJhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL29yY2hlc3RyYXRvci9PcmNoZXN0cmF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBRUEsc0NBQTJDO0FBQzNDLCtEQUE0RDtBQUM1RCxtRUFBZ0U7QUFDaEUsMkNBQXVEO0FBQ3ZELHVFQUFvRTtBQUNwRSxxREFBa0Q7QUFFbEQsbUVBQWdFO0FBS2hFLGdEQUE2QztBQUM3Qyw0Q0FBcUQ7QUF3RHJELE1BQWEsWUFBWTtJQXFCdEIsWUFBcUIsT0FBc0I7UUFBdEIsWUFBTyxHQUFQLE9BQU8sQ0FBZTtJQUUzQyxDQUFDO0lBdEJELElBQUksS0FBSztRQUNOLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUE7SUFDNUIsQ0FBQztJQUVELElBQUksR0FBRztRQUNKLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUE7SUFDMUIsQ0FBQztJQUVELElBQUksVUFBVTtRQUNYLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUE7SUFDakMsQ0FBQztJQUVELElBQUksS0FBSztRQUNOLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUE7SUFDNUIsQ0FBQztJQUVELElBQUksR0FBRztRQUNKLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUE7SUFDMUIsQ0FBQztJQU1EOzs7O09BSUc7SUFDSCxLQUFLLENBQUMsVUFBVSxDQUF3QixLQUFhLEVBQUUsR0FBTTtRQUMxRCxJQUFHLEdBQUcsQ0FBQyxFQUFFLEtBQUsscUJBQVMsQ0FBQyxRQUFRLEVBQUU7WUFDL0IsR0FBRyxDQUFDLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUE7U0FDcEM7UUFFRCxJQUFJLFdBQVcsR0FBRyxNQUFNLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUE7UUFFM0MsSUFB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S0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBRS9CLENBQUMsQ0FBQzthQUNELE1BQU0sRUFBRSxDQUFBO1FBRVosT0FBTyxLQUFLLENBQUE7SUFDZixDQUFDO0lBRUQsS0FBSyxDQUFDLFlBQVksQ0FBd0IsS0FBYSxFQUFFLEdBQU0sRUFBRSxRQUFnQztRQUM5RixNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUkscUNBQWlCLENBQUksS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO2FBQ3ZELE9BQU8sQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDdEIsSUFBSSxJQUFJLEdBQUcsS0FBNkIsQ0FBQTtZQUV4QyxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFBO1lBRTFCLE1BQU0sUUFBUSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7WUFFcEMsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxnQkFBUSxDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUN2RCxDQUFDLENBQUM7YUFDRCxNQUFNLEVBQUUsQ0FBQTtJQUNmLENBQUM7Q0FDSDtBQW5ORCxvQ0FtTkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdGFja09iamVjdCB9IGZyb20gXCIuLi9TdGFja09iamVjdFwiO1xuaW1wb3J0IHsgSUNhY2hlIH0gZnJvbSBcIi4uL0NhY2hlXCI7XG5pbXBvcnQgeyBHZXRPYmplY3RFdmVudCB9IGZyb20gXCIuLi9ldmVudHNcIjtcbmltcG9ydCB7IFNhdmVPYmplY3RFdmVudCB9IGZyb20gXCIuLi9ldmVudHMvU2F2ZU9iamVjdEV2ZW50XCI7XG5pbXBvcnQgeyBEZWxldGVPYmplY3RFdmVudCB9IGZyb20gXCIuLi9ldmVudHMvRGVsZXRlT2JqZWN0RXZlbnRcIjtcbmltcG9ydCB7IEV2ZW50U2V0LCBFeGlzdFN0YXRlIH0gZnJvbSBcIi4uL2V2ZW50cy9FdmVudFwiO1xuaW1wb3J0IHsgR2V0TWFueU9iamVjdHNFdmVudCB9IGZyb20gXCIuLi9ldmVudHMvR2V0TWFueU9iamVjdHNFdmVudFwiO1xuaW1wb3J0IHsgSGFzSWRFdmVudCB9IGZyb20gXCIuLi9ldmVudHMvSGFzSWRFdmVudFwiO1xuaW1wb3J0IHsgSVJlcXVlc3RGb3JDaGFuZ2VTb3VyY2UgfSBmcm9tIFwiLi4vZXZlbnRzL1JlcXVlc3RGb3JDaGFuZ2VcIjtcbmltcG9ydCB7IFVwZGF0ZU9iamVjdEV2ZW50IH0gZnJvbSBcIi4uL2V2ZW50cy9VcGRhdGVPYmplY3RFdmVudFwiO1xuaW1wb3J0IHsgSU1vZGVsLCBQYWdlUmVxdWVzdCwgUGFnZVJlc3BvbnNlIH0gZnJvbSBcIi4uL01vZGVsXCI7XG5pbXBvcnQgeyBJU3RhY2sgfSBmcm9tIFwiLi4vc3RhY2svU3RhY2tcIjtcbmltcG9ydCB7IElTdGFja0NvbnRleHQgfSBmcm9tIFwiLi4vc3RhY2svU3RhY2tDb250ZXh0XCI7XG5pbXBvcnQgeyBVcGRhdGVPYmplY3RIYW5kbGVyIH0gZnJvbSBcIi4uL3N0YWNrL1N0YWNrVXBkYXRlXCI7XG5pbXBvcnQgeyBQcm94eU9iamVjdCB9IGZyb20gXCIuLi9Qcm94eU9iamVjdFwiO1xuaW1wb3J0IHsgSVVpZEtlZXBlciwgVWlkS2VlcGVyIH0gZnJvbSBcIi4uL1VpZEtlZXBlclwiO1xuaW1wb3J0IHsgSVZhbHVlU2VyaWFsaXplciB9IGZyb20gXCIuLi9zZXJpYWxpemUvVmFsdWVTZXJpYWxpemVyXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSU9yY2hlc3RyYXRvciB7XG4gICAvLyBUT0RPOiBBZGQ6IGNyZWF0ZU1vZGVsLCBkZWxldGVNb2RlbCAodGhlc2Ugc2hvdWxkIGFzc2lzdCBpbiBydW5uaW5nIHRlc3RzKVxuXG4gICAvKipcbiAgICAqIFNhdmVzIGFuIE9iamVjdCB0byB0aGUgYmFja2VuZC5cbiAgICAqIFxuICAgICogQHBhcmFtIG1vZGVsIFRoZSBNb2RlbFxuICAgICogQHBhcmFtIG9iaiBUaGUgT2JqZWN0IHRvIFNhdmVcbiAgICAqL1xuICAgc2F2ZU9iamVjdDxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG1vZGVsOiBJTW9kZWwsIG9iajogVCk6IFByb21pc2U8dm9pZD5cblxuICAgLyoqXG4gICAgKiBEZWxldGVzIGFuIE9iamVjdCBmcm9tIHRoZSBiYWNrZW5kXG4gICAgKiBcbiAgICAqIEBwYXJhbSBtb2RlbCBUaGUgTW9kZWxcbiAgICAqIEBwYXJhbSBvYmogVGhlIE9iamVjdCB0byBkZWxldGVcbiAgICAqL1xuICAgZGVsZXRlT2JqZWN0PFQgZXh0ZW5kcyBTdGFja09iamVjdD4obW9kZWw6IElNb2RlbCwgb2JqOiBUKTogUHJvbWlzZTx2b2lkPlxuXG4gICAvKipcbiAgICAqIFJldHJpZXZlcyBtYW55IG9iamVjdHMgaW4gYSBwYWdlZCBmYXNoaW9uLlxuICAgICogXG4gICAgKiBAcGFyYW0gbW9kZWwgVGhlIE1vZGVsIHJlcHJlc2VudGluZyB0aGUgT2JqZWN0c1xuICAgICogQHBhcmFtIG9wdGlvbnMgUGFnZVJlcXVlc3QgT3B0aW9uc1xuICAgICovXG4gICBnZXRNYW55T2JqZWN0czxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG1vZGVsOiBJTW9kZWwsIG9wdGlvbnM6IFBhZ2VSZXF1ZXN0KTogUHJvbWlzZTxQYWdlUmVzcG9uc2U8VD4+XG4gICBcbiAgIC8qKlxuICAgICogUmV0cmlldmVzIHRoZSBFZGl0IHZlcnNpb24gb2YgdGhlIE9iamVjdFxuICAgICogXG4gICAgKiBAcGFyYW0gbW9kZWwgVGhlIE1vZGVsIG9mIHRoZSBPYmplY3RcbiAgICAqIEBwYXJhbSBpZCBUaGUgT2JqZWN0J3MgSURcbiAgICAqL1xuICAgZ2V0T2JqZWN0PFQgZXh0ZW5kcyBTdGFja09iamVjdD4obW9kZWw6IElNb2RlbCwgaWQ6IHN0cmluZyk6IFByb21pc2U8VCB8IHVuZGVmaW5lZD5cblxuICAgLyoqXG4gICAgKiBEZXRlcm1pbmVzIGlmIGFuIElEIGlzIGFscmVhZHkgaW4gdXNlLlxuICAgICogXG4gICAgKiBAcGFyYW0gaWQgVGhlIElEIHRvIHRlc3RcbiAgICAqL1xuICAgaGFzSWQoaWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj5cbiAgIFxuICAgLyoqXG4gICAgKiBVcGRhdGVzIHRoZSB2YWx1ZXMgb2YgYW4gT2JqZWN0XG4gICAgKiBcbiAgICAqIEBwYXJhbSBtb2RlbCBUaGUgTW9kZWwgb2YgdGhlIE9iamVjdFxuICAgICogQHBhcmFtIG9iaiBUaGUgT2JqZWN0IHRvIHVwZGF0ZVxuICAgICogQHBhcmFtIG9uVXBkYXRlIEhhbmRsZXIgdGhhdCBpcyBjYWxsZWQgYWZ0ZXIgYW4gT2JqZWN0IGhhcyBiZWVuIHVwZGF0ZWRcbiAgICAqL1xuICAgdXBkYXRlT2JqZWN0PFQgZXh0ZW5kcyBTdGFja09iamVjdD4obW9kZWw6IElNb2RlbCwgb2JqOiBULCBvblVwZGF0ZTogVXBkYXRlT2JqZWN0SGFuZGxlcjxUPik6IFByb21pc2U8dm9pZD5cbn1cblxuXG5leHBvcnQgY2xhc3MgT3JjaGVzdHJhdG9yIGltcGxlbWVudHMgSU9yY2hlc3RyYXRvciB7XG4gICBnZXQgY2FjaGUoKTogSUNhY2hlIHtcbiAgICAgIHJldHVybiB0aGlzLmNvbnRleHQuY2FjaGVcbiAgIH1cblxuICAgZ2V0IHJmYygpOiBJUmVxdWVzdEZvckNoYW5nZVNvdXJjZSB7XG4gICAgICByZXR1cm4gdGhpcy5jb250ZXh0LnJmY1xuICAgfVxuXG4gICBnZXQgc2VyaWFsaXplcigpOiBJVmFsdWVTZXJpYWxpemVyIHtcbiAgICAgIHJldHVybiB0aGlzLmNvbnRleHQuc2VyaWFsaXplclxuICAgfVxuXG4gICBnZXQgc3RhY2soKTogSVN0YWNrIHtcbiAgICAgIHJldHVybiB0aGlzLmNvbnRleHQuc3RhY2tcbiAgIH1cblxuICAgZ2V0IHVpZCgpOiBJVWlkS2VlcGVyIHtcbiAgICAgIHJldHVybiB0aGlzLmNvbnRleHQudWlkXG4gICB9XG5cbiAgIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGNvbnRleHQ6IElTdGFja0NvbnRleHQpIHtcblxuICAgfVxuXG4gICAvKipcbiAgICAqIFxuICAgICogQHBhcmFtIG1vZGVsIFRoZSBNb2RlbFxuICAgICogQHBhcmFtIG9iaiBUaGUgT2JqZWN0IHRvIHNhdmUuIE5vdGUgdGhhdCB0aGlzIGlzIHJlYWxseSBhIFByb3h5J2QgU2VyaWFsaXphYmxlT2JqZWN0XG4gICAgKi9cbiAgIGFzeW5jIHNhdmVPYmplY3Q8VCBleHRlbmRzIFN0YWNrT2JqZWN0Pihtb2RlbDogSU1vZGVsLCBvYmo6IFQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIGlmKG9iai5pZCA9PT0gVWlkS2VlcGVyLklkTm90U2V0KSB7XG4gICAgICAgICBvYmouaWQgPSBhd2FpdCB0aGlzLnVpZC5nZW5lcmF0ZSgpXG4gICAgICB9XG4gICAgICBcbiAgICAgIGxldCB2YWxpZGF0aW9ucyA9IGF3YWl0IG1vZGVsLnZhbGlkYXRlKG9iailcblxuICAgICAgaWYgKCF2YWxpZGF0aW9ucy5zdWNjZXNzKSB7XG4gICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBTYXZlIE9iamVjdCB3aXRoIElEICR7b2JqLmlkfSBzaW5jZSBpdCBmYWlscyB2YWxpZGF0aW9uLiBSZWFzb246ICR7dmFsaWRhdGlvbnMucmVzdWx0cy5tYXAociA9PiByLmVycm9yKX1gKVxuICAgICAgfVxuXG4gICAgICAvL0B0cy1pZ25vcmVcbiAgICAgIGxldCBzZXJpYWxpemVkID0gUHJveHlPYmplY3QudW53cmFwKG9iailcblxuICAgICAgYXdhaXQgdGhpcy5yZmMuY3JlYXRlKG5ldyBTYXZlT2JqZWN0RXZlbnQ8VD4obW9kZWwsIG9iaiwgc2VyaWFsaXplZCkpXG4gICAgICAgICAuZnVsZmlsbChhc3luYyAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGUuc2F2ZU9iamVjdChtb2RlbCwgb2JqKVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFjay5lbWl0KEV2ZW50U2V0LlNhdmVPYmplY3QsIGV2ZW50KVxuICAgICAgICAgfSlcbiAgICAgICAgIC5jb21taXQoKVxuICAgfVxuXG4gICBhc3luYyBnZXRNYW55T2JqZWN0czxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG1vZGVsOiBJTW9kZWwsIG9wdGlvbnM6IFBhZ2VSZXF1ZXN0ID0ge30pOiBQcm9taXNlPFBhZ2VSZXNwb25zZTxUPj4ge1xuICAgICAgbGV0IHJlc3VsdHMgPSB7XG4gICAgICAgICBjdXJzb3I6ICcnLFxuICAgICAgICAgaXRlbXM6IG5ldyBBcnJheTxUPigpXG4gICAgICB9XG5cbiAgICAgIGF3YWl0IHRoaXMucmZjLmNyZWF0ZShuZXcgR2V0TWFueU9iamVjdHNFdmVudChtb2RlbCwgb3B0aW9ucykpXG4gICAgICAgICAuZnVsZmlsbChhc3luYyAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgIGxldCBjYXN0ID0gZXZlbnQgYXMgR2V0TWFueU9iamVjdHNFdmVudDxUPlxuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YWNrLmVtaXQoRXZlbnRTZXQuR2V0TWFueU9iamVjdHMsIGNhc3QpXG5cbiAgICAgICAgICAgIGlmIChjYXN0LnJlc3VsdHMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgcmVzdWx0cyA9IGNhc3QucmVzdWx0c1xuICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBvYmplY3RzID0gdGhpcy5jYWNoZS5nZXRPYmplY3RzPFQ+KG1vZGVsKVxuXG4gICAgICAgICAgICBpZiAob2JqZWN0cy5sZW5ndGggPT0gMCkge1xuICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBjdXJzb3IgPSBvcHRpb25zLmN1cnNvciB8fCAnJ1xuICAgICAgICAgICAgbGV0IGxpbWl0ID0gb3B0aW9ucy5saW1pdCB8fCAxMDBcblxuICAgICAgICAgICAgLy8gU29ydCBieSBJRC4gVGhlIHJlc3VsdGluZyBwYWdlZCBzZXQgaXMgbm90IHBlcmZlY3QsIGFuZCB3aWxsIGhhdmVcbiAgICAgICAgICAgIC8vIGhvbGVzIHdoZW4gbmV3IGVudHJpZXMgYXJlIGFkZGVkIGluIGJldHdlZW4gcXVlcmllcy5cbiAgICAgICAgICAgIG9iamVjdHMuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICAgICAgICAgbGV0IGFJZCA9IGEuaWQudG9Mb3dlckNhc2UoKVxuICAgICAgICAgICAgICAgbGV0IGJJZCA9IGIuaWQudG9Mb3dlckNhc2UoKVxuICAgICAgICAgICAgICAgcmV0dXJuIChhSWQgPCBiSWQpID8gLTEgOiAoYUlkID4gYklkKSA/IDEgOiAwXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICBpZiAoY3Vyc29yID09PSAnJykge1xuICAgICAgICAgICAgICAgLy8gRm9yIGFuIGVtcHR5IGN1cnNvciB3ZSBzdGFydCBmcm9tIHRoZSBiZWdpbm5pbmdcbiAgICAgICAgICAgICAgIGxldCBpdGVtcyA9IG9iamVjdHMuc2xpY2UoMCwgTWF0aC5taW4ob2JqZWN0cy5sZW5ndGggLSAxLCBsaW1pdCkpXG5cbiAgICAgICAgICAgICAgIGlmIChpdGVtcy5sZW5ndGggPT0gbGltaXQgJiYgb2JqZWN0cy5sZW5ndGggPiBsaW1pdCkge1xuICAgICAgICAgICAgICAgICAgcmVzdWx0cy5jdXJzb3IgPSBCdWZmZXIuZnJvbShvYmplY3RzW2xpbWl0ICsgMV0uaWQpLnRvU3RyaW5nKCdiYXNlNjQnKVxuICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIC8vIElmIHRoZXJlIGFyZSBubyBtb3JlIGVudHJpZXMgaW4gdGhlbmV4dCBzZXQsIHdlIGRlZmF1bHQgdGhlIGN1cnNvclxuICAgICAgICAgICAgICAgICAgLy8gdG8gZW1wdHkgc3RyaW5nXG4gICAgICAgICAgICAgICAgICByZXN1bHRzLmN1cnNvciA9ICcnXG4gICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgIHJlc3VsdHMuaXRlbXMgPSBpdGVtc1xuICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgLy8gV2UgaGF2ZSBhIGN1cnNvciBhbmQgY29udGludWUgZnJvbSB3aGVuY2Ugd2UgbGVmdCBvZmZcbiAgICAgICAgICAgICAgIGN1cnNvciA9IEJ1ZmZlci5mcm9tKGN1cnNvciwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCdhc2NpaScpXG5cbiAgICAgICAgICAgICAgIGxldCBpbmRleCA9IG9iamVjdHMuZmluZEluZGV4KG8gPT4gby5pZCA9PT0gY3Vyc29yKVxuXG4gICAgICAgICAgICAgICBpZiAoaW5kZXggPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAvLyBXZSBnZXQgaGVyZSB3aGVuIHRoZSBvYmplY3QgdGhhdCdzIG5leHQgaGFzIGJlZW4gZGVsZXRlZFxuICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuIGVhcmx5XG4gICAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgcmVzdWx0cy5pdGVtcyA9IG9iamVjdHMuc2xpY2UoaW5kZXgsIE1hdGgubWluKG9iamVjdHMubGVuZ3RoIC0gMSwgbGltaXQpKVxuXG4gICAgICAgICAgICAgICBpZiAocmVzdWx0cy5pdGVtcy5sZW5ndGggPT0gbGltaXQgJiYgb2JqZWN0cy5sZW5ndGggPiBsaW1pdCkge1xuICAgICAgICAgICAgICAgICAgcmVzdWx0cy5jdXJzb3IgPSBCdWZmZXIuZnJvbShvYmplY3RzW2xpbWl0ICsgMV0uaWQpLnRvU3RyaW5nKCdiYXNlNjQnKVxuICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIC8vIElmIHRoZXJlIGFyZSBubyBtb3JlIGVudHJpZXMgaW4gdGhlbmV4dCBzZXQsIHdlIGRlZmF1bHQgdGhlIGN1cnNvclxuICAgICAgICAgICAgICAgICAgLy8gdG8gZW1wdHkgc3RyaW5nXG4gICAgICAgICAgICAgICAgICByZXN1bHRzLmN1cnNvciA9ICcnXG4gICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgIH0pXG4gICAgICAgICAuY29tbWl0KClcblxuICAgICAgcmV0dXJuIHJlc3VsdHNcbiAgIH1cblxuICAgYXN5bmMgZGVsZXRlT2JqZWN0PFQgZXh0ZW5kcyBTdGFja09iamVjdD4obW9kZWw6IElNb2RlbCwgb2JqOiBUKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICBhd2FpdCB0aGlzLnJmYy5jcmVhdGUobmV3IERlbGV0ZU9iamVjdEV2ZW50KG1vZGVsLCBvYmopKVxuICAgICAgICAgLmZ1bGZpbGwoYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlLmRlbGV0ZU9iamVjdChtb2RlbCwgb2JqKVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFjay5lbWl0KEV2ZW50U2V0Lk9iamVjdERlbGV0ZWQsIGV2ZW50KVxuICAgICAgICAgfSlcbiAgICAgICAgIC5jb21taXQoKVxuICAgfVxuXG4gICBhc3luYyBnZXRPYmplY3Q8VCBleHRlbmRzIFN0YWNrT2JqZWN0Pihtb2RlbDogSU1vZGVsLCBpZDogc3RyaW5nKTogUHJvbWlzZTxUIHwgdW5kZWZpbmVkPiB7XG4gICAgICBsZXQgb2JqZWN0OiBUIHwgdW5kZWZpbmVkXG5cbiAgICAgIGF3YWl0IHRoaXMucmZjLmNyZWF0ZShuZXcgR2V0T2JqZWN0RXZlbnQobW9kZWwsIGlkKSlcbiAgICAgICAgIC5mdWxmaWxsKGFzeW5jIChldmVudCkgPT4ge1xuICAgICAgICAgICAgbGV0IGNhc3QgPSBldmVudCBhcyBHZXRPYmplY3RFdmVudDxUPlxuXG4gICAgICAgICAgICBpZiAoY2FzdC5vYmplY3QgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgb2JqZWN0ID0gY2FzdC5leGlzdHMgPT09IEV4aXN0U3RhdGUuRG9lc05vdEV4aXN0ID9cbiAgICAgICAgICAgICAgICAgIHVuZGVmaW5lZCA6XG4gICAgICAgICAgICAgICAgICB0aGlzLmNhY2hlLmdldE9iamVjdChtb2RlbCwgaWQpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgLy8gV2UgZ2V0IGEgc2VyaWFsaXplZCB2ZXJzaW9uIG9mIHRoZSBPYmplY3RcbiAgICAgICAgICAgICAgIGxldCBzZXJpYWxpemVkID0gYXdhaXQgUHJveHlPYmplY3QuZnJvbVN0b3JlZChtb2RlbCwgY2FzdC5vYmplY3QsIHRoaXMuY29udGV4dC5zZXJpYWxpemVyKVxuICAgICAgICAgICAgICAgdGhpcy5jYWNoZS5zYXZlT2JqZWN0KG1vZGVsLCBzZXJpYWxpemVkKVxuXG4gICAgICAgICAgICAgICAvL0B0cy1pZ25vcmVcbiAgICAgICAgICAgICAgIG9iamVjdCA9IHNlcmlhbGl6ZWQgYXMgVFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YWNrLmVtaXQoRXZlbnRTZXQuR2V0T2JqZWN0LCBldmVudClcbiAgICAgICAgIH0pXG4gICAgICAgICAuY29tbWl0KClcblxuICAgICAgcmV0dXJuIG9iamVjdFxuICAgfVxuXG4gICBhc3luYyBoYXNJZChpZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICBsZXQgaGFzSWQgPSBmYWxzZVxuXG4gICAgICBhd2FpdCB0aGlzLnJmYy5jcmVhdGUobmV3IEhhc0lkRXZlbnQoaWQpKVxuICAgICAgICAgLmZ1bGZpbGwoYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBsZXQgY2FzdCA9IGV2ZW50IGFzIEhhc0lkRXZlbnRcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFjay5lbWl0KEV2ZW50U2V0Lkhhc0lkLCBldmVudClcblxuICAgICAgICAgICAgaWYgKGNhc3QuaGFzSWQpIHtcbiAgICAgICAgICAgICAgIGhhc0lkID0gdHJ1ZVxuICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIEhhcyBpdCBhIHBsdWdpbiBhdHRlbXB0ZWQgdG8gc2V0IGl0P1xuICAgICAgICAgICAgaWYgKGNhc3QuYXR0ZW1wdGVkU2V0KSB7XG4gICAgICAgICAgICAgICAvLyBJZiBzbywgd2UgY2FuIHRydXN0IHRoYXQgYW4gZXh0ZXJuYWwgc3lzdGVtIGRvZXNuJ3QgaGF2ZSBpdFxuICAgICAgICAgICAgICAgaGFzSWQgPSBmYWxzZVxuICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIElmIG5vIGV4dGVybmFsIHN5c3RlbSBhdHRlbXB0ZWQgdG8gc2V0IGl0LCBkbyB3ZSBoYXZlIGl0IGNhY2hlZD9cbiAgICAgICAgICAgIGhhc0lkID0gdGhpcy5jYWNoZS5oYXNJZChpZClcblxuICAgICAgICAgfSlcbiAgICAgICAgIC5jb21taXQoKVxuXG4gICAgICByZXR1cm4gaGFzSWRcbiAgIH1cblxuICAgYXN5bmMgdXBkYXRlT2JqZWN0PFQgZXh0ZW5kcyBTdGFja09iamVjdD4obW9kZWw6IElNb2RlbCwgb2JqOiBULCBvblVwZGF0ZTogVXBkYXRlT2JqZWN0SGFuZGxlcjxUPik6IFByb21pc2U8dm9pZD4ge1xuICAgICAgYXdhaXQgdGhpcy5yZmMuY3JlYXRlKG5ldyBVcGRhdGVPYmplY3RFdmVudDxUPihtb2RlbCwgb2JqKSlcbiAgICAgICAgIC5mdWxmaWxsKGFzeW5jIChldmVudCkgPT4ge1xuICAgICAgICAgICAgbGV0IGNhc3QgPSBldmVudCBhcyBVcGRhdGVPYmplY3RFdmVudDxUPlxuXG4gICAgICAgICAgICBsZXQgdXBkYXRlZCA9IGNhc3QudXBkYXRlZFxuXG4gICAgICAgICAgICBhd2FpdCBvblVwZGF0ZSh1cGRhdGVkLCBjYXN0LmV4aXN0cylcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFjay5lbWl0KEV2ZW50U2V0Lk9iamVjdFVwZGF0ZWQsIGV2ZW50KVxuICAgICAgICAgfSlcbiAgICAgICAgIC5jb21taXQoKVxuICAgfVxufSJdfQ==