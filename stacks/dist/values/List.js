"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ListSerializer = exports.ListValue = exports.ListType = void 0;
const ValueSerializer_1 = require("../serialize/ValueSerializer");
const Type_1 = require("./Type");
const Value_1 = require("./Value");
class ListType extends Type_1.Type {
    constructor(itemType) {
        super(Type_1.TypeSet.List);
        this.itemType = itemType;
    }
    equals(other) {
        if (other.type !== Type_1.TypeSet.List) {
            return false;
        }
        let cast = other;
        if (!this.itemType.equals(cast.itemType)) {
            return false;
        }
        return true;
    }
    async validate(obj) {
        if (!Array.isArray(obj)) {
            return { success: false, error: new Error(`Type does not match. Expected 'Array' but receieved '${typeof obj}' instead.`) };
        }
        let array = obj;
        for (let i = 0; i < array.length; ++i) {
            let valid = await this.itemType.validate(array[i]);
            if (valid.success == false) {
                return { success: false, error: new Error(`Encountered an error when validating the items in a List. Reason: ${valid.error}`) };
            }
        }
        return { success: true };
    }
}
exports.ListType = ListType;
class ListValue extends Value_1.Value {
    constructor(itemType, serializer) {
        super(new ListType(itemType));
        this.itemType = itemType;
        this.serializer = serializer;
        this.items = new Array();
    }
    [Symbol.iterator]() {
        let index = 0;
        let self = this;
        return {
            next() {
                return index == self.items.length ?
                    { value: undefined, done: true } :
                    { value: self.items[index++], done: false };
            }
        };
    }
    at(index) {
        return this.items.at(index);
    }
    clear() {
        this.items.splice(0, this.items.length);
    }
    clone() {
        let list = new ListValue(this.itemType, this.serializer);
        list.push(...this.items);
        return list;
    }
    equals(other) {
        if (!this.type.equals(other.type)) {
            return false;
        }
        let list = other;
        if (list.items.length != this.items.length) {
            return false;
        }
        for (let i = 0; i < this.items.length; ++i) {
            let thisItem = this.items[i];
            let otherItem = list.items[i];
            if (!thisItem.equals(otherItem)) {
                return false;
            }
        }
        return true;
    }
    push(...items) {
        return this.items.push(...items);
    }
    set(value) {
        if (!this.type.equals(value.type)) {
            throw new Error(`Cannot set a List Value with a different type. Encountered ${value.type.type} when setting the value of a List.`);
        }
        let list = value;
        this.items.splice(0, this.items.length);
        this.items.push(...list.items);
        return this;
    }
    async toJs() {
        let results = new Array();
        for (let i = 0; i < this.items.length; ++i) {
            results.push(await this.serializer.toJs(this.items[i]));
        }
        return results;
    }
}
exports.ListValue = ListValue;
class ListSerializer extends ValueSerializer_1.ValueSerializer {
    constructor(serializer) {
        super(Type_1.TypeSet.List);
        this.serializer = serializer;
    }
    async toJs(value) {
        this.validate(value.type);
        let results = new Array();
        let list = value;
        for (let value of list) {
            results.push(await this.serializer.toJs(value));
        }
        return results;
    }
    async fromJs(type, obj) {
        this.validate(type);
        if (!Array.isArray(obj)) {
            throw new Error(`The JS object type does not match what's expected when serializing. Expected a List and received a ${typeof obj}`);
        }
        let listType = type;
        let list = new ListValue(listType.itemType, this.serializer);
        for (let val of obj) {
            list.push(await this.serializer.fromJs(listType.itemType, val));
        }
        return list;
    }
}
exports.ListSerializer = ListSerializer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTGlzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy92YWx1ZXMvTGlzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxrRUFBZ0Y7QUFDaEYsaUNBQTZEO0FBQzdELG1DQUF1QztBQUd2QyxNQUFhLFFBQVMsU0FBUSxXQUFJO0lBQy9CLFlBQXFCLFFBQWU7UUFDakMsS0FBSyxDQUFDLGNBQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQURELGFBQVEsR0FBUixRQUFRLENBQU87SUFFcEMsQ0FBQztJQUVELE1BQU0sQ0FBQyxLQUFZO1FBQ2hCLElBQUcsS0FBSyxDQUFDLElBQUksS0FBSyxjQUFPLENBQUMsSUFBSSxFQUFFO1lBQzdCLE9BQU8sS0FBSyxDQUFBO1NBQ2Q7UUFFRCxJQUFJLElBQUksR0FBRyxLQUFpQixDQUFBO1FBRTVCLElBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDdEMsT0FBTyxLQUFLLENBQUE7U0FDZDtRQUVELE9BQU8sSUFBSSxDQUFBO0lBQ2QsQ0FBQztJQUVELEtBQUssQ0FBQyxRQUFRLENBQUksR0FBTTtRQUNyQixJQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNyQixPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxLQUFLLENBQUMsd0RBQXdELE9BQU8sR0FBRyxZQUFZLENBQUMsRUFBQyxDQUFBO1NBQzVIO1FBRUQsSUFBSSxLQUFLLEdBQUcsR0FBZSxDQUFBO1FBRTNCLEtBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxFQUFFO1lBQ25DLElBQUksS0FBSyxHQUFHLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFD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QixJQUFJLE9BQU8sR0FBRyxJQUFJLEtBQUssRUFBTyxDQUFBO1FBRTlCLElBQUksSUFBSSxHQUFHLEtBQWtCLENBQUE7UUFFN0IsS0FBSSxJQUFJLEtBQUssSUFBSSxJQUFJLEVBQUU7WUFDcEIsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7U0FDakQ7UUFFRCxPQUFPLE9BQU8sQ0FBQTtJQUNqQixDQUFDO0lBRUQsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFXLEVBQUUsR0FBUTtRQUMvQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBRW5CLElBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3JCLE1BQU0sSUFBSSxLQUFLLENBQUMsc0dBQXNHLE9BQU8sR0FBRyxFQUFFLENBQUMsQ0FBQTtTQUNySTtRQUVELElBQUksUUFBUSxHQUFHLElBQWdCLENBQUE7UUFFL0IsSUFBSSxJQUFJLEdBQUcsSUFBSSxTQUFTLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUE7UUFFNUQsS0FBSSxJQUFJLEdBQUcsSUFBSSxHQUFHLEVBQUU7WUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQTtTQUNqRTtRQUVELE9BQU8sSUFBSSxDQUFBO0lBQ2QsQ0FBQztDQUNIO0FBcENELHdDQW9DQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElWYWx1ZVNlcmlhbGl6ZXIsIFZhbHVlU2VyaWFsaXplciB9IGZyb20gXCIuLi9zZXJpYWxpemUvVmFsdWVTZXJpYWxpemVyXCJcbmltcG9ydCB7IElUeXBlLCBUeXBlLCBUeXBlU2V0LCBWYWxpZGF0ZVJlc3VsdCB9IGZyb20gXCIuL1R5cGVcIlxuaW1wb3J0IHsgSVZhbHVlLCBWYWx1ZSB9IGZyb20gXCIuL1ZhbHVlXCJcblxuXG5leHBvcnQgY2xhc3MgTGlzdFR5cGUgZXh0ZW5kcyBUeXBlIHtcbiAgIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGl0ZW1UeXBlOiBJVHlwZSkge1xuICAgICAgc3VwZXIoVHlwZVNldC5MaXN0KVxuICAgfVxuXG4gICBlcXVhbHMob3RoZXI6IElUeXBlKTogYm9vbGVhbiB7XG4gICAgICBpZihvdGhlci50eXBlICE9PSBUeXBlU2V0Lkxpc3QpIHtcbiAgICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfVxuXG4gICAgICBsZXQgY2FzdCA9IG90aGVyIGFzIExpc3RUeXBlXG5cbiAgICAgIGlmKCF0aGlzLml0ZW1UeXBlLmVxdWFscyhjYXN0Lml0ZW1UeXBlKSkge1xuICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0cnVlXG4gICB9XG5cbiAgIGFzeW5jIHZhbGlkYXRlPFQ+KG9iajogVCk6IFByb21pc2U8VmFsaWRhdGVSZXN1bHQ+IHtcbiAgICAgIGlmKCFBcnJheS5pc0FycmF5KG9iaikpIHtcbiAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogbmV3IEVycm9yKGBUeXBlIGRvZXMgbm90IG1hdGNoLiBFeHBlY3RlZCAnQXJyYXknIGJ1dCByZWNlaWV2ZWQgJyR7dHlwZW9mIG9ian0nIGluc3RlYWQuYCl9XG4gICAgICB9XG5cbiAgICAgIGxldCBhcnJheSA9IG9iaiBhcyBBcnJheTxUPlxuXG4gICAgICBmb3IobGV0IGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgIGxldCB2YWxpZCA9IGF3YWl0IHRoaXMuaXRlbVR5cGUudmFsaWRhdGUoYXJyYXlbaV0pXG5cbiAgICAgICAgIGlmKHZhbGlkLnN1Y2Nlc3MgPT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogbmV3IEVycm9yKGBFbmNvdW50ZXJlZCBhbiBlcnJvciB3aGVuIHZhbGlkYXRpbmcgdGhlIGl0ZW1zIGluIGEgTGlzdC4gUmVhc29uOiAke3ZhbGlkLmVycm9yfWApfVxuICAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH1cbiAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIExpc3RWYWx1ZSBleHRlbmRzIFZhbHVlIHtcbiAgIHByaXZhdGUgaXRlbXM6IEFycmF5PElWYWx1ZT4gPSBuZXcgQXJyYXk8SVZhbHVlPigpXG4gICBcbiAgIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGl0ZW1UeXBlOiBJVHlwZSwgcmVhZG9ubHkgc2VyaWFsaXplcjogSVZhbHVlU2VyaWFsaXplcikge1xuICAgICAgc3VwZXIobmV3IExpc3RUeXBlKGl0ZW1UeXBlKSlcbiAgIH1cblxuICAgW1N5bWJvbC5pdGVyYXRvcl0oKTogSXRlcmF0b3I8SVZhbHVlPiB7XG4gICAgICBsZXQgaW5kZXggPSAwXG4gICAgICBsZXQgc2VsZiA9IHRoaXNcbiAgICAgIHJldHVybiB7XG4gICAgICAgICBuZXh0KCk6IEl0ZXJhdG9yUmVzdWx0PElWYWx1ZT4ge1xuICAgICAgICAgICAgcmV0dXJuIGluZGV4ID09IHNlbGYuaXRlbXMubGVuZ3RoID9cbiAgICAgICAgICAgICAgIHsgdmFsdWU6IHVuZGVmaW5lZCwgZG9uZTogdHJ1ZSB9IDpcbiAgICAgICAgICAgICAgIHsgdmFsdWU6IHNlbGYuaXRlbXNbaW5kZXgrK10sIGRvbmU6IGZhbHNlIH1cbiAgICAgICAgIH1cbiAgICAgIH1cbiAgIH1cblxuICAgYXQoaW5kZXg6IG51bWJlcik6IElWYWx1ZSB8IHVuZGVmaW5lZCB7XG4gICAgICByZXR1cm4gdGhpcy5pdGVtcy5hdChpbmRleClcbiAgIH1cblxuICAgY2xlYXIoKTogdm9pZCB7XG4gICAgICB0aGlzLml0ZW1zLnNwbGljZSgwLCB0aGlzLml0ZW1zLmxlbmd0aClcbiAgIH1cblxuICAgY2xvbmUoKTogSVZhbHVlIHtcbiAgICAgIGxldCBsaXN0ID0gbmV3IExpc3RWYWx1ZSh0aGlzLml0ZW1UeXBlLCB0aGlzLnNlcmlhbGl6ZXIpXG4gICAgICBsaXN0LnB1c2goLi4udGhpcy5pdGVtcylcbiAgICAgIHJldHVybiBsaXN0XG4gICB9XG5cbiAgIGVxdWFscyhvdGhlcjogSVZhbHVlKTogYm9vbGVhbiB7XG4gICAgICBpZighdGhpcy50eXBlLmVxdWFscyhvdGhlci50eXBlKSkge1xuICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9XG5cbiAgICAgIGxldCBsaXN0ID0gb3RoZXIgYXMgTGlzdFZhbHVlXG5cbiAgICAgIGlmKGxpc3QuaXRlbXMubGVuZ3RoICE9IHRoaXMuaXRlbXMubGVuZ3RoKSB7XG4gICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cblxuICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRoaXMuaXRlbXMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgIGxldCB0aGlzSXRlbSA9IHRoaXMuaXRlbXNbaV1cbiAgICAgICAgIGxldCBvdGhlckl0ZW0gPSBsaXN0Lml0ZW1zW2ldXG5cbiAgICAgICAgIGlmKCF0aGlzSXRlbS5lcXVhbHMob3RoZXJJdGVtKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0cnVlICAgICAgXG4gICB9XG5cbiAgIHB1c2goLi4uaXRlbXM6IElWYWx1ZVtdKTogbnVtYmVyIHtcbiAgICAgIHJldHVybiB0aGlzLml0ZW1zLnB1c2goLi4uaXRlbXMpXG4gICB9XG5cbiAgIHNldCh2YWx1ZTogSVZhbHVlKTogSVZhbHVlIHtcbiAgICAgIGlmKCF0aGlzLnR5cGUuZXF1YWxzKHZhbHVlLnR5cGUpKSB7XG4gICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBzZXQgYSBMaXN0IFZhbHVlIHdpdGggYSBkaWZmZXJlbnQgdHlwZS4gRW5jb3VudGVyZWQgJHt2YWx1ZS50eXBlLnR5cGV9IHdoZW4gc2V0dGluZyB0aGUgdmFsdWUgb2YgYSBMaXN0LmApXG4gICAgICB9XG5cbiAgICAgIGxldCBsaXN0ID0gdmFsdWUgYXMgTGlzdFZhbHVlXG5cbiAgICAgIHRoaXMuaXRlbXMuc3BsaWNlKDAsIHRoaXMuaXRlbXMubGVuZ3RoKVxuICAgICAgdGhpcy5pdGVtcy5wdXNoKC4uLmxpc3QuaXRlbXMpXG5cbiAgICAgIHJldHVybiB0aGlzXG4gICB9XG5cbiAgIGFzeW5jIHRvSnMoKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgIGxldCByZXN1bHRzID0gbmV3IEFycmF5PGFueT4oKVxuXG4gICAgICBmb3IobGV0IGkgPSAwOyBpIDwgdGhpcy5pdGVtcy5sZW5ndGg7ICsraSkge1xuICAgICAgICAgcmVzdWx0cy5wdXNoKGF3YWl0IHRoaXMuc2VyaWFsaXplci50b0pzKHRoaXMuaXRlbXNbaV0pKVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzdWx0c1xuICAgfVxufVxuXG5leHBvcnQgY2xhc3MgTGlzdFNlcmlhbGl6ZXIgZXh0ZW5kcyBWYWx1ZVNlcmlhbGl6ZXIge1xuICAgY29uc3RydWN0b3IocmVhZG9ubHkgc2VyaWFsaXplcjogSVZhbHVlU2VyaWFsaXplcikge1xuICAgICAgc3VwZXIoVHlwZVNldC5MaXN0KVxuICAgfVxuXG4gICBhc3luYyB0b0pzKHZhbHVlOiBJVmFsdWUpOiBQcm9taXNlPGFueT4ge1xuICAgICAgdGhpcy52YWxpZGF0ZSh2YWx1ZS50eXBlKVxuXG4gICAgICBsZXQgcmVzdWx0cyA9IG5ldyBBcnJheTxhbnk+KClcblxuICAgICAgbGV0IGxpc3QgPSB2YWx1ZSBhcyBMaXN0VmFsdWVcblxuICAgICAgZm9yKGxldCB2YWx1ZSBvZiBsaXN0KSB7XG4gICAgICAgICByZXN1bHRzLnB1c2goYXdhaXQgdGhpcy5zZXJpYWxpemVyLnRvSnModmFsdWUpKVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzdWx0c1xuICAgfVxuXG4gICBhc3luYyBmcm9tSnModHlwZTogSVR5cGUsIG9iajogYW55KTogUHJvbWlzZTxJVmFsdWU+IHtcbiAgICAgIHRoaXMudmFsaWRhdGUodHlwZSlcblxuICAgICAgaWYoIUFycmF5LmlzQXJyYXkob2JqKSkge1xuICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgSlMgb2JqZWN0IHR5cGUgZG9lcyBub3QgbWF0Y2ggd2hhdCdzIGV4cGVjdGVkIHdoZW4gc2VyaWFsaXppbmcuIEV4cGVjdGVkIGEgTGlzdCBhbmQgcmVjZWl2ZWQgYSAke3R5cGVvZiBvYmp9YClcbiAgICAgIH1cblxuICAgICAgbGV0IGxpc3RUeXBlID0gdHlwZSBhcyBMaXN0VHlwZVxuXG4gICAgICBsZXQgbGlzdCA9IG5ldyBMaXN0VmFsdWUobGlzdFR5cGUuaXRlbVR5cGUsIHRoaXMuc2VyaWFsaXplcilcblxuICAgICAgZm9yKGxldCB2YWwgb2Ygb2JqKSB7XG4gICAgICAgICBsaXN0LnB1c2goYXdhaXQgdGhpcy5zZXJpYWxpemVyLmZyb21KcyhsaXN0VHlwZS5pdGVtVHlwZSwgdmFsKSlcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGxpc3RcbiAgIH1cbn0iXX0=