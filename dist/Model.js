"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Model = void 0;
const MemberCollection_1 = require("./collections/MemberCollection");
const Type_1 = require("./values/Type");
const ValueSource_1 = require("./values/ValueSource");
class Model {
    constructor(name, id, context) {
        this.name = name;
        this.id = id;
        this.context = context;
        this.members = new MemberCollection_1.MemberCollection(this, this.context);
    }
    get orchestrator() {
        return this.context.orchestrator;
    }
    async append(obj) {
        return this.members.append(obj);
    }
    async commit(obj) {
        await this.orchestrator.commitObject(this, obj);
    }
    async create(obj) {
        let result = {};
        for (let key of Object.keys(obj)) {
            let value = ValueSource_1.ValueSource.resolve(obj[key], this.context);
            result[key] = value.toJs();
        }
        for (let member of this.members) {
            if (result[member.name] != null) {
                continue;
            }
            result[member.name] = await member.value.toJs();
        }
        return result;
    }
    async delete(object) {
        await this.orchestrator.deleteObject(this, object);
    }
    async get(id) {
        return await this.orchestrator.getObject(this, id);
    }
    async getMany(req) {
        return this.getMany(req);
    }
    async toJs() {
        let result = {
            id: this.id
        };
        for (let member of this.members) {
            result[member.name] = await member.value.toJs();
        }
        //@ts-ignore
        return result;
    }
    async validate(obj) {
        let report = new Type_1.ValidationReport();
        for (let key of Object.keys(obj)) {
            let member = this.members.get(key);
            if (member === undefined) {
                report.addError(new Error(`Object contains a key that does not exist int he Model: ${key}`));
                continue;
            }
            let result = await member.type.validate(obj[key]);
            if (result.success === false && result.error) {
                report.addError(result.error);
            }
        }
        return report;
    }
}
exports.Model = Model;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW9kZWwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvTW9kZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUVBQXFGO0FBR3JGLHdDQUF3RDtBQUN4RCxzREFBdUU7QUFpR3ZFLE1BQWEsS0FBSztJQVdmLFlBQVksSUFBWSxFQUFFLEVBQVUsRUFBRSxPQUFzQjtRQUN6RCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQTtRQUNoQixJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQTtRQUNaLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFBO1FBRXRCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxtQ0FBZ0IsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO0lBQzFELENBQUM7SUFaRCxJQUFZLFlBQVk7UUFDckIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQTtJQUNuQyxDQUFDO0lBWUQsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFzQjtRQUNoQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBQ2xDLENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTSxDQUF3QixHQUFNO1FBQ3ZDLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUksSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFBO0lBQ3JELENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTSxDQUFJLEdBQXVCO1FBQ3BDLElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQTtRQUVmLEtBQUssSUFBSSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUMvQixJQUFJLEtBQUssR0FBRyx5QkFBVyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1lBQ3ZELE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUE7U0FDNUI7UUFFRCxLQUFLLElBQUksTUFBTSxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDOUIsSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksRUFBRTtnQkFDOUIsU0FBUTthQUNWO1lBRUQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxNQUFNLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUE7U0FDakQ7UUFFRCxPQUFPLE1BQVcsQ0FBQTtJQUNyQixDQUFDO0lBRUQsS0FBSyxDQUFDLE1BQU0sQ0FBd0IsTUFBUztRQUMxQyxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFJLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQTtJQUN4RCxDQUFDO0lBRUQsS0FBSyxDQUFDLEdBQUcsQ0FBd0IsRUFBVTtRQUN4QyxPQUFPLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUksSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBQ3hELENBQUM7SUFFRCxLQUFLLENBQUMsT0FBTyxDQUFJLEdBQWlCO1FBQy9CLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBSSxHQUFHLENBQUMsQ0FBQTtJQUM5QixDQUFDO0lBRUQsS0FBSyxDQUFDLElBQUk7UUFDUCxJQUFJLE1BQU0sR0FBRztZQUNWLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRTtTQUNiLENBQUE7UUFFRCxLQUFLLElBQUksTUFBTSxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDOUIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxNQUFNLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUE7U0FDakQ7UUFFRCxZQUFZO1FBQ1osT0FBTyxNQUFXLENBQUE7SUFDckIsQ0FBQztJQUVELEtBQUssQ0FBQyxRQUFRLENBQUksR0FBTTtRQUNyQixJQUFJLE1BQU0sR0FBRyxJQUFJLHVCQUFnQixFQUFFLENBQUE7UUFFbkMsS0FBSyxJQUFJLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQy9CLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBRWxDLElBQUksTUFBTSxLQUFLLFNBQVMsRUFBRTtnQkFDdkIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEtBQUssQ0FBQywyREFBMkQsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFBO2dCQUM1RixTQUFRO2FBQ1Y7WUFFRCxJQUFJLE1BQU0sR0FBRyxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO1lBRWpELElBQUksTUFBTSxDQUFDLE9BQU8sS0FBSyxLQUFLLElBQUksTUFBTSxDQUFDLEtBQUssRUFBRTtnQkFDM0MsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUE7YUFDL0I7U0FDSDtRQUVELE9BQU8sTUFBTSxDQUFBO0lBQ2hCLENBQUM7Q0FDSDtBQTNGRCxzQkEyRkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJTWVtYmVyQ29sbGVjdGlvbiwgTWVtYmVyQ29sbGVjdGlvbiB9IGZyb20gXCIuL2NvbGxlY3Rpb25zL01lbWJlckNvbGxlY3Rpb25cIjtcbmltcG9ydCB7IElPcmNoZXN0cmF0b3IgfSBmcm9tIFwiLi9vcmNoZXN0cmF0b3IvT3JjaGVzdHJhdG9yXCI7XG5pbXBvcnQgeyBJU3RhY2tDb250ZXh0IH0gZnJvbSBcIi4vc3RhY2svU3RhY2tDb250ZXh0XCI7XG5pbXBvcnQgeyBJVHlwZSwgVmFsaWRhdGlvblJlcG9ydCB9IGZyb20gXCIuL3ZhbHVlcy9UeXBlXCI7XG5pbXBvcnQgeyBDcmVhdGVWYWx1ZUhhbmRsZXIsIFZhbHVlU291cmNlIH0gZnJvbSBcIi4vdmFsdWVzL1ZhbHVlU291cmNlXCI7XG5pbXBvcnQgeyBDcmVhdGVUeXBlSGFuZGxlciB9IGZyb20gXCIuL3ZhbHVlcy9UeXBlU291cmNlXCI7XG5pbXBvcnQgeyBNZW1iZXJWYWx1ZSB9IGZyb20gXCIuL01lbWJlclwiO1xuaW1wb3J0IHsgU3RhY2tPYmplY3QgfSBmcm9tIFwiLlwiO1xuXG5leHBvcnQgdHlwZSBPYmplY3RDcmVhdGVQYXJhbXMgPSB7XG4gICBba2V5OiBzdHJpbmddOiBib29sZWFuIHwgbnVtYmVyIHwgc3RyaW5nIHwgQ3JlYXRlVmFsdWVIYW5kbGVyXG59XG5cbmV4cG9ydCB0eXBlIE1vZGVsQ3JlYXRlUGFyYW1zID0ge1xuICAgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgbnVtYmVyIHwgYm9vbGVhbiB8IENyZWF0ZVZhbHVlSGFuZGxlciB8IE1vZGVsUHJvcGVydHlcbn1cblxuZXhwb3J0IHR5cGUgTW9kZWxDcmVhdGVDb250ZXh0ID0ge1xuICAgbW9kZWw6IElNb2RlbCAgLy8gVGhlIE1vZGVsIGJlaW5nIGNyZWF0ZWRcbn1cblxuZXhwb3J0IHR5cGUgU3ltYm9sRW50cnkgPSB7XG4gICBuYW1lOiBzdHJpbmcsXG4gICB2YWx1ZTogYW55XG59XG5cbmV4cG9ydCB0eXBlIE1vZGVsUHJvcGVydHkgPSB7XG4gICB0eXBlOiBJVHlwZSB8IENyZWF0ZVR5cGVIYW5kbGVyLFxuICAgdmFsdWU6IE1lbWJlclZhbHVlLFxuICAgc3ltYm9sczogU3ltYm9sRW50cnlbXVxufVxuXG5leHBvcnQgdHlwZSBQYWdlUmVzcG9uc2U8VD4gPSB7XG4gICBjdXJzb3I6IHN0cmluZ1xuICAgaXRlbXM6IFRbXVxufVxuXG5leHBvcnQgdHlwZSBQYWdlUmVxdWVzdCA9IHtcbiAgIGN1cnNvcj86IHN0cmluZ1xuICAgbGltaXQ/OiBudW1iZXJcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJTW9kZWwge1xuICAgcmVhZG9ubHkgaWQ6IHN0cmluZ1xuICAgcmVhZG9ubHkgbmFtZTogc3RyaW5nXG5cbiAgIHJlYWRvbmx5IG1lbWJlcnM6IElNZW1iZXJDb2xsZWN0aW9uXG5cbiAgIC8qKlxuICAgICogQXBwZW5kcyBhZGRpdGlvbmFsIE1lbWJlcnMgdG8gdGhlIE1vZGVsXG4gICAgKiBcbiAgICAqIEBwYXJhbSBvYmogVGhlIGFkZGl0aW9uYWwgbWVtYmVycyB0byBhZGRcbiAgICAqL1xuICAgYXBwZW5kKG9iajogTW9kZWxDcmVhdGVQYXJhbXMpOiBQcm9taXNlPHZvaWQ+XG5cbiAgIC8qKlxuICAgICogQ29tbWl0cyB0aGUgb2JqZWN0IHRvIHN0b3JhZ2VcbiAgICAqIFxuICAgICogQHBhcmFtIG9iamVjdCBUaGUgb2JqZWN0IHRvIGNvbW1pdFxuICAgICovXG4gICBjb21taXQ8VCBleHRlbmRzIFN0YWNrT2JqZWN0PihvYmplY3Q6IFQpOiBQcm9taXNlPHZvaWQ+XG5cbiAgIC8qKlxuICAgICogQ3JlYXRlcyBhIG5ldyBPYmplY3QgYmFzZWQgb24gdGhpcyBNb2RlbFxuICAgICovXG4gICBjcmVhdGU8VD4ob2JqOiBPYmplY3RDcmVhdGVQYXJhbXMpOiBQcm9taXNlPFQ+XG5cbiAgIC8qKlxuICAgICogRGVsZXRlcyBhbiBvYmplY3QgZGVyaXZlZCBmcm9tIHRoaXMgTW9kZWxcbiAgICAqIFxuICAgICogQHBhcmFtIG9iamVjdCBUaGUgb2JqZWN0IHRvIGRlbGV0ZVxuICAgICovXG4gICBkZWxldGU8VCBleHRlbmRzIFN0YWNrT2JqZWN0PihvYmplY3Q6IFQpOiBQcm9taXNlPHZvaWQ+XG5cbiAgIC8qKlxuICAgICogUmV0cmlldmVzIGFuIGluc3RhbmNlIGJ5IElEXG4gICAgKiBcbiAgICAqIEBwYXJhbSBpZCBUaGUgSUQgb2YgdGhlIGluc3RhbmNlXG4gICAgKi9cbiAgIGdldDxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KGlkOiBzdHJpbmcpOiBQcm9taXNlPFQgfCB1bmRlZmluZWQ+XG5cbiAgIC8qKlxuICAgICogR2V0cyBtYW55IE9iamVjdHNcbiAgICAqIFxuICAgICogQHBhcmFtIHJlcSBUaGUgUGFnZWRSZXF1ZXN0IFxuICAgICovXG4gICBnZXRNYW55PFQ+KHJlcT86IFBhZ2VSZXF1ZXN0KTogUHJvbWlzZTxQYWdlUmVzcG9uc2U8VD4+XG5cbiAgIC8qKlxuICAgICogQ29udmVydHMgdGhlIE1vZGVsIGludG8gYSBKUyBvYmplY3RcbiAgICAqL1xuICAgdG9KczxUPigpOiBQcm9taXNlPFQ+XG5cbiAgIC8qKlxuICAgICogVmFsaWRhdGVzIGFuIE9iamVjdCBhZ2FpbnN0IHRoZSBNb2RlbCdzIHNjaGVtYVxuICAgICogXG4gICAgKiBAcGFyYW0gb2JqIFRoZSBPYmplY3QgdG8gdmFsaWRhdGVcbiAgICAqL1xuICAgdmFsaWRhdGU8VD4ob2JqOiBUKTogUHJvbWlzZTxWYWxpZGF0aW9uUmVwb3J0PlxufVxuXG5leHBvcnQgY2xhc3MgTW9kZWwgaW1wbGVtZW50cyBJTW9kZWwge1xuICAgcmVhZG9ubHkgaWQ6IHN0cmluZ1xuICAgcmVhZG9ubHkgbmFtZTogc3RyaW5nXG4gICByZWFkb25seSBjb250ZXh0OiBJU3RhY2tDb250ZXh0XG5cbiAgIHByaXZhdGUgZ2V0IG9yY2hlc3RyYXRvcigpOiBJT3JjaGVzdHJhdG9yIHtcbiAgICAgIHJldHVybiB0aGlzLmNvbnRleHQub3JjaGVzdHJhdG9yXG4gICB9XG5cbiAgIHJlYWRvbmx5IG1lbWJlcnM6IElNZW1iZXJDb2xsZWN0aW9uXG5cbiAgIGNvbnN0cnVjdG9yKG5hbWU6IHN0cmluZywgaWQ6IHN0cmluZywgY29udGV4dDogSVN0YWNrQ29udGV4dCkge1xuICAgICAgdGhpcy5uYW1lID0gbmFtZVxuICAgICAgdGhpcy5pZCA9IGlkXG4gICAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0XG5cbiAgICAgIHRoaXMubWVtYmVycyA9IG5ldyBNZW1iZXJDb2xsZWN0aW9uKHRoaXMsIHRoaXMuY29udGV4dClcbiAgIH1cblxuICAgYXN5bmMgYXBwZW5kKG9iajogTW9kZWxDcmVhdGVQYXJhbXMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIHJldHVybiB0aGlzLm1lbWJlcnMuYXBwZW5kKG9iailcbiAgIH1cblxuICAgYXN5bmMgY29tbWl0PFQgZXh0ZW5kcyBTdGFja09iamVjdD4ob2JqOiBUKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICBhd2FpdCB0aGlzLm9yY2hlc3RyYXRvci5jb21taXRPYmplY3Q8VD4odGhpcywgb2JqKVxuICAgfVxuXG4gICBhc3luYyBjcmVhdGU8VD4ob2JqOiBPYmplY3RDcmVhdGVQYXJhbXMpOiBQcm9taXNlPFQ+IHtcbiAgICAgIGxldCByZXN1bHQgPSB7fVxuXG4gICAgICBmb3IgKGxldCBrZXkgb2YgT2JqZWN0LmtleXMob2JqKSkge1xuICAgICAgICAgbGV0IHZhbHVlID0gVmFsdWVTb3VyY2UucmVzb2x2ZShvYmpba2V5XSwgdGhpcy5jb250ZXh0KVxuICAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZS50b0pzKClcbiAgICAgIH1cblxuICAgICAgZm9yIChsZXQgbWVtYmVyIG9mIHRoaXMubWVtYmVycykge1xuICAgICAgICAgaWYgKHJlc3VsdFttZW1iZXIubmFtZV0gIT0gbnVsbCkge1xuICAgICAgICAgICAgY29udGludWVcbiAgICAgICAgIH1cblxuICAgICAgICAgcmVzdWx0W21lbWJlci5uYW1lXSA9IGF3YWl0IG1lbWJlci52YWx1ZS50b0pzKClcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJlc3VsdCBhcyBUXG4gICB9XG5cbiAgIGFzeW5jIGRlbGV0ZTxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG9iamVjdDogVCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgYXdhaXQgdGhpcy5vcmNoZXN0cmF0b3IuZGVsZXRlT2JqZWN0PFQ+KHRoaXMsIG9iamVjdClcbiAgIH1cblxuICAgYXN5bmMgZ2V0PFQgZXh0ZW5kcyBTdGFja09iamVjdD4oaWQ6IHN0cmluZyk6IFByb21pc2U8VCB8IHVuZGVmaW5lZD4ge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMub3JjaGVzdHJhdG9yLmdldE9iamVjdDxUPih0aGlzLCBpZClcbiAgIH1cblxuICAgYXN5bmMgZ2V0TWFueTxUPihyZXE/OiBQYWdlUmVxdWVzdCk6IFByb21pc2U8UGFnZVJlc3BvbnNlPFQ+PiB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRNYW55PFQ+KHJlcSlcbiAgIH1cblxuICAgYXN5bmMgdG9KczxUPigpOiBQcm9taXNlPFQ+IHtcbiAgICAgIGxldCByZXN1bHQgPSB7XG4gICAgICAgICBpZDogdGhpcy5pZFxuICAgICAgfVxuXG4gICAgICBmb3IgKGxldCBtZW1iZXIgb2YgdGhpcy5tZW1iZXJzKSB7XG4gICAgICAgICByZXN1bHRbbWVtYmVyLm5hbWVdID0gYXdhaXQgbWVtYmVyLnZhbHVlLnRvSnMoKVxuICAgICAgfVxuXG4gICAgICAvL0B0cy1pZ25vcmVcbiAgICAgIHJldHVybiByZXN1bHQgYXMgVFxuICAgfVxuXG4gICBhc3luYyB2YWxpZGF0ZTxUPihvYmo6IFQpOiBQcm9taXNlPFZhbGlkYXRpb25SZXBvcnQ+IHtcbiAgICAgIGxldCByZXBvcnQgPSBuZXcgVmFsaWRhdGlvblJlcG9ydCgpXG5cbiAgICAgIGZvciAobGV0IGtleSBvZiBPYmplY3Qua2V5cyhvYmopKSB7XG4gICAgICAgICBsZXQgbWVtYmVyID0gdGhpcy5tZW1iZXJzLmdldChrZXkpXG5cbiAgICAgICAgIGlmIChtZW1iZXIgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgcmVwb3J0LmFkZEVycm9yKG5ldyBFcnJvcihgT2JqZWN0IGNvbnRhaW5zIGEga2V5IHRoYXQgZG9lcyBub3QgZXhpc3QgaW50IGhlIE1vZGVsOiAke2tleX1gKSlcbiAgICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgICB9XG5cbiAgICAgICAgIGxldCByZXN1bHQgPSBhd2FpdCBtZW1iZXIudHlwZS52YWxpZGF0ZShvYmpba2V5XSlcblxuICAgICAgICAgaWYgKHJlc3VsdC5zdWNjZXNzID09PSBmYWxzZSAmJiByZXN1bHQuZXJyb3IpIHtcbiAgICAgICAgICAgIHJlcG9ydC5hZGRFcnJvcihyZXN1bHQuZXJyb3IpXG4gICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXBvcnRcbiAgIH1cbn0iXX0=