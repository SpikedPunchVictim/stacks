"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Orchestrator = void 0;
const events_1 = require("../events");
const SaveObjectEvent_1 = require("../events/SaveObjectEvent");
const DeleteObjectEvent_1 = require("../events/DeleteObjectEvent");
const Event_1 = require("../events/Event");
const GetManyObjectsEvent_1 = require("../events/GetManyObjectsEvent");
const HasIdEvent_1 = require("../events/HasIdEvent");
const UpdateObjectEvent_1 = require("../events/UpdateObjectEvent");
const Model_1 = require("../Model");
const ProxyObject_1 = require("../ProxyObject");
const UidKeeper_1 = require("../UidKeeper");
const CreateObjectEvent_1 = require("../events/CreateObjectEvent");
const CreateModelEvent_1 = require("../events/CreateModelEvent");
const DeleteModelEvent_1 = require("../events/DeleteModelEvent");
const GetModelEvent_1 = require("../events/GetModelEvent");
const BootstrapEvent_1 = require("../events/BootstrapEvent");
class Orchestrator {
    constructor(context) {
        this.context = context;
    }
    get cache() {
        return this.context.cache;
    }
    get rfc() {
        return this.context.rfc;
    }
    get serializer() {
        return this.context.serializer;
    }
    get stack() {
        return this.context.stack;
    }
    get uid() {
        return this.context.uid;
    }
    async boostrap() {
        await this.rfc.create(new BootstrapEvent_1.BootstrapEvent())
            .fulfill(async (event) => {
            await this.stack.emit(Event_1.EventSet.Bootstrap, event);
        })
            .commit();
    }
    async createModel(name, params) {
        let model = await this.stack.get.model(name);
        if (model !== undefined) {
            throw new Error(`A Model with the name ${name} already exists`);
        }
        let id = await this.uid.generate();
        model = new Model_1.Model(name, id, this.context);
        await model.append(params);
        this.cache.saveModel(model);
        await this.rfc.create(new CreateModelEvent_1.CreateModelEvent(model))
            .fulfill(async (event) => {
            await this.stack.emit(Event_1.EventSet.ModelCreated, event);
        })
            .commit();
        return model;
    }
    async deleteModel(model) {
        await this.rfc.create(new DeleteModelEvent_1.DeleteModelEvent(model))
            .fulfill(async (event) => {
            this.cache.deleteModel(model.name);
        })
            .commit();
    }
    // Note: This may not be needed. Watch for this.
    // Model's are stored in local cache because they are
    // defined locally, and are the contract between the
    // the expected data set and what is stored.
    async getModel(name) {
        let model;
        await this.rfc.create(new GetModelEvent_1.GetModelEvent(name))
            .fulfill(async (event) => {
            let getModel = event;
            model = getModel.model;
            if (model !== undefined) {
                this.cache.saveModel(model);
            }
            await this.stack.emit(Event_1.EventSet.GetModel, event);
        })
            .commit();
        return model;
    }
    async updateModel(model, params) {
    }
    async createObject(model, params) {
        let created = await ProxyObject_1.ProxyObject.fromCreated(model, params, this.context);
        await this.rfc.create(new CreateObjectEvent_1.CreateObjectEvent(model, created))
            .fulfill(async (event) => {
            await this.stack.emit(Event_1.EventSet.ObjectCreated, event);
        })
            .commit();
        return created;
    }
    /**
     *
     * @param model The Model
     * @param obj The Object to save. Note that this is really a Proxy'd SerializableObject
     */
    async saveObject(model, obj) {
        if (obj.id === UidKeeper_1.UidKeeper.IdNotSet) {
            obj.id = await this.uid.generate();
        }
        let validations = await model.validate(obj);
        if (!validations.success) {
            throw new Error(`Cannot Save Object with ID ${obj.id} since it fails validation. Reason: ${validations.results.map(r => r.error)}`);
        }
        //@ts-ignore
        let serialized = ProxyObject_1.ProxyObject.unwrap(obj);
        await this.rfc.create(new SaveObjectEvent_1.SaveObjectEvent(model, obj, serialized))
            .fulfill(async (event) => {
            this.cache.saveObject(model, obj);
            await this.stack.emit(Event_1.EventSet.ObjectSaved, event);
        })
            .commit();
    }
    async getManyObjects(model, options = { cursor: '', limit: 100 }) {
        let results = {
            cursor: '',
            items: new Array()
        };
        await this.rfc.create(new GetManyObjectsEvent_1.GetManyObjectsEvent(model, options))
            .fulfill(async (event) => {
            let cast = event;
            await this.stack.emit(Event_1.EventSet.GetManyObjects, cast);
            if (cast.results !== undefined) {
                results = cast.results;
                return;
            }
            let objects = this.cache.getObjects(model);
            if (objects.length == 0) {
                return;
            }
            let cursor = options.cursor || '';
            let limit = options.limit || 100;
            // Sort by ID. The resulting paged set is not perfect, and will have
            // holes when new entries are added in between queries.
            objects.sort((a, b) => {
                let aId = a.id.toLowerCase();
                let bId = b.id.toLowerCase();
                return (aId < bId) ? -1 : (aId > bId) ? 1 : 0;
            });
            if (cursor === '') {
                // For an empty cursor we start from the beginning
                let items = objects.slice(0, Math.min(objects.length, limit));
                if (items.length == limit && objects.length > limit) {
                    results.cursor = Buffer.from(objects[limit].id).toString('base64');
                }
                else {
                    // If there are no more entries in thenext set, we default the cursor
                    // to empty string
                    results.cursor = '';
                }
                results.items = items;
                return;
            }
            else {
                // We have a cursor and continue from whence we left off
                cursor = Buffer.from(cursor, 'base64').toString('ascii');
                let index = objects.findIndex(o => o.id === cursor);
                if (index === -1) {
                    // We get here when the object that's next has been deleted
                    // return early
                    return;
                }
                let nextIndex = index + limit;
                results.items = objects.slice(index, nextIndex);
                if (objects.length > nextIndex) {
                    results.cursor = Buffer.from(objects[nextIndex].id).toString('base64');
                }
                else {
                    // If there are no more entries in the next set, we default the cursor
                    // to empty string
                    results.cursor = '';
                }
                return;
            }
            return;
        })
            .commit();
        return results;
    }
    async deleteObject(model, obj) {
        await this.rfc.create(new DeleteObjectEvent_1.DeleteObjectEvent(model, obj))
            .fulfill(async (event) => {
            this.cache.deleteObject(model, obj);
            await this.stack.emit(Event_1.EventSet.ObjectDeleted, event);
        })
            .commit();
    }
    async getObject(model, id) {
        let object;
        await this.rfc.create(new events_1.GetObjectEvent(model, id))
            .fulfill(async (event) => {
            let cast = event;
            if (cast.object === undefined) {
                object = cast.exists === Event_1.ExistState.DoesNotExist ?
                    undefined :
                    this.cache.getObject(model, id);
            }
            else {
                // We get a serialized version of the Object
                let serialized = await ProxyObject_1.ProxyObject.fromStored(model, cast.object, this.context.serializer);
                this.cache.saveObject(model, serialized);
                //@ts-ignore
                object = serialized;
            }
            await this.stack.emit(Event_1.EventSet.GetObject, event);
        })
            .commit();
        return object;
    }
    async hasId(id) {
        let hasId = false;
        await this.rfc.create(new HasIdEvent_1.HasIdEvent(id))
            .fulfill(async (event) => {
            let cast = event;
            await this.stack.emit(Event_1.EventSet.HasId, event);
            if (cast.hasId) {
                hasId = true;
                return;
            }
            // Has it a plugin attempted to set it?
            if (cast.attemptedSet) {
                // If so, we can trust that an external system doesn't have it
                hasId = false;
                return;
            }
            // If no external system attempted to set it, do we have it cached?
            hasId = this.cache.hasId(id);
        })
            .commit();
        return hasId;
    }
    async updateObject(model, obj, onUpdate) {
        await this.rfc.create(new UpdateObjectEvent_1.UpdateObjectEvent(model, obj))
            .fulfill(async (event) => {
            let cast = event;
            let updated = cast.updated;
            await onUpdate(updated, cast.exists);
            await this.stack.emit(Event_1.EventSet.ObjectUpdated, event);
        })
            .commit();
    }
}
exports.Orchestrator = Orchestrator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT3JjaGVzdHJhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL29yY2hlc3RyYXRvci9PcmNoZXN0cmF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBRUEsc0NBQTJDO0FBQzNDLCtEQUE0RDtBQUM1RCxtRUFBZ0U7QUFDaEUsMkNBQXVEO0FBQ3ZELHVFQUFvRTtBQUNwRSxxREFBa0Q7QUFFbEQsbUVBQWdFO0FBQ2hFLG9DQUEyRztBQUkzRyxnREFBNkM7QUFDN0MsNENBQXFEO0FBRXJELG1FQUFnRTtBQUNoRSxpRUFBOEQ7QUFDOUQsaUVBQThEO0FBQzlELDJEQUF3RDtBQUN4RCw2REFBMEQ7QUFtRzFELE1BQWEsWUFBWTtJQXFCdEIsWUFBcUIsT0FBc0I7UUFBdEIsWUFBTyxHQUFQLE9BQU8sQ0FBZTtJQUUzQyxDQUFDO0lBdEJELElBQUksS0FBSztRQUNOLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUE7SUFDNUIsQ0FBQztJQUVELElBQUksR0FBRztRQUNKLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUE7SUFDMUIsQ0FBQztJQUVELElBQUksVUFBVTtRQUNYLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUE7SUFDakMsQ0FBQztJQUVELElBQUksS0FBSztRQUNOLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUE7SUFDNUIsQ0FBQztJQUVELElBQUksR0FBRztRQUNKLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUE7SUFDMUIsQ0FBQztJQU1ELEtBQUssQ0FBQyxRQUFRO1FBQ1gsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLCtCQUFjLEVBQUUsQ0FBQzthQUN2QyxPQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQ3RCLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsZ0JBQVEs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QUMsQ0FBQTtRQUN2RCxDQUFDLENBQUM7YUFDRCxNQUFNLEVBQUUsQ0FBQTtJQUNmLENBQUM7Q0FDSDtBQWxTRCxvQ0FrU0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdGFja09iamVjdCB9IGZyb20gXCIuLi9TdGFja09iamVjdFwiO1xuaW1wb3J0IHsgSUNhY2hlIH0gZnJvbSBcIi4uL0NhY2hlXCI7XG5pbXBvcnQgeyBHZXRPYmplY3RFdmVudCB9IGZyb20gXCIuLi9ldmVudHNcIjtcbmltcG9ydCB7IFNhdmVPYmplY3RFdmVudCB9IGZyb20gXCIuLi9ldmVudHMvU2F2ZU9iamVjdEV2ZW50XCI7XG5pbXBvcnQgeyBEZWxldGVPYmplY3RFdmVudCB9IGZyb20gXCIuLi9ldmVudHMvRGVsZXRlT2JqZWN0RXZlbnRcIjtcbmltcG9ydCB7IEV2ZW50U2V0LCBFeGlzdFN0YXRlIH0gZnJvbSBcIi4uL2V2ZW50cy9FdmVudFwiO1xuaW1wb3J0IHsgR2V0TWFueU9iamVjdHNFdmVudCB9IGZyb20gXCIuLi9ldmVudHMvR2V0TWFueU9iamVjdHNFdmVudFwiO1xuaW1wb3J0IHsgSGFzSWRFdmVudCB9IGZyb20gXCIuLi9ldmVudHMvSGFzSWRFdmVudFwiO1xuaW1wb3J0IHsgSVJlcXVlc3RGb3JDaGFuZ2VTb3VyY2UgfSBmcm9tIFwiLi4vZXZlbnRzL1JlcXVlc3RGb3JDaGFuZ2VcIjtcbmltcG9ydCB7IFVwZGF0ZU9iamVjdEV2ZW50IH0gZnJvbSBcIi4uL2V2ZW50cy9VcGRhdGVPYmplY3RFdmVudFwiO1xuaW1wb3J0IHsgSU1vZGVsLCBNb2RlbCwgTW9kZWxDcmVhdGVQYXJhbXMsIE9iamVjdENyZWF0ZVBhcmFtcywgUGFnZVJlcXVlc3QsIFBhZ2VSZXNwb25zZSB9IGZyb20gXCIuLi9Nb2RlbFwiO1xuaW1wb3J0IHsgSVN0YWNrIH0gZnJvbSBcIi4uL3N0YWNrL1N0YWNrXCI7XG5pbXBvcnQgeyBJU3RhY2tDb250ZXh0IH0gZnJvbSBcIi4uL3N0YWNrL1N0YWNrQ29udGV4dFwiO1xuaW1wb3J0IHsgVXBkYXRlT2JqZWN0SGFuZGxlciB9IGZyb20gXCIuLi9zdGFjay9TdGFja1VwZGF0ZVwiO1xuaW1wb3J0IHsgUHJveHlPYmplY3QgfSBmcm9tIFwiLi4vUHJveHlPYmplY3RcIjtcbmltcG9ydCB7IElVaWRLZWVwZXIsIFVpZEtlZXBlciB9IGZyb20gXCIuLi9VaWRLZWVwZXJcIjtcbmltcG9ydCB7IElWYWx1ZVNlcmlhbGl6ZXIgfSBmcm9tIFwiLi4vc2VyaWFsaXplL1ZhbHVlU2VyaWFsaXplclwiO1xuaW1wb3J0IHsgQ3JlYXRlT2JqZWN0RXZlbnQgfSBmcm9tIFwiLi4vZXZlbnRzL0NyZWF0ZU9iamVjdEV2ZW50XCI7XG5pbXBvcnQgeyBDcmVhdGVNb2RlbEV2ZW50IH0gZnJvbSBcIi4uL2V2ZW50cy9DcmVhdGVNb2RlbEV2ZW50XCI7XG5pbXBvcnQgeyBEZWxldGVNb2RlbEV2ZW50IH0gZnJvbSBcIi4uL2V2ZW50cy9EZWxldGVNb2RlbEV2ZW50XCI7XG5pbXBvcnQgeyBHZXRNb2RlbEV2ZW50IH0gZnJvbSBcIi4uL2V2ZW50cy9HZXRNb2RlbEV2ZW50XCI7XG5pbXBvcnQgeyBCb290c3RyYXBFdmVudCB9IGZyb20gXCIuLi9ldmVudHMvQm9vdHN0cmFwRXZlbnRcIjtcblxuZXhwb3J0IGludGVyZmFjZSBJT3JjaGVzdHJhdG9yIHtcbiAgIC8vIFRPRE86IEFkZDogY3JlYXRlTW9kZWwsIGRlbGV0ZU1vZGVsICh0aGVzZSBzaG91bGQgYXNzaXN0IGluIHJ1bm5pbmcgdGVzdHMpXG5cbiAgIC8qKlxuICAgICogQm9vdHN0cmFwcyB0aGUgU3RhY2suXG4gICAgKi9cbiAgIGJvb3N0cmFwKCk6IFByb21pc2U8dm9pZD5cblxuICAgLyoqXG4gICAgKiBDcmVhdGVzIGEgTW9kZWxcbiAgICAqIFxuICAgICogQHBhcmFtIG5hbWUgVGhlIG5hbWUgb2YgdGhlIE1vZGVsXG4gICAgKiBAcGFyYW0gcGFyYW1zIFRoZSBQYXJhbXMgdXNlZCB0byBjcmVhdGUgdGhlIE1vZGVsXG4gICAgKi9cbiAgIGNyZWF0ZU1vZGVsKG5hbWU6IHN0cmluZywgcGFyYW1zOiBNb2RlbENyZWF0ZVBhcmFtcyk6IFByb21pc2U8SU1vZGVsPlxuXG4gICAvKipcbiAgICAqIERlbGV0ZXMgYSBNb2RlbFxuICAgICogXG4gICAgKiBAcGFyYW0gbW9kZWwgVGhlIE1vZGVsIHRvIGRlbGV0ZVxuICAgICovXG4gICBkZWxldGVNb2RlbChtb2RlbDogSU1vZGVsKTogUHJvbWlzZTx2b2lkPlxuXG4gICAvKipcbiAgICAqIFJldHJpZXZlcyBhIE1vZGVsIGlmIGl0IGV4aXN0cywgb3IgdW5kZWZpZW5kIGlmIG5vdC5cbiAgICAqIFxuICAgICogQHBhcmFtIG5hbWUgVGhlIE1vZGVsIG5hbWVcbiAgICAqL1xuICAgZ2V0TW9kZWwobmFtZTogc3RyaW5nKTogUHJvbWlzZTxJTW9kZWwgfCB1bmRlZmluZWQ+XG5cbiAgIC8qKlxuICAgICogVXBkYXRlcyBhbiBleGlzdGluZyBNb2RlbFxuICAgICogXG4gICAgKiBAcGFyYW0gbW9kZWwgVGhlIE1vZGVsIHRvIHVwZGF0ZVxuICAgICogQHBhcmFtIHBhcmFtcyBUaGUgUGFyYW1zXG4gICAgKi9cbiAgIHVwZGF0ZU1vZGVsKG1vZGVsOiBJTW9kZWwsIHBhcmFtczogTW9kZWxDcmVhdGVQYXJhbXMpOiBQcm9taXNlPHZvaWQ+XG5cbiAgIC8qKlxuICAgICogQ3JlYXRlcyBhIG5ldyBPYmplY3QgaW4gbWVtb3J5IG9ubHkuIE5vdCBpbmRlbmRlZCB0byBiZSBzdG9yZWQgb24gdGhlIGJhY2tlbmQuXG4gICAgKiBPYmplY3RzIGNyZWF0ZWQgdGhpcyB3YXkgaGF2ZSBubyBJRCBhc3NpZ25lZCB0byB0aGVtIHVudGlsIHRoZXkgYXJlIHNhdmVkLlxuICAgICogXG4gICAgKiBAcGFyYW0gbW9kZWwgVGhlIE1vZGVsXG4gICAgKiBAcGFyYW0gcGFyYW1zIFRoZSBPYmplY3QgQ3JlYXRpb24gUGFyYW1zIFxuICAgICovXG4gICBjcmVhdGVPYmplY3Q8VCBleHRlbmRzIFN0YWNrT2JqZWN0Pihtb2RlbDogSU1vZGVsLCBwYXJhbXM6IE9iamVjdENyZWF0ZVBhcmFtcyk6IFByb21pc2U8VD5cblxuICAgLyoqXG4gICAgKiBTYXZlcyBhbiBPYmplY3QgdG8gdGhlIGJhY2tlbmQuXG4gICAgKiBcbiAgICAqIEBwYXJhbSBtb2RlbCBUaGUgTW9kZWxcbiAgICAqIEBwYXJhbSBvYmogVGhlIE9iamVjdCB0byBTYXZlXG4gICAgKi9cbiAgIHNhdmVPYmplY3Q8VCBleHRlbmRzIFN0YWNrT2JqZWN0Pihtb2RlbDogSU1vZGVsLCBvYmo6IFQpOiBQcm9taXNlPHZvaWQ+XG5cbiAgIC8qKlxuICAgICogRGVsZXRlcyBhbiBPYmplY3QgZnJvbSB0aGUgYmFja2VuZFxuICAgICogXG4gICAgKiBAcGFyYW0gbW9kZWwgVGhlIE1vZGVsXG4gICAgKiBAcGFyYW0gb2JqIFRoZSBPYmplY3QgdG8gZGVsZXRlXG4gICAgKi9cbiAgIGRlbGV0ZU9iamVjdDxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG1vZGVsOiBJTW9kZWwsIG9iajogVCk6IFByb21pc2U8dm9pZD5cblxuICAgLyoqXG4gICAgKiBSZXRyaWV2ZXMgbWFueSBvYmplY3RzIGluIGEgcGFnZWQgZmFzaGlvbi5cbiAgICAqIFxuICAgICogQHBhcmFtIG1vZGVsIFRoZSBNb2RlbCByZXByZXNlbnRpbmcgdGhlIE9iamVjdHNcbiAgICAqIEBwYXJhbSBvcHRpb25zIFBhZ2VSZXF1ZXN0IE9wdGlvbnNcbiAgICAqL1xuICAgZ2V0TWFueU9iamVjdHM8VCBleHRlbmRzIFN0YWNrT2JqZWN0Pihtb2RlbDogSU1vZGVsLCBvcHRpb25zOiBQYWdlUmVxdWVzdCk6IFByb21pc2U8UGFnZVJlc3BvbnNlPFQ+PlxuICAgXG4gICAvKipcbiAgICAqIFJldHJpZXZlcyB0aGUgRWRpdCB2ZXJzaW9uIG9mIHRoZSBPYmplY3RcbiAgICAqIFxuICAgICogQHBhcmFtIG1vZGVsIFRoZSBNb2RlbCBvZiB0aGUgT2JqZWN0XG4gICAgKiBAcGFyYW0gaWQgVGhlIE9iamVjdCdzIElEXG4gICAgKi9cbiAgIGdldE9iamVjdDxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG1vZGVsOiBJTW9kZWwsIGlkOiBzdHJpbmcpOiBQcm9taXNlPFQgfCB1bmRlZmluZWQ+XG5cbiAgIC8qKlxuICAgICogRGV0ZXJtaW5lcyBpZiBhbiBJRCBpcyBhbHJlYWR5IGluIHVzZS5cbiAgICAqIFxuICAgICogQHBhcmFtIGlkIFRoZSBJRCB0byB0ZXN0XG4gICAgKi9cbiAgIGhhc0lkKGlkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+XG4gICBcbiAgIC8qKlxuICAgICogVXBkYXRlcyB0aGUgdmFsdWVzIG9mIGFuIE9iamVjdFxuICAgICogXG4gICAgKiBAcGFyYW0gbW9kZWwgVGhlIE1vZGVsIG9mIHRoZSBPYmplY3RcbiAgICAqIEBwYXJhbSBvYmogVGhlIE9iamVjdCB0byB1cGRhdGVcbiAgICAqIEBwYXJhbSBvblVwZGF0ZSBIYW5kbGVyIHRoYXQgaXMgY2FsbGVkIGFmdGVyIGFuIE9iamVjdCBoYXMgYmVlbiB1cGRhdGVkXG4gICAgKi9cbiAgIHVwZGF0ZU9iamVjdDxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG1vZGVsOiBJTW9kZWwsIG9iajogVCwgb25VcGRhdGU6IFVwZGF0ZU9iamVjdEhhbmRsZXI8VD4pOiBQcm9taXNlPHZvaWQ+XG59XG5cblxuZXhwb3J0IGNsYXNzIE9yY2hlc3RyYXRvciBpbXBsZW1lbnRzIElPcmNoZXN0cmF0b3Ige1xuICAgZ2V0IGNhY2hlKCk6IElDYWNoZSB7XG4gICAgICByZXR1cm4gdGhpcy5jb250ZXh0LmNhY2hlXG4gICB9XG5cbiAgIGdldCByZmMoKTogSVJlcXVlc3RGb3JDaGFuZ2VTb3VyY2Uge1xuICAgICAgcmV0dXJuIHRoaXMuY29udGV4dC5yZmNcbiAgIH1cblxuICAgZ2V0IHNlcmlhbGl6ZXIoKTogSVZhbHVlU2VyaWFsaXplciB7XG4gICAgICByZXR1cm4gdGhpcy5jb250ZXh0LnNlcmlhbGl6ZXJcbiAgIH1cblxuICAgZ2V0IHN0YWNrKCk6IElTdGFjayB7XG4gICAgICByZXR1cm4gdGhpcy5jb250ZXh0LnN0YWNrXG4gICB9XG5cbiAgIGdldCB1aWQoKTogSVVpZEtlZXBlciB7XG4gICAgICByZXR1cm4gdGhpcy5jb250ZXh0LnVpZFxuICAgfVxuXG4gICBjb25zdHJ1Y3RvcihyZWFkb25seSBjb250ZXh0OiBJU3RhY2tDb250ZXh0KSB7XG5cbiAgIH1cblxuICAgYXN5bmMgYm9vc3RyYXAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICBhd2FpdCB0aGlzLnJmYy5jcmVhdGUobmV3IEJvb3RzdHJhcEV2ZW50KCkpXG4gICAgICAgICAuZnVsZmlsbChhc3luYyAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc3RhY2suZW1pdChFdmVudFNldC5Cb290c3RyYXAsIGV2ZW50KVxuICAgICAgICAgfSlcbiAgICAgICAgIC5jb21taXQoKVxuICAgfVxuXG4gICBhc3luYyBjcmVhdGVNb2RlbChuYW1lOiBzdHJpbmcsIHBhcmFtczogTW9kZWxDcmVhdGVQYXJhbXMpOiBQcm9taXNlPElNb2RlbD4ge1xuICAgICAgbGV0IG1vZGVsID0gYXdhaXQgdGhpcy5zdGFjay5nZXQubW9kZWwobmFtZSlcblxuICAgICAgaWYobW9kZWwgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBBIE1vZGVsIHdpdGggdGhlIG5hbWUgJHtuYW1lfSBhbHJlYWR5IGV4aXN0c2ApXG4gICAgICB9XG5cbiAgICAgIGxldCBpZCA9IGF3YWl0IHRoaXMudWlkLmdlbmVyYXRlKClcblxuICAgICAgbW9kZWwgPSBuZXcgTW9kZWwobmFtZSwgaWQsIHRoaXMuY29udGV4dClcbiAgICAgIGF3YWl0IG1vZGVsLmFwcGVuZChwYXJhbXMpXG5cbiAgICAgIHRoaXMuY2FjaGUuc2F2ZU1vZGVsKG1vZGVsKVxuXG4gICAgICBhd2FpdCB0aGlzLnJmYy5jcmVhdGUobmV3IENyZWF0ZU1vZGVsRXZlbnQobW9kZWwpKVxuICAgICAgICAgLmZ1bGZpbGwoYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YWNrLmVtaXQoRXZlbnRTZXQuTW9kZWxDcmVhdGVkLCBldmVudClcbiAgICAgICAgIH0pXG4gICAgICAgICAuY29tbWl0KClcblxuICAgICAgcmV0dXJuIG1vZGVsXG4gICB9XG5cbiAgIGFzeW5jIGRlbGV0ZU1vZGVsKG1vZGVsOiBJTW9kZWwpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIGF3YWl0IHRoaXMucmZjLmNyZWF0ZShuZXcgRGVsZXRlTW9kZWxFdmVudChtb2RlbCkpXG4gICAgICAgICAuZnVsZmlsbCggYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlLmRlbGV0ZU1vZGVsKG1vZGVsLm5hbWUpXG4gICAgICAgICB9KVxuICAgICAgICAgLmNvbW1pdCgpXG4gICB9XG5cbiAgIC8vIE5vdGU6IFRoaXMgbWF5IG5vdCBiZSBuZWVkZWQuIFdhdGNoIGZvciB0aGlzLlxuICAgLy8gTW9kZWwncyBhcmUgc3RvcmVkIGluIGxvY2FsIGNhY2hlIGJlY2F1c2UgdGhleSBhcmVcbiAgIC8vIGRlZmluZWQgbG9jYWxseSwgYW5kIGFyZSB0aGUgY29udHJhY3QgYmV0d2VlbiB0aGVcbiAgIC8vIHRoZSBleHBlY3RlZCBkYXRhIHNldCBhbmQgd2hhdCBpcyBzdG9yZWQuXG4gICBhc3luYyBnZXRNb2RlbChuYW1lOiBzdHJpbmcpOiBQcm9taXNlPElNb2RlbCB8IHVuZGVmaW5lZD4ge1xuICAgICAgbGV0IG1vZGVsOiBJTW9kZWwgfCB1bmRlZmluZWRcblxuICAgICAgYXdhaXQgdGhpcy5yZmMuY3JlYXRlKG5ldyBHZXRNb2RlbEV2ZW50KG5hbWUpKVxuICAgICAgICAgLmZ1bGZpbGwoYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBsZXQgZ2V0TW9kZWwgPSBldmVudCBhcyBHZXRNb2RlbEV2ZW50XG4gICAgICAgICAgICBtb2RlbCA9IGdldE1vZGVsLm1vZGVsXG5cbiAgICAgICAgICAgIGlmKG1vZGVsICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgIHRoaXMuY2FjaGUuc2F2ZU1vZGVsKG1vZGVsKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YWNrLmVtaXQoRXZlbnRTZXQuR2V0TW9kZWwsIGV2ZW50KVxuICAgICAgICAgfSlcbiAgICAgICAgIC5jb21taXQoKVxuXG4gICAgICByZXR1cm4gbW9kZWxcbiAgIH1cblxuICAgYXN5bmMgdXBkYXRlTW9kZWwobW9kZWw6IElNb2RlbCwgcGFyYW1zOiBNb2RlbENyZWF0ZVBhcmFtcyk6IFByb21pc2U8dm9pZD4ge1xuXG4gICB9XG5cbiAgIGFzeW5jIGNyZWF0ZU9iamVjdDxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG1vZGVsOiBJTW9kZWwsIHBhcmFtczogT2JqZWN0Q3JlYXRlUGFyYW1zKTogUHJvbWlzZTxUPiB7XG4gICAgICBsZXQgY3JlYXRlZCA9IGF3YWl0IFByb3h5T2JqZWN0LmZyb21DcmVhdGVkPFQ+KG1vZGVsLCBwYXJhbXMsIHRoaXMuY29udGV4dCkgYXMgVFxuXG4gICAgICBhd2FpdCB0aGlzLnJmYy5jcmVhdGUobmV3IENyZWF0ZU9iamVjdEV2ZW50KG1vZGVsLCBjcmVhdGVkKSlcbiAgICAgICAgIC5mdWxmaWxsKGFzeW5jIChldmVudCkgPT4ge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFjay5lbWl0KEV2ZW50U2V0Lk9iamVjdENyZWF0ZWQsIGV2ZW50KVxuICAgICAgICAgfSlcbiAgICAgICAgIC5jb21taXQoKVxuXG4gICAgICByZXR1cm4gY3JlYXRlZFxuICAgfVxuXG4gICAvKipcbiAgICAqIFxuICAgICogQHBhcmFtIG1vZGVsIFRoZSBNb2RlbFxuICAgICogQHBhcmFtIG9iaiBUaGUgT2JqZWN0IHRvIHNhdmUuIE5vdGUgdGhhdCB0aGlzIGlzIHJlYWxseSBhIFByb3h5J2QgU2VyaWFsaXphYmxlT2JqZWN0XG4gICAgKi9cbiAgIGFzeW5jIHNhdmVPYmplY3Q8VCBleHRlbmRzIFN0YWNrT2JqZWN0Pihtb2RlbDogSU1vZGVsLCBvYmo6IFQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIGlmKG9iai5pZCA9PT0gVWlkS2VlcGVyLklkTm90U2V0KSB7XG4gICAgICAgICBvYmouaWQgPSBhd2FpdCB0aGlzLnVpZC5nZW5lcmF0ZSgpXG4gICAgICB9XG4gICAgICBcbiAgICAgIGxldCB2YWxpZGF0aW9ucyA9IGF3YWl0IG1vZGVsLnZhbGlkYXRlKG9iailcblxuICAgICAgaWYgKCF2YWxpZGF0aW9ucy5zdWNjZXNzKSB7XG4gICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBTYXZlIE9iamVjdCB3aXRoIElEICR7b2JqLmlkfSBzaW5jZSBpdCBmYWlscyB2YWxpZGF0aW9uLiBSZWFzb246ICR7dmFsaWRhdGlvbnMucmVzdWx0cy5tYXAociA9PiByLmVycm9yKX1gKVxuICAgICAgfVxuXG4gICAgICAvL0B0cy1pZ25vcmVcbiAgICAgIGxldCBzZXJpYWxpemVkID0gUHJveHlPYmplY3QudW53cmFwKG9iailcblxuICAgICAgYXdhaXQgdGhpcy5yZmMuY3JlYXRlKG5ldyBTYXZlT2JqZWN0RXZlbnQ8VD4obW9kZWwsIG9iaiwgc2VyaWFsaXplZCkpXG4gICAgICAgICAuZnVsZmlsbChhc3luYyAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGUuc2F2ZU9iamVjdChtb2RlbCwgb2JqKVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFjay5lbWl0KEV2ZW50U2V0Lk9iamVjdFNhdmVkLCBldmVudClcbiAgICAgICAgIH0pXG4gICAgICAgICAuY29tbWl0KClcbiAgIH1cblxuICAgYXN5bmMgZ2V0TWFueU9iamVjdHM8VCBleHRlbmRzIFN0YWNrT2JqZWN0Pihtb2RlbDogSU1vZGVsLCBvcHRpb25zOiBQYWdlUmVxdWVzdCA9IHsgY3Vyc29yOiAnJywgbGltaXQ6IDEwMCB9KTogUHJvbWlzZTxQYWdlUmVzcG9uc2U8VD4+IHtcbiAgICAgIGxldCByZXN1bHRzID0ge1xuICAgICAgICAgY3Vyc29yOiAnJyxcbiAgICAgICAgIGl0ZW1zOiBuZXcgQXJyYXk8VD4oKVxuICAgICAgfVxuXG4gICAgICBhd2FpdCB0aGlzLnJmYy5jcmVhdGUobmV3IEdldE1hbnlPYmplY3RzRXZlbnQobW9kZWwsIG9wdGlvbnMpKVxuICAgICAgICAgLmZ1bGZpbGwoYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBsZXQgY2FzdCA9IGV2ZW50IGFzIEdldE1hbnlPYmplY3RzRXZlbnQ8VD5cblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFjay5lbWl0KEV2ZW50U2V0LkdldE1hbnlPYmplY3RzLCBjYXN0KVxuXG4gICAgICAgICAgICBpZiAoY2FzdC5yZXN1bHRzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgIHJlc3VsdHMgPSBjYXN0LnJlc3VsdHNcbiAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgb2JqZWN0cyA9IHRoaXMuY2FjaGUuZ2V0T2JqZWN0czxUPihtb2RlbClcblxuICAgICAgICAgICAgaWYgKG9iamVjdHMubGVuZ3RoID09IDApIHtcbiAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgY3Vyc29yID0gb3B0aW9ucy5jdXJzb3IgfHwgJydcbiAgICAgICAgICAgIGxldCBsaW1pdCA9IG9wdGlvbnMubGltaXQgfHwgMTAwXG5cbiAgICAgICAgICAgIC8vIFNvcnQgYnkgSUQuIFRoZSByZXN1bHRpbmcgcGFnZWQgc2V0IGlzIG5vdCBwZXJmZWN0LCBhbmQgd2lsbCBoYXZlXG4gICAgICAgICAgICAvLyBob2xlcyB3aGVuIG5ldyBlbnRyaWVzIGFyZSBhZGRlZCBpbiBiZXR3ZWVuIHF1ZXJpZXMuXG4gICAgICAgICAgICBvYmplY3RzLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgICAgICAgIGxldCBhSWQgPSBhLmlkLnRvTG93ZXJDYXNlKClcbiAgICAgICAgICAgICAgIGxldCBiSWQgPSBiLmlkLnRvTG93ZXJDYXNlKClcbiAgICAgICAgICAgICAgIHJldHVybiAoYUlkIDwgYklkKSA/IC0xIDogKGFJZCA+IGJJZCkgPyAxIDogMFxuICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgaWYgKGN1cnNvciA9PT0gJycpIHtcbiAgICAgICAgICAgICAgIC8vIEZvciBhbiBlbXB0eSBjdXJzb3Igd2Ugc3RhcnQgZnJvbSB0aGUgYmVnaW5uaW5nXG4gICAgICAgICAgICAgICBsZXQgaXRlbXMgPSBvYmplY3RzLnNsaWNlKDAsIE1hdGgubWluKG9iamVjdHMubGVuZ3RoLCBsaW1pdCkpXG5cbiAgICAgICAgICAgICAgIGlmIChpdGVtcy5sZW5ndGggPT0gbGltaXQgJiYgb2JqZWN0cy5sZW5ndGggPiBsaW1pdCkge1xuICAgICAgICAgICAgICAgICAgcmVzdWx0cy5jdXJzb3IgPSBCdWZmZXIuZnJvbShvYmplY3RzW2xpbWl0XS5pZCkudG9TdHJpbmcoJ2Jhc2U2NCcpXG4gICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlcmUgYXJlIG5vIG1vcmUgZW50cmllcyBpbiB0aGVuZXh0IHNldCwgd2UgZGVmYXVsdCB0aGUgY3Vyc29yXG4gICAgICAgICAgICAgICAgICAvLyB0byBlbXB0eSBzdHJpbmdcbiAgICAgICAgICAgICAgICAgIHJlc3VsdHMuY3Vyc29yID0gJydcbiAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgcmVzdWx0cy5pdGVtcyA9IGl0ZW1zXG4gICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAvLyBXZSBoYXZlIGEgY3Vyc29yIGFuZCBjb250aW51ZSBmcm9tIHdoZW5jZSB3ZSBsZWZ0IG9mZlxuICAgICAgICAgICAgICAgY3Vyc29yID0gQnVmZmVyLmZyb20oY3Vyc29yLCAnYmFzZTY0JykudG9TdHJpbmcoJ2FzY2lpJylcblxuICAgICAgICAgICAgICAgbGV0IGluZGV4ID0gb2JqZWN0cy5maW5kSW5kZXgobyA9PiBvLmlkID09PSBjdXJzb3IpXG5cbiAgICAgICAgICAgICAgIGlmIChpbmRleCA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgIC8vIFdlIGdldCBoZXJlIHdoZW4gdGhlIG9iamVjdCB0aGF0J3MgbmV4dCBoYXMgYmVlbiBkZWxldGVkXG4gICAgICAgICAgICAgICAgICAvLyByZXR1cm4gZWFybHlcbiAgICAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICBsZXQgbmV4dEluZGV4ID0gaW5kZXggKyBsaW1pdFxuICAgICAgICAgICAgICAgcmVzdWx0cy5pdGVtcyA9IG9iamVjdHMuc2xpY2UoaW5kZXgsIG5leHRJbmRleClcblxuICAgICAgICAgICAgICAgaWYgKG9iamVjdHMubGVuZ3RoID4gbmV4dEluZGV4KSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHRzLmN1cnNvciA9IEJ1ZmZlci5mcm9tKG9iamVjdHNbbmV4dEluZGV4XS5pZCkudG9TdHJpbmcoJ2Jhc2U2NCcpXG4gICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlcmUgYXJlIG5vIG1vcmUgZW50cmllcyBpbiB0aGUgbmV4dCBzZXQsIHdlIGRlZmF1bHQgdGhlIGN1cnNvclxuICAgICAgICAgICAgICAgICAgLy8gdG8gZW1wdHkgc3RyaW5nXG4gICAgICAgICAgICAgICAgICByZXN1bHRzLmN1cnNvciA9ICcnXG4gICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgIH0pXG4gICAgICAgICAuY29tbWl0KClcblxuICAgICAgcmV0dXJuIHJlc3VsdHNcbiAgIH1cblxuICAgYXN5bmMgZGVsZXRlT2JqZWN0PFQgZXh0ZW5kcyBTdGFja09iamVjdD4obW9kZWw6IElNb2RlbCwgb2JqOiBUKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICBhd2FpdCB0aGlzLnJmYy5jcmVhdGUobmV3IERlbGV0ZU9iamVjdEV2ZW50KG1vZGVsLCBvYmopKVxuICAgICAgICAgLmZ1bGZpbGwoYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlLmRlbGV0ZU9iamVjdChtb2RlbCwgb2JqKVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFjay5lbWl0KEV2ZW50U2V0Lk9iamVjdERlbGV0ZWQsIGV2ZW50KVxuICAgICAgICAgfSlcbiAgICAgICAgIC5jb21taXQoKVxuICAgfVxuXG4gICBhc3luYyBnZXRPYmplY3Q8VCBleHRlbmRzIFN0YWNrT2JqZWN0Pihtb2RlbDogSU1vZGVsLCBpZDogc3RyaW5nKTogUHJvbWlzZTxUIHwgdW5kZWZpbmVkPiB7XG4gICAgICBsZXQgb2JqZWN0OiBUIHwgdW5kZWZpbmVkXG5cbiAgICAgIGF3YWl0IHRoaXMucmZjLmNyZWF0ZShuZXcgR2V0T2JqZWN0RXZlbnQobW9kZWwsIGlkKSlcbiAgICAgICAgIC5mdWxmaWxsKGFzeW5jIChldmVudCkgPT4ge1xuICAgICAgICAgICAgbGV0IGNhc3QgPSBldmVudCBhcyBHZXRPYmplY3RFdmVudDxUPlxuXG4gICAgICAgICAgICBpZiAoY2FzdC5vYmplY3QgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgb2JqZWN0ID0gY2FzdC5leGlzdHMgPT09IEV4aXN0U3RhdGUuRG9lc05vdEV4aXN0ID9cbiAgICAgICAgICAgICAgICAgIHVuZGVmaW5lZCA6XG4gICAgICAgICAgICAgICAgICB0aGlzLmNhY2hlLmdldE9iamVjdChtb2RlbCwgaWQpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgLy8gV2UgZ2V0IGEgc2VyaWFsaXplZCB2ZXJzaW9uIG9mIHRoZSBPYmplY3RcbiAgICAgICAgICAgICAgIGxldCBzZXJpYWxpemVkID0gYXdhaXQgUHJveHlPYmplY3QuZnJvbVN0b3JlZChtb2RlbCwgY2FzdC5vYmplY3QsIHRoaXMuY29udGV4dC5zZXJpYWxpemVyKVxuICAgICAgICAgICAgICAgdGhpcy5jYWNoZS5zYXZlT2JqZWN0KG1vZGVsLCBzZXJpYWxpemVkKVxuXG4gICAgICAgICAgICAgICAvL0B0cy1pZ25vcmVcbiAgICAgICAgICAgICAgIG9iamVjdCA9IHNlcmlhbGl6ZWQgYXMgVFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN0YWNrLmVtaXQoRXZlbnRTZXQuR2V0T2JqZWN0LCBldmVudClcbiAgICAgICAgIH0pXG4gICAgICAgICAuY29tbWl0KClcblxuICAgICAgcmV0dXJuIG9iamVjdFxuICAgfVxuXG4gICBhc3luYyBoYXNJZChpZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICBsZXQgaGFzSWQgPSBmYWxzZVxuXG4gICAgICBhd2FpdCB0aGlzLnJmYy5jcmVhdGUobmV3IEhhc0lkRXZlbnQoaWQpKVxuICAgICAgICAgLmZ1bGZpbGwoYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBsZXQgY2FzdCA9IGV2ZW50IGFzIEhhc0lkRXZlbnRcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFjay5lbWl0KEV2ZW50U2V0Lkhhc0lkLCBldmVudClcblxuICAgICAgICAgICAgaWYgKGNhc3QuaGFzSWQpIHtcbiAgICAgICAgICAgICAgIGhhc0lkID0gdHJ1ZVxuICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIEhhcyBpdCBhIHBsdWdpbiBhdHRlbXB0ZWQgdG8gc2V0IGl0P1xuICAgICAgICAgICAgaWYgKGNhc3QuYXR0ZW1wdGVkU2V0KSB7XG4gICAgICAgICAgICAgICAvLyBJZiBzbywgd2UgY2FuIHRydXN0IHRoYXQgYW4gZXh0ZXJuYWwgc3lzdGVtIGRvZXNuJ3QgaGF2ZSBpdFxuICAgICAgICAgICAgICAgaGFzSWQgPSBmYWxzZVxuICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIElmIG5vIGV4dGVybmFsIHN5c3RlbSBhdHRlbXB0ZWQgdG8gc2V0IGl0LCBkbyB3ZSBoYXZlIGl0IGNhY2hlZD9cbiAgICAgICAgICAgIGhhc0lkID0gdGhpcy5jYWNoZS5oYXNJZChpZClcblxuICAgICAgICAgfSlcbiAgICAgICAgIC5jb21taXQoKVxuXG4gICAgICByZXR1cm4gaGFzSWRcbiAgIH1cblxuICAgYXN5bmMgdXBkYXRlT2JqZWN0PFQgZXh0ZW5kcyBTdGFja09iamVjdD4obW9kZWw6IElNb2RlbCwgb2JqOiBULCBvblVwZGF0ZTogVXBkYXRlT2JqZWN0SGFuZGxlcjxUPik6IFByb21pc2U8dm9pZD4ge1xuICAgICAgYXdhaXQgdGhpcy5yZmMuY3JlYXRlKG5ldyBVcGRhdGVPYmplY3RFdmVudDxUPihtb2RlbCwgb2JqKSlcbiAgICAgICAgIC5mdWxmaWxsKGFzeW5jIChldmVudCkgPT4ge1xuICAgICAgICAgICAgbGV0IGNhc3QgPSBldmVudCBhcyBVcGRhdGVPYmplY3RFdmVudDxUPlxuXG4gICAgICAgICAgICBsZXQgdXBkYXRlZCA9IGNhc3QudXBkYXRlZFxuXG4gICAgICAgICAgICBhd2FpdCBvblVwZGF0ZSh1cGRhdGVkLCBjYXN0LmV4aXN0cylcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5zdGFjay5lbWl0KEV2ZW50U2V0Lk9iamVjdFVwZGF0ZWQsIGV2ZW50KVxuICAgICAgICAgfSlcbiAgICAgICAgIC5jb21taXQoKVxuICAgfVxufSJdfQ==