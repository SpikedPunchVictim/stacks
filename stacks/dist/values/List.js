"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ListSerializer = exports.ListValue = exports.ListType = void 0;
const ValueSerializer_1 = require("../serialize/ValueSerializer");
const Type_1 = require("./Type");
const Value_1 = require("./Value");
class ListType extends Type_1.Type {
    get info() {
        return {
            type: this.type,
            itemType: this.itemType.info
        };
    }
    constructor(itemType) {
        super(Type_1.TypeSet.List);
        this.itemType = itemType;
    }
    equals(other) {
        if (other.type !== Type_1.TypeSet.List) {
            return false;
        }
        let cast = other;
        if (!this.itemType.equals(cast.itemType)) {
            return false;
        }
        return true;
    }
    async validate(obj) {
        if (!Array.isArray(obj)) {
            return { success: false, error: new Error(`Type does not match. Expected 'Array' but receieved '${typeof obj}' instead.`) };
        }
        let array = obj;
        for (let i = 0; i < array.length; ++i) {
            let valid = await this.itemType.validate(array[i]);
            if (valid.success == false) {
                return { success: false, error: new Error(`Encountered an error when validating the items in a List. Reason: ${valid.error}`) };
            }
        }
        return { success: true };
    }
}
exports.ListType = ListType;
class ListValue extends Value_1.Value {
    constructor(itemType, serializer) {
        super(new ListType(itemType));
        this.itemType = itemType;
        this.serializer = serializer;
        this.items = new Array();
    }
    [Symbol.iterator]() {
        let index = 0;
        let self = this;
        return {
            next() {
                return index == self.items.length ?
                    { value: undefined, done: true } :
                    { value: self.items[index++], done: false };
            }
        };
    }
    at(index) {
        return this.items.at(index);
    }
    clear() {
        this.items.splice(0, this.items.length);
    }
    clone() {
        let list = new ListValue(this.itemType, this.serializer);
        list.push(...this.items);
        return list;
    }
    equals(other) {
        if (!this.type.equals(other.type)) {
            return false;
        }
        let list = other;
        if (list.items.length != this.items.length) {
            return false;
        }
        for (let i = 0; i < this.items.length; ++i) {
            let thisItem = this.items[i];
            let otherItem = list.items[i];
            if (!thisItem.equals(otherItem)) {
                return false;
            }
        }
        return true;
    }
    push(...items) {
        return this.items.push(...items);
    }
    set(value) {
        if (!this.type.equals(value.type)) {
            throw new Error(`Cannot set a List Value with a different type. Encountered ${value.type.type} when setting the value of a List.`);
        }
        let list = value;
        this.items.splice(0, this.items.length);
        this.items.push(...list.items);
        return this;
    }
    async toJs() {
        let results = new Array();
        for (let i = 0; i < this.items.length; ++i) {
            results.push(await this.serializer.toJs(this.items[i]));
        }
        return results;
    }
}
exports.ListValue = ListValue;
class ListSerializer extends ValueSerializer_1.ValueSerializer {
    constructor(serializer) {
        super(Type_1.TypeSet.List);
        this.serializer = serializer;
    }
    async toJs(value) {
        this.validate(value.type);
        let results = new Array();
        let list = value;
        for (let value of list) {
            results.push(await this.serializer.toJs(value));
        }
        return results;
    }
    async fromJs(type, obj) {
        this.validate(type);
        if (!Array.isArray(obj)) {
            throw new Error(`The JS object type does not match what's expected when serializing. Expected a List and received a ${typeof obj}`);
        }
        let listType = type;
        let list = new ListValue(listType.itemType, this.serializer);
        for (let val of obj) {
            list.push(await this.serializer.fromJs(listType.itemType, val));
        }
        return list;
    }
}
exports.ListSerializer = ListSerializer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTGlzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy92YWx1ZXMvTGlzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxrRUFBZ0Y7QUFDaEYsaUNBQXVFO0FBQ3ZFLG1DQUF1QztBQUd2QyxNQUFhLFFBQVMsU0FBUSxXQUFJO0lBQy9CLElBQUksSUFBSTtRQUNMLE9BQU87WUFDSixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7WUFDZixRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJO1NBQzlCLENBQUE7SUFDSixDQUFDO0lBRUQsWUFBcUIsUUFBZTtRQUNqQyxLQUFLLENBQUMsY0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBREQsYUFBUSxHQUFSLFFBQVEsQ0FBTztJQUVwQyxDQUFDO0lBRUQsTUFBTSxDQUFDLEtBQVk7UUFDaEIsSUFBRyxLQUFLLENBQUMsSUFBSSxLQUFLLGNBQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUM5QixPQUFPLEtBQUssQ0FBQTtRQUNmLENBQUM7UUFFRCxJQUFJLElBQUksR0FBRyxLQUFpQixDQUFBO1FBRTVCLElBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztZQUN2QyxPQUFPLEtBQUssQ0FBQTtRQUNmLENBQUM7UUFFRCxPQUFPLElBQUksQ0FBQTtJQUNkLENBQUM7SUFFRCxLQUFLLENBQUMsUUFBUSxDQUFJLEdBQU07UUFDckIsSUFBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUN0QixPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxLQUFLLENBQUMsd0RBQXdELE9BQU8sR0FBRyxZQUFZLENBQUMsRUFBQyxDQUFBO1FBQzdILENBQUM7UUFFRCxJQUFJLEtBQUssR0FBRyxHQUFlLENBQUE7UUFFM0IsS0FBSSxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQztZQUNwQyxJQUFJLEtBQUssR0FBRyxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBRWxELElBQUcsS0FBSyxDQUFDLE9BQU8sSUFBSSxLQUFLLEVBQUUsQ0FBQztnQkFDekIsT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLElBQUksS0FBSyxDQUFDLHFFQUFxRSxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUMsRUFBQyxDQUFBO1lBQ2pJLENBQUM7UUFDSixDQUFDO1FBRUQsT0FBTyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQTtJQUMzQixDQUFDO0NBQ0g7QUEzQ0QsNEJBMkNDO0FBRUQsTUFBYSxTQUFVLFNBQVEsYUFBSztJQUdqQyxZQUFxQixRQUFlLEVBQVcsVUFBNEI7UUFDeEUsS0FBSyxDQUFDLElBQUksUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUE7UUFEWCxhQUFRLEdBQVIsUUFBUSxDQUFPO1FBQVcsZUFBVSxHQUFWLFVBQVUsQ0FBa0I7UUFGbkUsVUFBSyxHQUFrQixJQUFJLEtBQUssRUFBVSxDQUFBO0lBSWxELENBQUM7SUFFRCxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFDZCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUE7UUFDYixJQUFJLElBQUksR0FBRyxJQUFJLENBQUE7UUFDZixPQUFPO1lBQ0osSUFBSTtnQkFDRCxPQUFPLEtBQUssSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUNoQyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7b0JBQ2xDLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLENBQUE7WUFDakQsQ0FBQztTQUNILENBQUE7SUFDSixDQUFDO0lBRUQsRUFBRSxDQUFDLEtBQWE7UUFDYixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBQzlCLENBQUM7SUFFRCxLQUFLO1FBQ0YsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUE7SUFDMUMsQ0FBQztJQUVELEtBQUs7UUFDRixJQUFJLElBQUksR0FBRyxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQTtRQUN4RCxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ3hCLE9BQU8sSUFBSSxDQUFBO0lBQ2QsQ0FBQztJQUVELE1BQU0sQ0FBQyxLQUFhO1FBQ2pCLElBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUNoQyxPQUFPLEtBQUssQ0FBQTtRQUNmLENBQUM7UUFFRCxJQUFJLElBQUksR0FBRyxLQUFrQixDQUFBO1FBRTdCLElBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUN6QyxPQUFPLEtBQUssQ0FBQTtRQUNmLENBQUM7UUFFRCxLQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQztZQUN6QyxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQzVCLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFFN0IsSUFBRyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztnQkFDOUIsT0FBTyxLQUFLLENBQUE7WUFDZixDQUFDO1FBQ0osQ0FBQztRQUVELE9BQU8sSUFBSSxDQUFBO0lBQ2QsQ0FBQztJQUVELElBQUksQ0FBQyxHQUFHLEtBQWU7UUFDcEIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFBO0lBQ25DLENBQUM7SUFFRCxHQUFHLENBQUMsS0FBYTtRQUNkLElBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUNoQyxNQUFNLElBQUksS0FBSyxDQUFDLDhEQUE4RCxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksb0NBQW9DLENBQUMsQ0FBQTtRQUNySSxDQUFDO1FBRUQsSUFBSSxJQUFJLEdBQUcsS0FBa0IsQ0FBQTtRQUU3QixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUN2QyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUU5QixPQUFPLElBQUksQ0FBQTtJQUNkLENBQUM7SUFFRCxLQUFLLENBQUMsSUFBSTtRQUNQLElBQUksT0FBTyxHQUFHLElBQUksS0FBSyxFQUFPLENBQUE7UUFFOUIsS0FBSSxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUM7WUFDekMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQzFELENBQUM7UUFFRCxPQUFPLE9BQU8sQ0FBQTtJQUNqQixDQUFDO0NBQ0g7QUFsRkQsOEJBa0ZDO0FBRUQsTUFBYSxjQUFlLFNBQVEsaUNBQWU7SUFDaEQsWUFBcUIsVUFBNEI7UUFDOUMsS0FBSyxDQUFDLGNBQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQURELGVBQVUsR0FBVixVQUFVLENBQWtCO0lBRWpELENBQUM7SUFFRCxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQWE7UUFDckIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFekIsSUFBSSxPQUFPLEdBQUcsSUFBSSxLQUFLLEVBQU8sQ0FBQTtRQUU5QixJQUFJLElBQUksR0FBRyxLQUFrQixDQUFBO1FBRTdCLEtBQUksSUFBSSxLQUFLLElBQUksSUFBSSxFQUFFLENBQUM7WUFDckIsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7UUFDbEQsQ0FBQztRQUVELE9BQU8sT0FBTyxDQUFBO0lBQ2pCLENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTSxDQUFDLElBQVcsRUFBRSxHQUFRO1FBQy9CLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFbkIsSUFBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUN0QixNQUFNLElBQUksS0FBSyxDQUFDLHNHQUFzRyxPQUFPLEdBQUcsRUFBRSxDQUFDLENBQUE7UUFDdEksQ0FBQztRQUVELElBQUksUUFBUSxHQUFHLElBQWdCLENBQUE7UUFFL0IsSUFBSSxJQUFJLEdBQUcsSUFBSSxTQUFTLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUE7UUFFNUQsS0FBSSxJQUFJLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztZQUNsQixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFBO1FBQ2xFLENBQUM7UUFFRCxPQUFPLElBQUksQ0FBQTtJQUNkLENBQUM7Q0FDSDtBQXBDRCx3Q0FvQ0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJVmFsdWVTZXJpYWxpemVyLCBWYWx1ZVNlcmlhbGl6ZXIgfSBmcm9tIFwiLi4vc2VyaWFsaXplL1ZhbHVlU2VyaWFsaXplclwiXG5pbXBvcnQgeyBJVHlwZSwgVHlwZSwgVHlwZUluZm8sIFR5cGVTZXQsIFZhbGlkYXRlUmVzdWx0IH0gZnJvbSBcIi4vVHlwZVwiXG5pbXBvcnQgeyBJVmFsdWUsIFZhbHVlIH0gZnJvbSBcIi4vVmFsdWVcIlxuXG5cbmV4cG9ydCBjbGFzcyBMaXN0VHlwZSBleHRlbmRzIFR5cGUge1xuICAgZ2V0IGluZm8oKTogVHlwZUluZm8ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgIHR5cGU6IHRoaXMudHlwZSxcbiAgICAgICAgIGl0ZW1UeXBlOiB0aGlzLml0ZW1UeXBlLmluZm9cbiAgICAgIH1cbiAgIH1cblxuICAgY29uc3RydWN0b3IocmVhZG9ubHkgaXRlbVR5cGU6IElUeXBlKSB7XG4gICAgICBzdXBlcihUeXBlU2V0Lkxpc3QpXG4gICB9XG5cbiAgIGVxdWFscyhvdGhlcjogSVR5cGUpOiBib29sZWFuIHtcbiAgICAgIGlmKG90aGVyLnR5cGUgIT09IFR5cGVTZXQuTGlzdCkge1xuICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9XG5cbiAgICAgIGxldCBjYXN0ID0gb3RoZXIgYXMgTGlzdFR5cGVcblxuICAgICAgaWYoIXRoaXMuaXRlbVR5cGUuZXF1YWxzKGNhc3QuaXRlbVR5cGUpKSB7XG4gICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRydWVcbiAgIH1cblxuICAgYXN5bmMgdmFsaWRhdGU8VD4ob2JqOiBUKTogUHJvbWlzZTxWYWxpZGF0ZVJlc3VsdD4ge1xuICAgICAgaWYoIUFycmF5LmlzQXJyYXkob2JqKSkge1xuICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBuZXcgRXJyb3IoYFR5cGUgZG9lcyBub3QgbWF0Y2guIEV4cGVjdGVkICdBcnJheScgYnV0IHJlY2VpZXZlZCAnJHt0eXBlb2Ygb2JqfScgaW5zdGVhZC5gKX1cbiAgICAgIH1cblxuICAgICAgbGV0IGFycmF5ID0gb2JqIGFzIEFycmF5PFQ+XG5cbiAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7ICsraSkge1xuICAgICAgICAgbGV0IHZhbGlkID0gYXdhaXQgdGhpcy5pdGVtVHlwZS52YWxpZGF0ZShhcnJheVtpXSlcblxuICAgICAgICAgaWYodmFsaWQuc3VjY2VzcyA9PSBmYWxzZSkge1xuICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBuZXcgRXJyb3IoYEVuY291bnRlcmVkIGFuIGVycm9yIHdoZW4gdmFsaWRhdGluZyB0aGUgaXRlbXMgaW4gYSBMaXN0LiBSZWFzb246ICR7dmFsaWQuZXJyb3J9YCl9XG4gICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfVxuICAgfVxufVxuXG5leHBvcnQgY2xhc3MgTGlzdFZhbHVlIGV4dGVuZHMgVmFsdWUge1xuICAgcHJpdmF0ZSBpdGVtczogQXJyYXk8SVZhbHVlPiA9IG5ldyBBcnJheTxJVmFsdWU+KClcbiAgIFxuICAgY29uc3RydWN0b3IocmVhZG9ubHkgaXRlbVR5cGU6IElUeXBlLCByZWFkb25seSBzZXJpYWxpemVyOiBJVmFsdWVTZXJpYWxpemVyKSB7XG4gICAgICBzdXBlcihuZXcgTGlzdFR5cGUoaXRlbVR5cGUpKVxuICAgfVxuXG4gICBbU3ltYm9sLml0ZXJhdG9yXSgpOiBJdGVyYXRvcjxJVmFsdWU+IHtcbiAgICAgIGxldCBpbmRleCA9IDBcbiAgICAgIGxldCBzZWxmID0gdGhpc1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgIG5leHQoKTogSXRlcmF0b3JSZXN1bHQ8SVZhbHVlPiB7XG4gICAgICAgICAgICByZXR1cm4gaW5kZXggPT0gc2VsZi5pdGVtcy5sZW5ndGggP1xuICAgICAgICAgICAgICAgeyB2YWx1ZTogdW5kZWZpbmVkLCBkb25lOiB0cnVlIH0gOlxuICAgICAgICAgICAgICAgeyB2YWx1ZTogc2VsZi5pdGVtc1tpbmRleCsrXSwgZG9uZTogZmFsc2UgfVxuICAgICAgICAgfVxuICAgICAgfVxuICAgfVxuXG4gICBhdChpbmRleDogbnVtYmVyKTogSVZhbHVlIHwgdW5kZWZpbmVkIHtcbiAgICAgIHJldHVybiB0aGlzLml0ZW1zLmF0KGluZGV4KVxuICAgfVxuXG4gICBjbGVhcigpOiB2b2lkIHtcbiAgICAgIHRoaXMuaXRlbXMuc3BsaWNlKDAsIHRoaXMuaXRlbXMubGVuZ3RoKVxuICAgfVxuXG4gICBjbG9uZSgpOiBJVmFsdWUge1xuICAgICAgbGV0IGxpc3QgPSBuZXcgTGlzdFZhbHVlKHRoaXMuaXRlbVR5cGUsIHRoaXMuc2VyaWFsaXplcilcbiAgICAgIGxpc3QucHVzaCguLi50aGlzLml0ZW1zKVxuICAgICAgcmV0dXJuIGxpc3RcbiAgIH1cblxuICAgZXF1YWxzKG90aGVyOiBJVmFsdWUpOiBib29sZWFuIHtcbiAgICAgIGlmKCF0aGlzLnR5cGUuZXF1YWxzKG90aGVyLnR5cGUpKSB7XG4gICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cblxuICAgICAgbGV0IGxpc3QgPSBvdGhlciBhcyBMaXN0VmFsdWVcblxuICAgICAgaWYobGlzdC5pdGVtcy5sZW5ndGggIT0gdGhpcy5pdGVtcy5sZW5ndGgpIHtcbiAgICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfVxuXG4gICAgICBmb3IobGV0IGkgPSAwOyBpIDwgdGhpcy5pdGVtcy5sZW5ndGg7ICsraSkge1xuICAgICAgICAgbGV0IHRoaXNJdGVtID0gdGhpcy5pdGVtc1tpXVxuICAgICAgICAgbGV0IG90aGVySXRlbSA9IGxpc3QuaXRlbXNbaV1cblxuICAgICAgICAgaWYoIXRoaXNJdGVtLmVxdWFscyhvdGhlckl0ZW0pKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRydWUgICAgICBcbiAgIH1cblxuICAgcHVzaCguLi5pdGVtczogSVZhbHVlW10pOiBudW1iZXIge1xuICAgICAgcmV0dXJuIHRoaXMuaXRlbXMucHVzaCguLi5pdGVtcylcbiAgIH1cblxuICAgc2V0KHZhbHVlOiBJVmFsdWUpOiBJVmFsdWUge1xuICAgICAgaWYoIXRoaXMudHlwZS5lcXVhbHModmFsdWUudHlwZSkpIHtcbiAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHNldCBhIExpc3QgVmFsdWUgd2l0aCBhIGRpZmZlcmVudCB0eXBlLiBFbmNvdW50ZXJlZCAke3ZhbHVlLnR5cGUudHlwZX0gd2hlbiBzZXR0aW5nIHRoZSB2YWx1ZSBvZiBhIExpc3QuYClcbiAgICAgIH1cblxuICAgICAgbGV0IGxpc3QgPSB2YWx1ZSBhcyBMaXN0VmFsdWVcblxuICAgICAgdGhpcy5pdGVtcy5zcGxpY2UoMCwgdGhpcy5pdGVtcy5sZW5ndGgpXG4gICAgICB0aGlzLml0ZW1zLnB1c2goLi4ubGlzdC5pdGVtcylcblxuICAgICAgcmV0dXJuIHRoaXNcbiAgIH1cblxuICAgYXN5bmMgdG9KcygpOiBQcm9taXNlPGFueT4ge1xuICAgICAgbGV0IHJlc3VsdHMgPSBuZXcgQXJyYXk8YW55PigpXG5cbiAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCB0aGlzLml0ZW1zLmxlbmd0aDsgKytpKSB7XG4gICAgICAgICByZXN1bHRzLnB1c2goYXdhaXQgdGhpcy5zZXJpYWxpemVyLnRvSnModGhpcy5pdGVtc1tpXSkpXG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXN1bHRzXG4gICB9XG59XG5cbmV4cG9ydCBjbGFzcyBMaXN0U2VyaWFsaXplciBleHRlbmRzIFZhbHVlU2VyaWFsaXplciB7XG4gICBjb25zdHJ1Y3RvcihyZWFkb25seSBzZXJpYWxpemVyOiBJVmFsdWVTZXJpYWxpemVyKSB7XG4gICAgICBzdXBlcihUeXBlU2V0Lkxpc3QpXG4gICB9XG5cbiAgIGFzeW5jIHRvSnModmFsdWU6IElWYWx1ZSk6IFByb21pc2U8YW55PiB7XG4gICAgICB0aGlzLnZhbGlkYXRlKHZhbHVlLnR5cGUpXG5cbiAgICAgIGxldCByZXN1bHRzID0gbmV3IEFycmF5PGFueT4oKVxuXG4gICAgICBsZXQgbGlzdCA9IHZhbHVlIGFzIExpc3RWYWx1ZVxuXG4gICAgICBmb3IobGV0IHZhbHVlIG9mIGxpc3QpIHtcbiAgICAgICAgIHJlc3VsdHMucHVzaChhd2FpdCB0aGlzLnNlcmlhbGl6ZXIudG9Kcyh2YWx1ZSkpXG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXN1bHRzXG4gICB9XG5cbiAgIGFzeW5jIGZyb21Kcyh0eXBlOiBJVHlwZSwgb2JqOiBhbnkpOiBQcm9taXNlPElWYWx1ZT4ge1xuICAgICAgdGhpcy52YWxpZGF0ZSh0eXBlKVxuXG4gICAgICBpZighQXJyYXkuaXNBcnJheShvYmopKSB7XG4gICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBKUyBvYmplY3QgdHlwZSBkb2VzIG5vdCBtYXRjaCB3aGF0J3MgZXhwZWN0ZWQgd2hlbiBzZXJpYWxpemluZy4gRXhwZWN0ZWQgYSBMaXN0IGFuZCByZWNlaXZlZCBhICR7dHlwZW9mIG9ian1gKVxuICAgICAgfVxuXG4gICAgICBsZXQgbGlzdFR5cGUgPSB0eXBlIGFzIExpc3RUeXBlXG5cbiAgICAgIGxldCBsaXN0ID0gbmV3IExpc3RWYWx1ZShsaXN0VHlwZS5pdGVtVHlwZSwgdGhpcy5zZXJpYWxpemVyKVxuXG4gICAgICBmb3IobGV0IHZhbCBvZiBvYmopIHtcbiAgICAgICAgIGxpc3QucHVzaChhd2FpdCB0aGlzLnNlcmlhbGl6ZXIuZnJvbUpzKGxpc3RUeXBlLml0ZW1UeXBlLCB2YWwpKVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gbGlzdFxuICAgfVxufSJdfQ==