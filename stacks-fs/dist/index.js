"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FsPlugin = void 0;
const path = require("path");
const stacks_1 = require("@spikedpunch/stacks");
const fs = require("fs-extra");
const TempFileExt = '.temp';
/**
 * File system plugin for Stacks
 *
 * Notes:
 *    * GetMany cursor points to the next file in a sorted list
 */
class FsPlugin {
    constructor(baseDir, options) {
        this.baseDir = baseDir;
        this.name = 'stacks-fs';
        this.version = undefined; // The plugin version
        // TODO: Normalize baseDir (~, .., etc)
        this.options = options || {};
    }
    /*
 export enum EventSet {
    Bootstrap = 'bootstrap',
    GetManyObjects = 'get-many-objects',
    GetModel = 'get-model',
    GetObject = 'get-object',
    HasId = 'has-id',
    ModelCreated = 'model-created',
    ModelDeleted = 'model-deleted',
    ModelUpdated = 'model-updated',
    ObjectCreated = 'object-created',
    ObjectDeleted = 'object-deleted',
    ObjectUpdated = 'object-updated',
    ObjectSaved = 'object-saved'
 }
    */
    async setup(stack, router) {
        await fs.ensureDir(this.baseDir);
        //-------------------------------------------------------------------------------------------
        router.on(stacks_1.EventSet.Bootstrap, async (event) => {
            for (let model of stack.get.models()) {
                await this.setupModel(model);
            }
        });
        //-------------------------------------------------------------------------------------------
        router.on(stacks_1.EventSet.GetManyObjects, async (event) => {
            let modelDir = this.getModelDir(event.model.name);
            let reqCursor = event.page.cursor || '';
            let reqCount = event.page.limit == null ? 100 : event.page.limit;
            // Ignore any Temp files that may be in the directory
            let files = await fs.readdir(modelDir);
            files = files.filter(it => path.parse(it).ext !== TempFileExt);
            files.sort();
            let cursor = '';
            let startIndex = 0;
            let requestedFiles = new Array();
            // The cursor becomes the next file one in the sorted list
            if (reqCursor !== '') {
                let names = files.map(f => path.parse(f).name);
                let decodedCursor = Buffer.from(reqCursor, 'base64').toString('ascii');
                let found = names.findIndex(it => it === decodedCursor);
                if (found < 0) {
                    found = 0;
                    event.wasCursorFound = false;
                }
                else {
                    startIndex = found;
                }
            }
            let endIndex = reqCount + startIndex;
            requestedFiles = files.slice(startIndex, endIndex);
            if (endIndex < (files.length - 1)) {
                let parsed = path.parse(path.join(this.baseDir, files[endIndex]));
                cursor = parsed.name;
            }
            else {
                cursor = '';
            }
            let objects = new Array();
            for (let file of requestedFiles) {
                objects.push({
                    id: file.slice(0, (".json".length * -1)),
                    ...await fs.readJson(path.join(modelDir, file))
                });
            }
            event.results = {
                cursor: cursor === '' ? '' : Buffer.from(cursor).toString('base64'),
                items: objects
            };
        });
        router.on(stacks_1.EventSet.GetStoreContext, async (event) => {
            if (this.version === undefined) {
                let pkg = await fs.readJson(path.join(__dirname, '..', 'package.json'));
                this.version = pkg.version;
            }
            event.contexts.push({
                name: 'stacks:fs',
                version: this.version || 'version-not-set',
                store: {
                    baseDir: this.baseDir,
                    options: this.options,
                    fs: fs
                }
            });
        });
        //-------------------------------------------------------------------------------------------
        router.on(stacks_1.EventSet.ObjectSaved, async (event) => {
            let modelDir = this.getModelDir(event.model.name);
            try {
                await fs.ensureDir(modelDir);
                await fs.writeJson(path.join(modelDir, `${event.serialize.id}.json`), event.serialize.toJs(), { spaces: 2 });
            }
            catch (err) {
                throw new Error(`[stacks-fs] Failed to save object. Reason: ${err}`);
            }
        });
        //-------------------------------------------------------------------------------------------
        router.on(stacks_1.EventSet.GetObject, async (event) => {
            let objectPath = this.getObjectPath(event.model.name, event.id);
            try {
                let obj = await fs.readJson(objectPath);
                event.object = obj;
            }
            catch (err) {
                throw new Error(`[stacks-fs] Failed to retrieve Object ${event.id}. Reason ${err}`);
            }
        });
        //-------------------------------------------------------------------------------------------
        router.on(stacks_1.EventSet.ObjectDeleted, async (event) => {
            let objectPath = this.getObjectPath(event.model.name, event.object.id);
            try {
                await fs.remove(objectPath);
            }
            catch (err) {
                throw new Error(`[stacks-fs] Failed to delete an Object ${event.object.id}. Reason ${err}`);
            }
        });
        //-------------------------------------------------------------------------------------------
        router.on(stacks_1.EventSet.ObjectUpdated, async (event) => {
            let objectPath = this.getObjectPath(event.model.name, event.object.id);
            try {
                await fs.access(objectPath);
                event.exists = stacks_1.ExistState.Exists;
                event.updated = await fs.readJson(objectPath);
            }
            catch (err) {
                event.exists = stacks_1.ExistState.DoesNotExist;
            }
        });
    }
    getModelDir(modelName) {
        return path.join(this.baseDir, modelName);
    }
    getObjectPath(modelName, objectId) {
        let modelDir = this.getModelDir(modelName);
        return path.join(modelDir, `${objectId}.json`);
    }
    async setupModel(model) {
        let modelDir = this.getModelDir(model.name);
        await fs.ensureDir(modelDir);
    }
}
exports.FsPlugin = FsPlugin;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsNkJBQTRCO0FBQzVCLGdEQWU0QjtBQUU1QiwrQkFBOEI7QUFFOUIsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFBO0FBTTNCOzs7OztHQUtHO0FBQ0gsTUFBYSxRQUFRO0lBTWxCLFlBQXFCLE9BQWUsRUFBRSxPQUFtQjtRQUFwQyxZQUFPLEdBQVAsT0FBTyxDQUFRO1FBTDNCLFNBQUksR0FBVyxXQUFXLENBQUE7UUFHM0IsWUFBTyxHQUF1QixTQUFTLENBQUEsQ0FBQyxxQkFBcUI7UUFHbEUsdUNBQXVDO1FBQ3ZDLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxJQUFJLEVBQUUsQ0FBQTtJQUMvQixDQUFDO0lBR0Q7Ozs7Ozs7Ozs7Ozs7OztNQWVFO0lBQ0YsS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFhLEVBQUUsTUFBb0I7UUFDNUMsTUFBTSxFQUFFLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUVoQyw2RkFBNkY7UUFDN0YsTUFBTSxDQUFDLEVBQUUsQ0FBaUIsaUJBQVEsQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLEtBQXFCLEVBQUUsRUFBRTtZQUMzRSxLQUFLLElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQztnQkFDcEMsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFBO1lBQy9CLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQTtRQUVGLDZGQUE2RjtRQUM3RixNQUFNLENBQUMsRUFBRSxDQUFtQyxpQkFBUSxDQUFDLGNBQWMsRUFBRSxLQUFLLEVBQUUsS0FBdUMsRUFBRSxFQUFFO1lBQ3BILElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMs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QUMsUUFBUSxFQUFFLEdBQUcsUUFBUSxPQUFPLENBQUMsQ0FBQTtJQUNqRCxDQUFDO0lBRU8sS0FBSyxDQUFDLFVBQVUsQ0FBQyxLQUFhO1FBQ25DLElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQzNDLE1BQU0sRUFBRSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUMvQixDQUFDO0NBU0g7QUF0TEQsNEJBc0xDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IHtcbiAgIEJvb3RzdHJhcEV2ZW50LFxuICAgRXZlbnRTZXQsXG4gICBFeGlzdFN0YXRlLFxuICAgR2V0T2JqZWN0RXZlbnQsXG4gICBJUGx1Z2luLFxuICAgSVN0YWNrLFxuICAgSUV2ZW50Um91dGVyLFxuICAgU3RhY2tPYmplY3QsXG4gICBHZXRNYW55T2JqZWN0c0V2ZW50LFxuICAgR2V0U3RvcmVDb250ZXh0RXZlbnQsXG4gICBJTW9kZWwsXG4gICBPYmplY3REZWxldGVFdmVudCxcbiAgIE9iamVjdFNhdmVFdmVudCxcbiAgIE9iamVjdFVwZGF0ZUV2ZW50XG59IGZyb20gJ0BzcGlrZWRwdW5jaC9zdGFja3MnXG5cbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJ1xuXG5jb25zdCBUZW1wRmlsZUV4dCA9ICcudGVtcCdcblxuZXhwb3J0IHR5cGUgRnNPcHRpb25zID0ge1xuICAgb2JqZWN0TmFtZUZpZWxkPzogc3RyaW5nICAgLy8gVGhlIGZpZWxkIHRvIHVzZSBmb3IgdGhlIE9iamVjdCdzIGZpbGUgbmFtZS4gRGVmYXVsdHMgdG8gJ2lkJ1xufVxuXG4vKipcbiAqIEZpbGUgc3lzdGVtIHBsdWdpbiBmb3IgU3RhY2tzXG4gKiBcbiAqIE5vdGVzOlxuICogICAgKiBHZXRNYW55IGN1cnNvciBwb2ludHMgdG8gdGhlIG5leHQgZmlsZSBpbiBhIHNvcnRlZCBsaXN0XG4gKi9cbmV4cG9ydCBjbGFzcyBGc1BsdWdpbiBpbXBsZW1lbnRzIElQbHVnaW4ge1xuICAgcmVhZG9ubHkgbmFtZTogc3RyaW5nID0gJ3N0YWNrcy1mcydcbiAgIHJlYWRvbmx5IG9wdGlvbnM6IEZzT3B0aW9uc1xuXG4gICBwcml2YXRlIHZlcnNpb246IHN0cmluZyB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZCAvLyBUaGUgcGx1Z2luIHZlcnNpb25cblxuICAgY29uc3RydWN0b3IocmVhZG9ubHkgYmFzZURpcjogc3RyaW5nLCBvcHRpb25zPzogRnNPcHRpb25zKSB7XG4gICAgICAvLyBUT0RPOiBOb3JtYWxpemUgYmFzZURpciAofiwgLi4sIGV0YylcbiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge31cbiAgIH1cblxuXG4gICAvKlxuZXhwb3J0IGVudW0gRXZlbnRTZXQge1xuICAgQm9vdHN0cmFwID0gJ2Jvb3RzdHJhcCcsXG4gICBHZXRNYW55T2JqZWN0cyA9ICdnZXQtbWFueS1vYmplY3RzJyxcbiAgIEdldE1vZGVsID0gJ2dldC1tb2RlbCcsXG4gICBHZXRPYmplY3QgPSAnZ2V0LW9iamVjdCcsXG4gICBIYXNJZCA9ICdoYXMtaWQnLFxuICAgTW9kZWxDcmVhdGVkID0gJ21vZGVsLWNyZWF0ZWQnLFxuICAgTW9kZWxEZWxldGVkID0gJ21vZGVsLWRlbGV0ZWQnLFxuICAgTW9kZWxVcGRhdGVkID0gJ21vZGVsLXVwZGF0ZWQnLFxuICAgT2JqZWN0Q3JlYXRlZCA9ICdvYmplY3QtY3JlYXRlZCcsXG4gICBPYmplY3REZWxldGVkID0gJ29iamVjdC1kZWxldGVkJyxcbiAgIE9iamVjdFVwZGF0ZWQgPSAnb2JqZWN0LXVwZGF0ZWQnLFxuICAgT2JqZWN0U2F2ZWQgPSAnb2JqZWN0LXNhdmVkJ1xufVxuICAgKi9cbiAgIGFzeW5jIHNldHVwKHN0YWNrOiBJU3RhY2ssIHJvdXRlcjogSUV2ZW50Um91dGVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICBhd2FpdCBmcy5lbnN1cmVEaXIodGhpcy5iYXNlRGlyKVxuXG4gICAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgIHJvdXRlci5vbjxCb290c3RyYXBFdmVudD4oRXZlbnRTZXQuQm9vdHN0cmFwLCBhc3luYyAoZXZlbnQ6IEJvb3RzdHJhcEV2ZW50KSA9PiB7XG4gICAgICAgICBmb3IgKGxldCBtb2RlbCBvZiBzdGFjay5nZXQubW9kZWxzKCkpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc2V0dXBNb2RlbChtb2RlbClcbiAgICAgICAgIH1cbiAgICAgIH0pXG5cbiAgICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgcm91dGVyLm9uPEdldE1hbnlPYmplY3RzRXZlbnQ8U3RhY2tPYmplY3Q+PihFdmVudFNldC5HZXRNYW55T2JqZWN0cywgYXN5bmMgKGV2ZW50OiBHZXRNYW55T2JqZWN0c0V2ZW50PFN0YWNrT2JqZWN0PikgPT4ge1xuICAgICAgICAgbGV0IG1vZGVsRGlyID0gdGhpcy5nZXRNb2RlbERpcihldmVudC5tb2RlbC5uYW1lKVxuICAgICAgICAgbGV0IHJlcUN1cnNvciA9IGV2ZW50LnBhZ2UuY3Vyc29yIHx8ICcnXG4gICAgICAgICBsZXQgcmVxQ291bnQgPSBldmVudC5wYWdlLmxpbWl0ID09IG51bGwgPyAxMDAgOiBldmVudC5wYWdlLmxpbWl0XG5cbiAgICAgICAgIC8vIElnbm9yZSBhbnkgVGVtcCBmaWxlcyB0aGF0IG1heSBiZSBpbiB0aGUgZGlyZWN0b3J5XG4gICAgICAgICBsZXQgZmlsZXMgPSBhd2FpdCBmcy5yZWFkZGlyKG1vZGVsRGlyKVxuICAgICAgICAgZmlsZXMgPSBmaWxlcy5maWx0ZXIoaXQgPT4gcGF0aC5wYXJzZShpdCkuZXh0ICE9PSBUZW1wRmlsZUV4dClcbiAgICAgICAgIGZpbGVzLnNvcnQoKVxuXG4gICAgICAgICBsZXQgY3Vyc29yID0gJydcbiAgICAgICAgIGxldCBzdGFydEluZGV4ID0gMFxuICAgICAgICAgbGV0IHJlcXVlc3RlZEZpbGVzID0gbmV3IEFycmF5PHN0cmluZz4oKVxuXG4gICAgICAgICAvLyBUaGUgY3Vyc29yIGJlY29tZXMgdGhlIG5leHQgZmlsZSBvbmUgaW4gdGhlIHNvcnRlZCBsaXN0XG4gICAgICAgICBpZiAocmVxQ3Vyc29yICE9PSAnJykge1xuICAgICAgICAgICAgbGV0IG5hbWVzID0gZmlsZXMubWFwKGYgPT4gcGF0aC5wYXJzZShmKS5uYW1lKVxuXG4gICAgICAgICAgICBsZXQgZGVjb2RlZEN1cnNvciA9IEJ1ZmZlci5mcm9tKHJlcUN1cnNvciwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCdhc2NpaScpXG4gICAgICAgICAgICBsZXQgZm91bmQgPSBuYW1lcy5maW5kSW5kZXgoaXQgPT4gaXQgPT09IGRlY29kZWRDdXJzb3IpXG5cbiAgICAgICAgICAgIGlmIChmb3VuZCA8IDApIHtcbiAgICAgICAgICAgICAgIGZvdW5kID0gMFxuICAgICAgICAgICAgICAgZXZlbnQud2FzQ3Vyc29yRm91bmQgPSBmYWxzZVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgIHN0YXJ0SW5kZXggPSBmb3VuZFxuICAgICAgICAgICAgfVxuICAgICAgICAgfVxuXG4gICAgICAgICBsZXQgZW5kSW5kZXggPSByZXFDb3VudCArIHN0YXJ0SW5kZXhcbiAgICAgICAgIHJlcXVlc3RlZEZpbGVzID0gZmlsZXMuc2xpY2Uoc3RhcnRJbmRleCwgZW5kSW5kZXgpXG5cbiAgICAgICAgIGlmIChlbmRJbmRleCA8IChmaWxlcy5sZW5ndGggLSAxKSkge1xuICAgICAgICAgICAgbGV0IHBhcnNlZCA9IHBhdGgucGFyc2UocGF0aC5qb2luKHRoaXMuYmFzZURpciwgZmlsZXNbZW5kSW5kZXhdKSlcbiAgICAgICAgICAgIGN1cnNvciA9IHBhcnNlZC5uYW1lXG4gICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY3Vyc29yID0gJydcbiAgICAgICAgIH1cblxuICAgICAgICAgbGV0IG9iamVjdHMgPSBuZXcgQXJyYXk8U3RhY2tPYmplY3Q+KClcblxuICAgICAgICAgZm9yIChsZXQgZmlsZSBvZiByZXF1ZXN0ZWRGaWxlcykge1xuICAgICAgICAgICAgb2JqZWN0cy5wdXNoKHtcbiAgICAgICAgICAgICAgIGlkOiBmaWxlLnNsaWNlKDAsIChcIi5qc29uXCIubGVuZ3RoICogLTEpKSxcbiAgICAgICAgICAgICAgIC4uLmF3YWl0IGZzLnJlYWRKc29uKHBhdGguam9pbihtb2RlbERpciwgZmlsZSkpXG4gICAgICAgICAgICB9KVxuICAgICAgICAgfVxuXG4gICAgICAgICBldmVudC5yZXN1bHRzID0ge1xuICAgICAgICAgICAgY3Vyc29yOiBjdXJzb3IgPT09ICcnID8gJycgOiBCdWZmZXIuZnJvbShjdXJzb3IpLnRvU3RyaW5nKCdiYXNlNjQnKSxcbiAgICAgICAgICAgIGl0ZW1zOiBvYmplY3RzXG4gICAgICAgICB9XG4gICAgICB9KVxuXG4gICAgICByb3V0ZXIub24oRXZlbnRTZXQuR2V0U3RvcmVDb250ZXh0LCBhc3luYyAoZXZlbnQ6IEdldFN0b3JlQ29udGV4dEV2ZW50KSA9PiB7XG4gICAgICAgICBpZiAodGhpcy52ZXJzaW9uID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGxldCBwa2cgPSBhd2FpdCBmcy5yZWFkSnNvbihwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nLCAncGFja2FnZS5qc29uJykpXG4gICAgICAgICAgICB0aGlzLnZlcnNpb24gPSBwa2cudmVyc2lvblxuICAgICAgICAgfVxuXG4gICAgICAgICBldmVudC5jb250ZXh0cy5wdXNoKHtcbiAgICAgICAgICAgIG5hbWU6ICdzdGFja3M6ZnMnLFxuICAgICAgICAgICAgdmVyc2lvbjogdGhpcy52ZXJzaW9uIHx8ICd2ZXJzaW9uLW5vdC1zZXQnLFxuICAgICAgICAgICAgc3RvcmU6IHtcbiAgICAgICAgICAgICAgIGJhc2VEaXI6IHRoaXMuYmFzZURpcixcbiAgICAgICAgICAgICAgIG9wdGlvbnM6IHRoaXMub3B0aW9ucyxcbiAgICAgICAgICAgICAgIGZzOiBmc1xuICAgICAgICAgICAgfVxuICAgICAgICAgfSlcbiAgICAgIH0pXG5cbiAgICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgcm91dGVyLm9uPE9iamVjdFNhdmVFdmVudDxTdGFja09iamVjdD4+KEV2ZW50U2V0Lk9iamVjdFNhdmVkLCBhc3luYyAoZXZlbnQ6IE9iamVjdFNhdmVFdmVudDxTdGFja09iamVjdD4pID0+IHtcbiAgICAgICAgIGxldCBtb2RlbERpciA9IHRoaXMuZ2V0TW9kZWxEaXIoZXZlbnQubW9kZWwubmFtZSlcblxuICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IGZzLmVuc3VyZURpcihtb2RlbERpcilcbiAgICAgICAgICAgIGF3YWl0IGZzLndyaXRlSnNvbihwYXRoLmpvaW4obW9kZWxEaXIsIGAke2V2ZW50LnNlcmlhbGl6ZS5pZH0uanNvbmApLCBldmVudC5zZXJpYWxpemUudG9KcygpLCB7IHNwYWNlczogMiB9KVxuICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFtzdGFja3MtZnNdIEZhaWxlZCB0byBzYXZlIG9iamVjdC4gUmVhc29uOiAke2Vycn1gKVxuICAgICAgICAgfVxuICAgICAgfSlcblxuICAgICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICByb3V0ZXIub248R2V0T2JqZWN0RXZlbnQ8U3RhY2tPYmplY3Q+PihFdmVudFNldC5HZXRPYmplY3QsIGFzeW5jIChldmVudDogR2V0T2JqZWN0RXZlbnQ8U3RhY2tPYmplY3Q+KSA9PiB7XG4gICAgICAgICBsZXQgb2JqZWN0UGF0aCA9IHRoaXMuZ2V0T2JqZWN0UGF0aChldmVudC5tb2RlbC5uYW1lLCBldmVudC5pZClcblxuICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGxldCBvYmogPSBhd2FpdCBmcy5yZWFkSnNvbihvYmplY3RQYXRoKVxuICAgICAgICAgICAgZXZlbnQub2JqZWN0ID0gb2JqXG4gICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgW3N0YWNrcy1mc10gRmFpbGVkIHRvIHJldHJpZXZlIE9iamVjdCAke2V2ZW50LmlkfS4gUmVhc29uICR7ZXJyfWApXG4gICAgICAgICB9XG4gICAgICB9KVxuXG4gICAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgIHJvdXRlci5vbjxPYmplY3REZWxldGVFdmVudDxTdGFja09iamVjdD4+KEV2ZW50U2V0Lk9iamVjdERlbGV0ZWQsIGFzeW5jIChldmVudDogT2JqZWN0RGVsZXRlRXZlbnQ8U3RhY2tPYmplY3Q+KSA9PiB7XG4gICAgICAgICBsZXQgb2JqZWN0UGF0aCA9IHRoaXMuZ2V0T2JqZWN0UGF0aChldmVudC5tb2RlbC5uYW1lLCBldmVudC5vYmplY3QuaWQpXG5cbiAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBmcy5yZW1vdmUob2JqZWN0UGF0aClcbiAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBbc3RhY2tzLWZzXSBGYWlsZWQgdG8gZGVsZXRlIGFuIE9iamVjdCAke2V2ZW50Lm9iamVjdC5pZH0uIFJlYXNvbiAke2Vycn1gKVxuICAgICAgICAgfVxuICAgICAgfSlcblxuICAgICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICByb3V0ZXIub248T2JqZWN0VXBkYXRlRXZlbnQ8U3RhY2tPYmplY3Q+PihFdmVudFNldC5PYmplY3RVcGRhdGVkLCBhc3luYyAoZXZlbnQ6IE9iamVjdFVwZGF0ZUV2ZW50PFN0YWNrT2JqZWN0PikgPT4ge1xuICAgICAgICAgbGV0IG9iamVjdFBhdGggPSB0aGlzLmdldE9iamVjdFBhdGgoZXZlbnQubW9kZWwubmFtZSwgZXZlbnQub2JqZWN0LmlkKVxuXG4gICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgZnMuYWNjZXNzKG9iamVjdFBhdGgpXG5cbiAgICAgICAgICAgIGV2ZW50LmV4aXN0cyA9IEV4aXN0U3RhdGUuRXhpc3RzXG5cbiAgICAgICAgICAgIGV2ZW50LnVwZGF0ZWQgPSBhd2FpdCBmcy5yZWFkSnNvbihvYmplY3RQYXRoKVxuICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBldmVudC5leGlzdHMgPSBFeGlzdFN0YXRlLkRvZXNOb3RFeGlzdFxuICAgICAgICAgfVxuICAgICAgfSlcbiAgIH1cblxuICAgcHJpdmF0ZSBnZXRNb2RlbERpcihtb2RlbE5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICByZXR1cm4gcGF0aC5qb2luKHRoaXMuYmFzZURpciwgbW9kZWxOYW1lKVxuICAgfVxuXG4gICBwcml2YXRlIGdldE9iamVjdFBhdGgobW9kZWxOYW1lOiBzdHJpbmcsIG9iamVjdElkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgbGV0IG1vZGVsRGlyID0gdGhpcy5nZXRNb2RlbERpcihtb2RlbE5hbWUpXG4gICAgICByZXR1cm4gcGF0aC5qb2luKG1vZGVsRGlyLCBgJHtvYmplY3RJZH0uanNvbmApXG4gICB9XG5cbiAgIHByaXZhdGUgYXN5bmMgc2V0dXBNb2RlbChtb2RlbDogSU1vZGVsKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICBsZXQgbW9kZWxEaXIgPSB0aGlzLmdldE1vZGVsRGlyKG1vZGVsLm5hbWUpXG4gICAgICBhd2FpdCBmcy5lbnN1cmVEaXIobW9kZWxEaXIpXG4gICB9XG5cbiAgIC8vIHByaXZhdGUgYXN5bmMgd3JpdGVPYmplY3QobW9kZWw6IElNb2RlbCwgb2JqZWN0OiBTdGFja09iamVjdCk6IFByb21pc2U8dm9pZD4ge1xuICAgLy8gICAgbGV0IG9iaiA9IHt9XG5cbiAgIC8vICAgIGZvcihsZXQgbWVtYmVyIG9mIG1vZGVsLm1lbWJlcnMpIHtcbiAgIC8vICAgICAgIG1lbWJlci52YWx1ZS5cbiAgIC8vICAgIH1cbiAgIC8vIH1cbn0iXX0=