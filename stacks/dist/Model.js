"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Model = exports.NoOpModel = void 0;
const MemberCollection_1 = require("./collections/MemberCollection");
const Type_1 = require("./values/Type");
const UidKeeper_1 = require("./UidKeeper");
class NoOpModel {
    constructor() {
        this.id = 'empty-object-not-a-valid-model';
        this.name = 'empty-object-not-a-valid-model';
        this.symbols = new Array();
        this.members = new MemberCollection_1.NoOpMemberCollection();
    }
    append(obj) {
        throw new Error(`Not Implemented`);
    }
    save(object) {
        throw new Error(`Not Implemented`);
    }
    create(obj) {
        {
            throw new Error(`Not Implemented`);
        }
    }
    delete(object) {
        throw new Error(`Not Implemented`);
    }
    get(id) {
        throw new Error(`Not Implemented`);
    }
    getAll() {
        throw new Error(`Not Implemented`);
    }
    getMany(req) {
        throw new Error(`Not Implemented`);
    }
    toJs() {
        throw new Error(`Not Implemented`);
    }
    validate(obj) {
        throw new Error(`Not Implemented`);
    }
}
exports.NoOpModel = NoOpModel;
class Model {
    get id() {
        return this._id;
    }
    static get NoOp() {
        return this._noop;
    }
    get orchestrator() {
        return this.context.orchestrator;
    }
    get serializer() {
        return this.context.serializer;
    }
    constructor(name, context) {
        this._id = UidKeeper_1.UidKeeper.IdNotSet;
        this.name = name;
        this.context = context;
        this.members = new MemberCollection_1.MemberCollection(this, this.context);
        this.symbols = new Array();
    }
    static async create(name, context) {
        let model = new Model(name, context);
        model.setId(await context.uid.generate(model));
        return model;
    }
    static isModel(obj) {
        for (let key of Object.keys(Model.NoOp)) {
            if (obj[key] == null ||
                (typeof obj[key] !== typeof Model.NoOp[key])) {
                return false;
            }
        }
        return true;
    }
    /**
     * Determines if an Object is a Model. If it is, then it will return a
     * cast value of the Model, otherwise undefined.
     *
     * @param obj The Object to cast
     * @returns
     */
    static asModel(obj) {
        if (Model.isModel(obj)) {
            return obj;
        }
        return undefined;
    }
    async append(obj) {
        return this.members.append(obj);
    }
    async save(obj) {
        await this.orchestrator.saveObject(this, obj);
    }
    async create(params = {}) {
        return await this.orchestrator.createObject(this, params);
    }
    async delete(object) {
        await this.orchestrator.deleteObject(this, object);
    }
    async get(id) {
        return await this.orchestrator.getObject(this, id);
    }
    async getAll() {
        let cursor = '';
        let results = new Array();
        do {
            let paged = await this.orchestrator.getManyObjects(this, { cursor });
            results.push(...paged.items);
            cursor = paged.cursor;
        } while (cursor !== '');
        return results;
    }
    async getMany(req = {}) {
        return this.orchestrator.getManyObjects(this, req);
    }
    async toJs() {
        let result = {
            id: this.id
        };
        for (let member of this.members) {
            result[member.name] = await this.serializer.toJs(member.value);
        }
        //@ts-ignore
        return result;
    }
    async validate(obj) {
        let report = new Type_1.ValidationReport();
        for (let key of Object.keys(obj)) {
            if (key === 'id') {
                continue;
            }
            let member = this.members.get(key);
            if (member === undefined) {
                report.addError(new Error(`Object contains a key that does not exist in the Model: ${key}`));
                continue;
            }
            let result = await member.type.validate(obj[key]);
            if (result.success === false && result.error) {
                report.addError(result.error);
            }
        }
        return report;
    }
    setId(id) {
        this._id = id;
    }
}
exports.Model = Model;
Model._noop = new NoOpModel();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW9kZWwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvTW9kZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUVBQTJHO0FBRzNHLHdDQUFpRDtBQUtqRCwyQ0FBd0M7QUErRnhDLE1BQWEsU0FBUztJQU9uQjtRQU5TLE9BQUUsR0FBVyxnQ0FBZ0MsQ0FBQTtRQUM3QyxTQUFJLEdBQVcsZ0NBQWdDLENBQUE7UUFHL0MsWUFBTyxHQUFrQixJQUFJLEtBQUssRUFBZSxDQUFBO1FBR3ZELElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSx1Q0FBb0IsRUFBRSxDQUFBO0lBQzVDLENBQUM7SUFFRCxNQUFNLENBQUMsR0FBc0I7UUFDMUIsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO0lBQ3JDLENBQUM7SUFFRCxJQUFJLENBQXdCLE1BQVM7UUFDbEMsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO0lBQ3JDLENBQUM7SUFFRCxNQUFNLENBQXdCLEdBQXdCO1FBQ25ELENBQUM7WUFDRSxNQUFNLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUE7UUFDckMsQ0FBQztJQUNKLENBQUM7SUFFRCxNQUFNLENBQXdCLE1BQVM7UUFDcEMsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO0lBQ3JDLENBQUM7SUFFRCxHQUFHLENBQXdCLEVBQVU7UUFDbEMsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO0lBQ3JDLENBQUM7SUFFRCxNQUFNO1FBQ0gsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO0lBQ3JDLENBQUM7SUFFRCxPQUFPLENBQXdCLEdBQWlCO1FBQzdDLE1BQU0sSUFBSSxLQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQTtJQUNyQyxDQUFDO0lBRUQsSUFBSTtRQUNELE1BQU0sSUFBSSxLQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FB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RUFBRSxDQUFBO1FBRW5DLEtBQUssSUFBSSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ2hDLElBQUcsR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDO2dCQUNmLFNBQVE7WUFDWCxDQUFDO1lBRUQsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUE7WUFFbEMsSUFBSSxNQUFNLEtBQUssU0FBUyxFQUFFLENBQUM7Z0JBQ3hCLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxLQUFLLENBQUMsMkRBQTJELEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQTtnQkFDNUYsU0FBUTtZQUNYLENBQUM7WUFFRCxJQUFJLE1BQU0sR0FBRyxNQUFNLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO1lBRWpELElBQUksTUFBTSxDQUFDLE9BQU8sS0FBSyxLQUFLLElBQUksTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUM1QyxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQTtZQUNoQyxDQUFDO1FBQ0osQ0FBQztRQUVELE9BQU8sTUFBTSxDQUFBO0lBQ2hCLENBQUM7SUFFTyxLQUFLLENBQUMsRUFBVTtRQUNyQixJQUFJLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQTtJQUNoQixDQUFDOztBQWhKSixzQkFpSkM7QUExSGlCLFdBQUssR0FBVyxJQUFJLFNBQVMsRUFBRSxBQUExQixDQUEwQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElNZW1iZXJDb2xsZWN0aW9uLCBNZW1iZXJDb2xsZWN0aW9uLCBOb09wTWVtYmVyQ29sbGVjdGlvbiB9IGZyb20gXCIuL2NvbGxlY3Rpb25zL01lbWJlckNvbGxlY3Rpb25cIjtcbmltcG9ydCB7IElPcmNoZXN0cmF0b3IgfSBmcm9tIFwiLi9vcmNoZXN0cmF0b3IvT3JjaGVzdHJhdG9yXCI7XG5pbXBvcnQgeyBJU3RhY2tDb250ZXh0IH0gZnJvbSBcIi4vc3RhY2svU3RhY2tDb250ZXh0XCI7XG5pbXBvcnQgeyBWYWxpZGF0aW9uUmVwb3J0IH0gZnJvbSBcIi4vdmFsdWVzL1R5cGVcIjtcbmltcG9ydCB7IENyZWF0ZVZhbHVlSGFuZGxlciwgVmFsdWVDcmVhdGVQYXJhbXMgfSBmcm9tIFwiLi92YWx1ZXMvVmFsdWVTb3VyY2VcIjtcbmltcG9ydCB7IFN0YWNrT2JqZWN0IH0gZnJvbSBcIi4vU3RhY2tPYmplY3RcIjtcbmltcG9ydCB7IElWYWx1ZVNlcmlhbGl6ZXIgfSBmcm9tIFwiLi9zZXJpYWxpemUvVmFsdWVTZXJpYWxpemVyXCI7XG5pbXBvcnQgeyBNZW1iZXJJbmZvIH0gZnJvbSBcIi4vTWVtYmVyXCI7XG5pbXBvcnQgeyBVaWRLZWVwZXIgfSBmcm9tIFwiLi9VaWRLZWVwZXJcIjtcblxuLyoqXG4gKiBUaGUgcGFyYW1ldGVycyB1c2VkIHRvIGNyZWF0ZSBhbiBPYmplY3QgYmFzZWQgb24gYSBNb2RlbC5cbiAqIFRoZSBhZGRpdGlvbmFsIE9iamVjdENyZWF0ZVBhcmFtcyBvbiB0aGUgdHlwZSBzdXBwb3J0cyBuZXN0ZWRcbiAqIHZhbHVlcy5cbiAqL1xuZXhwb3J0IHR5cGUgT2JqZWN0Q3JlYXRlUGFyYW1zID0ge1xuICAgW2tleTogc3RyaW5nXTogVmFsdWVDcmVhdGVQYXJhbXMgfCBPYmplY3RDcmVhdGVQYXJhbXNcbn1cblxuZXhwb3J0IHR5cGUgTW9kZWxDcmVhdGVQYXJhbXMgPSB7XG4gICBba2V5OiBzdHJpbmddOiBzdHJpbmcgfCBudW1iZXIgfCBib29sZWFuIHwgYW55W10gfCBDcmVhdGVWYWx1ZUhhbmRsZXIgfCBNZW1iZXJJbmZvXG59XG5cbmV4cG9ydCB0eXBlIFN5bWJvbEVudHJ5ID0ge1xuICAgbmFtZTogc3RyaW5nLFxuICAgdmFsdWU6IGFueVxufVxuXG5leHBvcnQgdHlwZSBQYWdlUmVzcG9uc2U8VD4gPSB7XG4gICBjdXJzb3I6IHN0cmluZ1xuICAgaXRlbXM6IFRbXVxufVxuXG5leHBvcnQgdHlwZSBQYWdlUmVxdWVzdCA9IHtcbiAgIGN1cnNvcj86IHN0cmluZ1xuICAgbGltaXQ/OiBudW1iZXJcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJTW9kZWwge1xuICAgcmVhZG9ubHkgaWQ6IHN0cmluZ1xuICAgcmVhZG9ubHkgbmFtZTogc3RyaW5nXG5cbiAgIHJlYWRvbmx5IG1lbWJlcnM6IElNZW1iZXJDb2xsZWN0aW9uXG4gICByZWFkb25seSBzeW1ib2xzOiBTeW1ib2xFbnRyeVtdXG5cbiAgIC8qKlxuICAgICogQXBwZW5kcyBhZGRpdGlvbmFsIE1lbWJlcnMgdG8gdGhlIE1vZGVsXG4gICAgKiBcbiAgICAqIEBwYXJhbSBvYmogVGhlIGFkZGl0aW9uYWwgbWVtYmVycyB0byBhZGRcbiAgICAqL1xuICAgYXBwZW5kKG9iajogTW9kZWxDcmVhdGVQYXJhbXMpOiBQcm9taXNlPHZvaWQ+XG5cbiAgIC8qKlxuICAgICogU3N2ZXMgdGhlIG9iamVjdCB0byBzdG9yYWdlXG4gICAgKiBcbiAgICAqIEBwYXJhbSBvYmplY3QgVGhlIG9iamVjdCB0byBjb21taXRcbiAgICAqL1xuICAgc2F2ZTxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG9iamVjdDogVCk6IFByb21pc2U8dm9pZD5cblxuICAgLyoqXG4gICAgKiBDcmVhdGVzIGEgbmV3IE9iamVjdCBiYXNlZCBvbiB0aGlzIE1vZGVsXG4gICAgKi9cbiAgIGNyZWF0ZTxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG9iaj86IE9iamVjdENyZWF0ZVBhcmFtcyk6IFByb21pc2U8VD5cblxuICAgLyoqXG4gICAgKiBEZWxldGVzIGFuIG9iamVjdCBkZXJpdmVkIGZyb20gdGhpcyBNb2RlbFxuICAgICogXG4gICAgKiBAcGFyYW0gb2JqZWN0IFRoZSBvYmplY3QgdG8gZGVsZXRlXG4gICAgKi9cbiAgIGRlbGV0ZTxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG9iamVjdDogVCk6IFByb21pc2U8dm9pZD5cblxuICAgLyoqXG4gICAgKiBSZXRyaWV2ZXMgYW4gaW5zdGFuY2UgYnkgSURcbiAgICAqIFxuICAgICogQHBhcmFtIGlkIFRoZSBJRCBvZiB0aGUgaW5zdGFuY2VcbiAgICAqL1xuICAgZ2V0PFQgZXh0ZW5kcyBTdGFja09iamVjdD4oaWQ6IHN0cmluZyk6IFByb21pc2U8VCB8IHVuZGVmaW5lZD5cblxuICAgLyoqXG4gICAgKiBHZXRzIGFsbCBPYmplY3RzIGJhc2VkIG9uIGEgTW9kZWxcbiAgICAqL1xuICAgZ2V0QWxsPFQgZXh0ZW5kcyBTdGFja09iamVjdD4oKTogUHJvbWlzZTxUW10+XG5cbiAgIC8qKlxuICAgICogR2V0cyBtYW55IE9iamVjdHNcbiAgICAqIFxuICAgICogQHBhcmFtIHJlcSBUaGUgUGFnZWRSZXF1ZXN0IFxuICAgICovXG4gICBnZXRNYW55PFQgZXh0ZW5kcyBTdGFja09iamVjdD4ocmVxPzogUGFnZVJlcXVlc3QpOiBQcm9taXNlPFBhZ2VSZXNwb25zZTxUPj5cblxuICAgLyoqXG4gICAgKiBDb252ZXJ0cyB0aGUgTW9kZWwgaW50byBhIEpTIG9iamVjdFxuICAgICovXG4gICB0b0pzPFQ+KCk6IFByb21pc2U8VD5cblxuICAgLyoqXG4gICAgKiBWYWxpZGF0ZXMgYW4gT2JqZWN0IGFnYWluc3QgdGhlIE1vZGVsJ3Mgc2NoZW1hXG4gICAgKiBcbiAgICAqIEBwYXJhbSBvYmogVGhlIE9iamVjdCB0byB2YWxpZGF0ZVxuICAgICovXG4gICB2YWxpZGF0ZTxUIGV4dGVuZHMgb2JqZWN0PihvYmo6IFQpOiBQcm9taXNlPFZhbGlkYXRpb25SZXBvcnQ+XG59XG5cbmV4cG9ydCBjbGFzcyBOb09wTW9kZWwgaW1wbGVtZW50cyBJTW9kZWwge1xuICAgcmVhZG9ubHkgaWQ6IHN0cmluZyA9ICdlbXB0eS1vYmplY3Qtbm90LWEtdmFsaWQtbW9kZWwnXG4gICByZWFkb25seSBuYW1lOiBzdHJpbmcgPSAnZW1wdHktb2JqZWN0LW5vdC1hLXZhbGlkLW1vZGVsJ1xuXG4gICByZWFkb25seSBtZW1iZXJzOiBJTWVtYmVyQ29sbGVjdGlvblxuICAgcmVhZG9ubHkgc3ltYm9sczogU3ltYm9sRW50cnlbXSA9IG5ldyBBcnJheTxTeW1ib2xFbnRyeT4oKVxuXG4gICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgIHRoaXMubWVtYmVycyA9IG5ldyBOb09wTWVtYmVyQ29sbGVjdGlvbigpXG4gICB9XG5cbiAgIGFwcGVuZChvYmo6IE1vZGVsQ3JlYXRlUGFyYW1zKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vdCBJbXBsZW1lbnRlZGApXG4gICB9XG5cbiAgIHNhdmU8VCBleHRlbmRzIFN0YWNrT2JqZWN0PihvYmplY3Q6IFQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTm90IEltcGxlbWVudGVkYClcbiAgIH1cblxuICAgY3JlYXRlPFQgZXh0ZW5kcyBTdGFja09iamVjdD4ob2JqPzogT2JqZWN0Q3JlYXRlUGFyYW1zKTogUHJvbWlzZTxUPiB7XG4gICAgICB7XG4gICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vdCBJbXBsZW1lbnRlZGApXG4gICAgICB9XG4gICB9XG5cbiAgIGRlbGV0ZTxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KG9iamVjdDogVCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBOb3QgSW1wbGVtZW50ZWRgKVxuICAgfVxuXG4gICBnZXQ8VCBleHRlbmRzIFN0YWNrT2JqZWN0PihpZDogc3RyaW5nKTogUHJvbWlzZTxUIHwgdW5kZWZpbmVkPiB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vdCBJbXBsZW1lbnRlZGApXG4gICB9XG5cbiAgIGdldEFsbDxUIGV4dGVuZHMgU3RhY2tPYmplY3Q+KCk6IFByb21pc2U8VFtdPiB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vdCBJbXBsZW1lbnRlZGApXG4gICB9XG5cbiAgIGdldE1hbnk8VCBleHRlbmRzIFN0YWNrT2JqZWN0PihyZXE/OiBQYWdlUmVxdWVzdCk6IFByb21pc2U8UGFnZVJlc3BvbnNlPFQ+PiB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vdCBJbXBsZW1lbnRlZGApXG4gICB9XG5cbiAgIHRvSnM8VD4oKTogUHJvbWlzZTxUPiB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vdCBJbXBsZW1lbnRlZGApXG4gICB9XG5cbiAgIHZhbGlkYXRlPFQgZXh0ZW5kcyBvYmplY3Q+KG9iajogVCk6IFByb21pc2U8VmFsaWRhdGlvblJlcG9ydD4ge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBOb3QgSW1wbGVtZW50ZWRgKVxuICAgfVxufVxuXG5leHBvcnQgY2xhc3MgTW9kZWwgaW1wbGVtZW50cyBJTW9kZWwge1xuICAgZ2V0IGlkKCk6IHN0cmluZyB7XG4gICAgICByZXR1cm4gdGhpcy5faWRcbiAgIH1cblxuICAgcmVhZG9ubHkgbmFtZTogc3RyaW5nXG4gICByZWFkb25seSBjb250ZXh0OiBJU3RhY2tDb250ZXh0XG5cbiAgIHJlYWRvbmx5IG1lbWJlcnM6IElNZW1iZXJDb2xsZWN0aW9uXG4gICByZWFkb25seSBzeW1ib2xzOiBTeW1ib2xFbnRyeVtdXG5cbiAgIHN0YXRpYyBnZXQgTm9PcCgpOiBJTW9kZWwge1xuICAgICAgcmV0dXJuIHRoaXMuX25vb3BcbiAgIH1cblxuICAgcHJpdmF0ZSBnZXQgb3JjaGVzdHJhdG9yKCk6IElPcmNoZXN0cmF0b3Ige1xuICAgICAgcmV0dXJuIHRoaXMuY29udGV4dC5vcmNoZXN0cmF0b3JcbiAgIH1cblxuICAgcHJpdmF0ZSBnZXQgc2VyaWFsaXplcigpOiBJVmFsdWVTZXJpYWxpemVyIHtcbiAgICAgIHJldHVybiB0aGlzLmNvbnRleHQuc2VyaWFsaXplclxuICAgfVxuXG4gICBwcml2YXRlIHN0YXRpYyBfbm9vcDogSU1vZGVsID0gbmV3IE5vT3BNb2RlbCgpXG4gICBwcml2YXRlIF9pZDogc3RyaW5nID0gVWlkS2VlcGVyLklkTm90U2V0XG5cbiAgIHByaXZhdGUgY29uc3RydWN0b3IobmFtZTogc3RyaW5nLCBjb250ZXh0OiBJU3RhY2tDb250ZXh0KSB7XG4gICAgICB0aGlzLm5hbWUgPSBuYW1lXG4gICAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0XG5cbiAgICAgIHRoaXMubWVtYmVycyA9IG5ldyBNZW1iZXJDb2xsZWN0aW9uKHRoaXMsIHRoaXMuY29udGV4dClcbiAgICAgIHRoaXMuc3ltYm9scyA9IG5ldyBBcnJheTxTeW1ib2xFbnRyeT4oKVxuICAgfVxuXG4gICBzdGF0aWMgYXN5bmMgY3JlYXRlKG5hbWU6IHN0cmluZywgY29udGV4dDogSVN0YWNrQ29udGV4dCk6IFByb21pc2U8SU1vZGVsPiB7XG4gICAgICBsZXQgbW9kZWwgPSBuZXcgTW9kZWwobmFtZSwgY29udGV4dClcbiAgICAgIG1vZGVsLnNldElkKGF3YWl0IGNvbnRleHQudWlkLmdlbmVyYXRlKG1vZGVsKSlcbiAgICAgIHJldHVybiBtb2RlbFxuICAgfVxuXG4gICBzdGF0aWMgaXNNb2RlbChvYmo6IGFueSk6IGJvb2xlYW4ge1xuICAgICAgZm9yIChsZXQga2V5IG9mIE9iamVjdC5rZXlzKE1vZGVsLk5vT3ApKSB7XG4gICAgICAgICBpZiAob2JqW2tleV0gPT0gbnVsbCB8fFxuICAgICAgICAgICAgKHR5cGVvZiBvYmpba2V5XSAhPT0gdHlwZW9mIE1vZGVsLk5vT3Bba2V5XSlcbiAgICAgICAgICkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0cnVlXG4gICB9XG5cbiAgIC8qKlxuICAgICogRGV0ZXJtaW5lcyBpZiBhbiBPYmplY3QgaXMgYSBNb2RlbC4gSWYgaXQgaXMsIHRoZW4gaXQgd2lsbCByZXR1cm4gYVxuICAgICogY2FzdCB2YWx1ZSBvZiB0aGUgTW9kZWwsIG90aGVyd2lzZSB1bmRlZmluZWQuXG4gICAgKiBcbiAgICAqIEBwYXJhbSBvYmogVGhlIE9iamVjdCB0byBjYXN0XG4gICAgKiBAcmV0dXJucyBcbiAgICAqL1xuICAgc3RhdGljIGFzTW9kZWwob2JqOiBhbnkpOiBJTW9kZWwgfCB1bmRlZmluZWQge1xuICAgICAgaWYoTW9kZWwuaXNNb2RlbChvYmopKSB7XG4gICAgICAgICByZXR1cm4gb2JqIGFzIElNb2RlbFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gdW5kZWZpbmVkXG4gICB9XG5cbiAgIGFzeW5jIGFwcGVuZChvYmo6IE1vZGVsQ3JlYXRlUGFyYW1zKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICByZXR1cm4gdGhpcy5tZW1iZXJzLmFwcGVuZChvYmopXG4gICB9XG5cbiAgIGFzeW5jIHNhdmU8VCBleHRlbmRzIFN0YWNrT2JqZWN0PihvYmo6IFQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIGF3YWl0IHRoaXMub3JjaGVzdHJhdG9yLnNhdmVPYmplY3Q8VD4odGhpcywgb2JqKVxuICAgfVxuXG4gICBhc3luYyBjcmVhdGU8VCBleHRlbmRzIFN0YWNrT2JqZWN0PihwYXJhbXM6IE9iamVjdENyZWF0ZVBhcmFtcyA9IHt9KTogUHJvbWlzZTxUPiB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5vcmNoZXN0cmF0b3IuY3JlYXRlT2JqZWN0KHRoaXMsIHBhcmFtcylcbiAgIH1cblxuICAgYXN5bmMgZGVsZXRlPFQgZXh0ZW5kcyBTdGFja09iamVjdD4ob2JqZWN0OiBUKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICBhd2FpdCB0aGlzLm9yY2hlc3RyYXRvci5kZWxldGVPYmplY3Q8VD4odGhpcywgb2JqZWN0KVxuICAgfVxuXG4gICBhc3luYyBnZXQ8VCBleHRlbmRzIFN0YWNrT2JqZWN0PihpZDogc3RyaW5nKTogUHJvbWlzZTxUIHwgdW5kZWZpbmVkPiB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5vcmNoZXN0cmF0b3IuZ2V0T2JqZWN0PFQ+KHRoaXMsIGlkKVxuICAgfVxuXG4gICBhc3luYyBnZXRBbGw8VCBleHRlbmRzIFN0YWNrT2JqZWN0PigpOiBQcm9taXNlPFRbXT4ge1xuICAgICAgbGV0IGN1cnNvciA9ICcnXG4gICAgICBsZXQgcmVzdWx0cyA9IG5ldyBBcnJheTxUPigpXG5cbiAgICAgIGRvIHtcbiAgICAgICAgIGxldCBwYWdlZCA9IGF3YWl0IHRoaXMub3JjaGVzdHJhdG9yLmdldE1hbnlPYmplY3RzPFQ+KHRoaXMsIHsgY3Vyc29yIH0pXG4gICAgICAgICByZXN1bHRzLnB1c2goLi4ucGFnZWQuaXRlbXMpXG4gICAgICAgICBjdXJzb3IgPSBwYWdlZC5jdXJzb3JcbiAgICAgIH0gd2hpbGUgKGN1cnNvciAhPT0gJycpXG5cbiAgICAgIHJldHVybiByZXN1bHRzXG4gICB9XG5cbiAgIGFzeW5jIGdldE1hbnk8VCBleHRlbmRzIFN0YWNrT2JqZWN0PihyZXE6IFBhZ2VSZXF1ZXN0ID0ge30pOiBQcm9taXNlPFBhZ2VSZXNwb25zZTxUPj4ge1xuICAgICAgcmV0dXJuIHRoaXMub3JjaGVzdHJhdG9yLmdldE1hbnlPYmplY3RzPFQ+KHRoaXMsIHJlcSlcbiAgIH1cblxuICAgYXN5bmMgdG9KczxUPigpOiBQcm9taXNlPFQ+IHtcbiAgICAgIGxldCByZXN1bHQgPSB7XG4gICAgICAgICBpZDogdGhpcy5pZFxuICAgICAgfVxuXG4gICAgICBmb3IgKGxldCBtZW1iZXIgb2YgdGhpcy5tZW1iZXJzKSB7XG4gICAgICAgICByZXN1bHRbbWVtYmVyLm5hbWVdID0gYXdhaXQgdGhpcy5zZXJpYWxpemVyLnRvSnMobWVtYmVyLnZhbHVlKVxuICAgICAgfVxuXG4gICAgICAvL0B0cy1pZ25vcmVcbiAgICAgIHJldHVybiByZXN1bHQgYXMgVFxuICAgfVxuXG4gICBhc3luYyB2YWxpZGF0ZTxUIGV4dGVuZHMgb2JqZWN0PihvYmo6IFQpOiBQcm9taXNlPFZhbGlkYXRpb25SZXBvcnQ+IHtcbiAgICAgIGxldCByZXBvcnQgPSBuZXcgVmFsaWRhdGlvblJlcG9ydCgpXG5cbiAgICAgIGZvciAobGV0IGtleSBvZiBPYmplY3Qua2V5cyhvYmopKSB7XG4gICAgICAgICBpZihrZXkgPT09ICdpZCcpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgICB9XG5cbiAgICAgICAgIGxldCBtZW1iZXIgPSB0aGlzLm1lbWJlcnMuZ2V0KGtleSlcblxuICAgICAgICAgaWYgKG1lbWJlciA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICByZXBvcnQuYWRkRXJyb3IobmV3IEVycm9yKGBPYmplY3QgY29udGFpbnMgYSBrZXkgdGhhdCBkb2VzIG5vdCBleGlzdCBpbiB0aGUgTW9kZWw6ICR7a2V5fWApKVxuICAgICAgICAgICAgY29udGludWVcbiAgICAgICAgIH1cblxuICAgICAgICAgbGV0IHJlc3VsdCA9IGF3YWl0IG1lbWJlci50eXBlLnZhbGlkYXRlKG9ialtrZXldKVxuXG4gICAgICAgICBpZiAocmVzdWx0LnN1Y2Nlc3MgPT09IGZhbHNlICYmIHJlc3VsdC5lcnJvcikge1xuICAgICAgICAgICAgcmVwb3J0LmFkZEVycm9yKHJlc3VsdC5lcnJvcilcbiAgICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJlcG9ydFxuICAgfVxuXG4gICBwcml2YXRlIHNldElkKGlkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgIHRoaXMuX2lkID0gaWRcbiAgIH1cbn0iXX0=