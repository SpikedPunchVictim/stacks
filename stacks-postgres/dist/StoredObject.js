"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.StoredObject = void 0;
const StacksPostgresError_1 = require("./StacksPostgresError");
class StoredObject {
    constructor(model, obj, context) {
        this.model = model;
        this.obj = obj;
        this.context = context;
    }
    static async fromId(model, id, context) {
        let info = context.getTable(model);
        if (info === undefined) {
            throw new StacksPostgresError_1.StacksPostgresError(`Failed to find the Table for Model ${model.name}. Ensure the Postgres Plugin has been properly initialized.`);
        }
        try {
            let result = await context.db.selectFrom(info.tableName)
                .selectAll(info.tableName)
                .where('id', '=', id)
                .execute();
            console.log(`:: From DB`);
            console.dir(result[0], { depth: null });
            console.log(`:: Transformed`);
            console.dir(context.fromDbObj(model.name, result[0]), { depth: null });
            return result.length == 0 ? undefined : new StoredObject(model, result[0], context);
        }
        catch (err) {
            throw err;
        }
    }
    static async getOrCreate(model, obj, context) {
        let found = await StoredObject.fromId(model, obj.id, context);
        if (found) {
            return found;
        }
        return StoredObject.create(model, obj, context);
    }
    static create(model, obj, context) {
        let dbObj = context.toDbObj(model.name, obj);
        return new StoredObject(model, dbObj, context);
    }
    async save() {
        let table = this.context.getTable(this.model);
        if (table == undefined) {
            throw new StacksPostgresError_1.StacksPostgresError(`Could not match Model with a Table when saving Object ${this.obj.id}`);
        }
        // Store any seperate Object Refs in their own table; nested.
        let refColumns = table.columns.filter(col => col.reference != null);
        let savedObj = {};
        for (let refColumn of refColumns) {
            if (this.obj[refColumn.columnName] == null) {
                continue;
            }
            if (refColumn.reference == null) {
                throw new StacksPostgresError_1.StacksPostgresError(`Failed to Save the Object. No reference has been recorded for a Model Property. On Model ${this.model.name}, Member ${refColumn.member.name}`);
            }
            let refTableInfo = this.context.getTable(refColumn.reference.model);
            if (refTableInfo === undefined) {
                throw new StacksPostgresError_1.StacksPostgresError(`Failed to find the reference information for a column in Model ${refColumn.reference.model}`);
            }
            let storedObj = StoredObject.create(refColumn.reference.model, this.context.toDbObj(refTableInfo.model.name, this.obj[refColumn.columnName]), this.context);
            await storedObj.save();
            savedObj[refColumn.columnName] = this.obj[refColumn.columnName].id;
        }
        for (let colName of Object.keys(this.obj)) {
            savedObj[colName] = this.obj[colName];
        }
        let result = await this.context.db
            .insertInto(table.tableName)
            .values(savedObj)
            .execute();
        console.dir(result, { depth: null });
        return;
    }
    async delete() {
        let info = this.context.getTable(this.model);
        if (info == undefined) {
            throw new StacksPostgresError_1.StacksPostgresError(`Could not match Model with a Table when saving Object ${this.obj.id}`);
        }
        try {
            await this.context.db
                .deleteFrom(info.tableName)
                .where('id', '=', this.obj.id)
                .execute();
        }
        catch (err) {
            console.error(`[stacks-postgres] Failed to delete an Object from Postgres. Model ${this.model.name}, Object ID ${this.obj.id}. Reason: ${err}`);
            throw err;
        }
    }
}
exports.StoredObject = StoredObject;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RvcmVkT2JqZWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1N0b3JlZE9iamVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSwrREFBMkQ7QUFHM0QsTUFBYSxZQUFZO0lBQ3RCLFlBQTZCLEtBQWEsRUFBVyxHQUFnQixFQUFXLE9BQXNCO1FBQXpFLFVBQUssR0FBTCxLQUFLLENBQVE7UUFBVyxRQUFHLEdBQUgsR0FBRyxDQUFhO1FBQVcsWUFBTyxHQUFQLE9BQU8sQ0FBZTtJQUV0RyxDQUFDO0lBRUQsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBYSxFQUFFLEVBQVUsRUFBRSxPQUFzQjtRQUNsRSxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBRWxDLElBQUksSUFBSSxLQUFLLFNBQVMsRUFBRTtZQUNyQixNQUFNLElBQUkseUNBQW1CLENBQUMsc0NBQXNDLEtBQUssQ0FBQyxJQUFJLDZEQUE2RCxDQUFDLENBQUE7U0FDOUk7UUFFRCxJQUFJO1lBQ0QsSUFBSSxNQUFNLEdBQUcsTUFBTSxPQUFPLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO2lCQUNwRCxTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztpQkFDekIsS0FBSyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDO2lCQUNwQixPQUFPLEVBQUUsQ0FBQTtZQUViLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUE7WUFDekIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQTtZQUV2QyxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLENBQUE7WUFDN0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEtB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QU8sQ0FBQyxLQUFLLENBQUMscUVBQXFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxlQUFlLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxhQUFhLEdBQUcsRUFBRSxDQUFDLENBQUE7WUFDL0ksTUFBTSxHQUFHLENBQUE7U0FDWDtJQUNKLENBQUM7Q0FDSDtBQTdHRCxvQ0E2R0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJTW9kZWwsIFN0YWNrT2JqZWN0IH0gZnJvbSBcIkBzcGlrZWRwdW5jaC9zdGFja3NcIlxuaW1wb3J0IHsgUGx1Z2luQ29udGV4dCB9IGZyb20gXCIuL1BsdWdpbkNvbnRleHRcIlxuaW1wb3J0IHsgU3RhY2tzUG9zdGdyZXNFcnJvciB9IGZyb20gXCIuL1N0YWNrc1Bvc3RncmVzRXJyb3JcIlxuXG5cbmV4cG9ydCBjbGFzcyBTdG9yZWRPYmplY3Qge1xuICAgcHJpdmF0ZSBjb25zdHJ1Y3RvcihyZWFkb25seSBtb2RlbDogSU1vZGVsLCByZWFkb25seSBvYmo6IFN0YWNrT2JqZWN0LCByZWFkb25seSBjb250ZXh0OiBQbHVnaW5Db250ZXh0KSB7XG5cbiAgIH1cblxuICAgc3RhdGljIGFzeW5jIGZyb21JZChtb2RlbDogSU1vZGVsLCBpZDogc3RyaW5nLCBjb250ZXh0OiBQbHVnaW5Db250ZXh0KTogUHJvbWlzZTxTdG9yZWRPYmplY3QgfCB1bmRlZmluZWQ+IHtcbiAgICAgIGxldCBpbmZvID0gY29udGV4dC5nZXRUYWJsZShtb2RlbClcblxuICAgICAgaWYgKGluZm8gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgdGhyb3cgbmV3IFN0YWNrc1Bvc3RncmVzRXJyb3IoYEZhaWxlZCB0byBmaW5kIHRoZSBUYWJsZSBmb3IgTW9kZWwgJHttb2RlbC5uYW1lfS4gRW5zdXJlIHRoZSBQb3N0Z3JlcyBQbHVnaW4gaGFzIGJlZW4gcHJvcGVybHkgaW5pdGlhbGl6ZWQuYClcbiAgICAgIH1cblxuICAgICAgdHJ5IHtcbiAgICAgICAgIGxldCByZXN1bHQgPSBhd2FpdCBjb250ZXh0LmRiLnNlbGVjdEZyb20oaW5mby50YWJsZU5hbWUpXG4gICAgICAgICAgICAuc2VsZWN0QWxsKGluZm8udGFibGVOYW1lKVxuICAgICAgICAgICAgLndoZXJlKCdpZCcsICc9JywgaWQpXG4gICAgICAgICAgICAuZXhlY3V0ZSgpXG5cbiAgICAgICAgIGNvbnNvbGUubG9nKGA6OiBGcm9tIERCYClcbiAgICAgICAgIGNvbnNvbGUuZGlyKHJlc3VsdFswXSwgeyBkZXB0aDogbnVsbCB9KVxuXG4gICAgICAgICBjb25zb2xlLmxvZyhgOjogVHJhbnNmb3JtZWRgKVxuICAgICAgICAgY29uc29sZS5kaXIoY29udGV4dC5mcm9tRGJPYmoobW9kZWwubmFtZSwgcmVzdWx0WzBdIGFzIGFueSksIHsgZGVwdGg6IG51bGwgfSlcbiAgICAgICAgIFxuICAgICAgICAgcmV0dXJuIHJlc3VsdC5sZW5ndGggPT0gMCA/IHVuZGVmaW5lZCA6IG5ldyBTdG9yZWRPYmplY3QobW9kZWwsIHJlc3VsdFswXSBhcyBTdGFja09iamVjdCwgY29udGV4dClcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgdGhyb3cgZXJyXG4gICAgICB9XG4gICB9XG5cbiAgIHN0YXRpYyBhc3luYyBnZXRPckNyZWF0ZShtb2RlbDogSU1vZGVsLCBvYmo6IFN0YWNrT2JqZWN0LCBjb250ZXh0OiBQbHVnaW5Db250ZXh0KTogUHJvbWlzZTxTdG9yZWRPYmplY3Q+IHtcbiAgICAgIGxldCBmb3VuZCA9IGF3YWl0IFN0b3JlZE9iamVjdC5mcm9tSWQobW9kZWwsIG9iai5pZCwgY29udGV4dClcblxuICAgICAgaWYoZm91bmQpIHtcbiAgICAgICAgIHJldHVybiBmb3VuZFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gU3RvcmVkT2JqZWN0LmNyZWF0ZShtb2RlbCwgb2JqLCBjb250ZXh0KVxuICAgfVxuXG4gICBzdGF0aWMgY3JlYXRlKG1vZGVsOiBJTW9kZWwsIG9iajogU3RhY2tPYmplY3QsIGNvbnRleHQ6IFBsdWdpbkNvbnRleHQpOiBTdG9yZWRPYmplY3Qge1xuICAgICAgbGV0IGRiT2JqID0gY29udGV4dC50b0RiT2JqKG1vZGVsLm5hbWUsIG9iailcbiAgICAgIHJldHVybiBuZXcgU3RvcmVkT2JqZWN0KG1vZGVsLCBkYk9iaiwgY29udGV4dClcbiAgIH1cblxuICAgYXN5bmMgc2F2ZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIGxldCB0YWJsZSA9IHRoaXMuY29udGV4dC5nZXRUYWJsZSh0aGlzLm1vZGVsKVxuXG4gICAgICBpZiAodGFibGUgPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICB0aHJvdyBuZXcgU3RhY2tzUG9zdGdyZXNFcnJvcihgQ291bGQgbm90IG1hdGNoIE1vZGVsIHdpdGggYSBUYWJsZSB3aGVuIHNhdmluZyBPYmplY3QgJHt0aGlzLm9iai5pZH1gKVxuICAgICAgfVxuXG4gICAgICAvLyBTdG9yZSBhbnkgc2VwZXJhdGUgT2JqZWN0IFJlZnMgaW4gdGhlaXIgb3duIHRhYmxlOyBuZXN0ZWQuXG4gICAgICBsZXQgcmVmQ29sdW1ucyA9IHRhYmxlLmNvbHVtbnMuZmlsdGVyKGNvbCA9PiBjb2wucmVmZXJlbmNlICE9IG51bGwpXG5cbiAgICAgIGxldCBzYXZlZE9iaiA9IHt9XG5cbiAgICAgIGZvciAobGV0IHJlZkNvbHVtbiBvZiByZWZDb2x1bW5zKSB7XG4gICAgICAgICBpZiAodGhpcy5vYmpbcmVmQ29sdW1uLmNvbHVtbk5hbWVdID09IG51bGwpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgICB9XG5cbiAgICAgICAgIGlmIChyZWZDb2x1bW4ucmVmZXJlbmNlID09IG51bGwpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBTdGFja3NQb3N0Z3Jlc0Vycm9yKGBGYWlsZWQgdG8gU2F2ZSB0aGUgT2JqZWN0LiBObyByZWZlcmVuY2UgaGFzIGJlZW4gcmVjb3JkZWQgZm9yIGEgTW9kZWwgUHJvcGVydHkuIE9uIE1vZGVsICR7dGhpcy5tb2RlbC5uYW1lfSwgTWVtYmVyICR7cmVmQ29sdW1uLm1lbWJlci5uYW1lfWApXG4gICAgICAgICB9XG5cbiAgICAgICAgIGxldCByZWZUYWJsZUluZm8gPSB0aGlzLmNvbnRleHQuZ2V0VGFibGUocmVmQ29sdW1uLnJlZmVyZW5jZS5tb2RlbClcblxuICAgICAgICAgaWYocmVmVGFibGVJbmZvID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBTdGFja3NQb3N0Z3Jlc0Vycm9yKGBGYWlsZWQgdG8gZmluZCB0aGUgcmVmZXJlbmNlIGluZm9ybWF0aW9uIGZvciBhIGNvbHVtbiBpbiBNb2RlbCAke3JlZkNvbHVtbi5yZWZlcmVuY2UubW9kZWx9YClcbiAgICAgICAgIH1cblxuICAgICAgICAgbGV0IHN0b3JlZE9iaiA9IFN0b3JlZE9iamVjdC5jcmVhdGUocmVmQ29sdW1uLnJlZmVyZW5jZS5tb2RlbCwgdGhpcy5jb250ZXh0LnRvRGJPYmoocmVmVGFibGVJbmZvLm1vZGVsLm5hbWUsIHRoaXMub2JqW3JlZkNvbHVtbi5jb2x1bW5OYW1lXSksIHRoaXMuY29udGV4dClcbiAgICAgICAgIGF3YWl0IHN0b3JlZE9iai5zYXZlKClcblxuICAgICAgICAgc2F2ZWRPYmpbcmVmQ29sdW1uLmNvbHVtbk5hbWVdID0gdGhpcy5vYmpbcmVmQ29sdW1uLmNvbHVtbk5hbWVdLmlkXG4gICAgICB9XG5cbiAgICAgIGZvciAobGV0IGNvbE5hbWUgb2YgT2JqZWN0LmtleXModGhpcy5vYmopKSB7XG4gICAgICAgICBzYXZlZE9ialtjb2xOYW1lXT0gdGhpcy5vYmpbY29sTmFtZV1cbiAgICAgIH1cblxuICAgICAgbGV0IHJlc3VsdCA9IGF3YWl0IHRoaXMuY29udGV4dC5kYlxuICAgICAgICAgLmluc2VydEludG8odGFibGUudGFibGVOYW1lKVxuICAgICAgICAgLnZhbHVlcyhzYXZlZE9iailcbiAgICAgICAgIC5leGVjdXRlKClcblxuICAgICAgY29uc29sZS5kaXIocmVzdWx0LCB7IGRlcHRoOiBudWxsIH0pXG5cbiAgICAgIHJldHVyblxuICAgfVxuXG4gICBhc3luYyBkZWxldGUoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICBsZXQgaW5mbyA9IHRoaXMuY29udGV4dC5nZXRUYWJsZSh0aGlzLm1vZGVsKVxuXG4gICAgICBpZiAoaW5mbyA9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgIHRocm93IG5ldyBTdGFja3NQb3N0Z3Jlc0Vycm9yKGBDb3VsZCBub3QgbWF0Y2ggTW9kZWwgd2l0aCBhIFRhYmxlIHdoZW4gc2F2aW5nIE9iamVjdCAke3RoaXMub2JqLmlkfWApXG4gICAgICB9XG5cbiAgICAgIHRyeSB7XG4gICAgICAgICBhd2FpdCB0aGlzLmNvbnRleHQuZGJcbiAgICAgICAgICAgIC5kZWxldGVGcm9tKGluZm8udGFibGVOYW1lKVxuICAgICAgICAgICAgLndoZXJlKCdpZCcsICc9JywgdGhpcy5vYmouaWQpXG4gICAgICAgICAgICAuZXhlY3V0ZSgpXG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtzdGFja3MtcG9zdGdyZXNdIEZhaWxlZCB0byBkZWxldGUgYW4gT2JqZWN0IGZyb20gUG9zdGdyZXMuIE1vZGVsICR7dGhpcy5tb2RlbC5uYW1lfSwgT2JqZWN0IElEICR7dGhpcy5vYmouaWR9LiBSZWFzb246ICR7ZXJyfWApXG4gICAgICAgICB0aHJvdyBlcnJcbiAgICAgIH1cbiAgIH1cbn1cbiJdfQ==